{% extends 'base.html' %}
{% load i18n static crispy_forms_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block list_title %} {# Используем стандартный блок base.html #}
  <h1 class="text-2xl font-semibold text-gray-900 sm:text-3xl">
    {{ page_title }}
  </h1>
{% endblock %}

{% block list_content %} {# Используем стандартный блок base.html #}
<div class="bg-white shadow-xl rounded-xl border border-gray-200 p-6 md:p-8 mt-6 max-w-3xl mx-auto"> {# Увеличил max-w для более широких форм #}
    <div class="border-b border-gray-200 px-0 py-4 mb-6">
        <h3 class="font-medium text-lg text-gray-900">
            {% if object %}
                {% trans "Редактирование пользователя" %}: {{ object.display_name }}
            {% else %}
                {% trans "Создание нового пользователя" %}
            {% endif %}
        </h3>
    </div>
    <div class="p-0">
        <form method="post" enctype="multipart/form-data" action="">
            {% csrf_token %}
            {% crispy form %}
            {% if form.non_field_errors %}
                <div role="alert" class="mt-4 p-4 border border-red-400 bg-red-100 text-red-700 rounded-md">
                    <h4 class="font-bold mb-1">{% trans "Ошибка формы:" %}</h4>
                    {% for error in form.non_field_errors %}<p class="text-sm">{{ error }}</p>{% endfor %}
                </div>
            {% endif %}
            <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200">
                <a href="{% if object %}{{ object.get_absolute_url }}{% else %}{% url 'user_profiles:user_list' %}{% endif %}" class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition active:scale-95 shadow-sm">
                    {% trans 'Отмена' %}
                </a>
                <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition active:scale-95 shadow-sm inline-flex items-center">
                    <i class="fas fa-save mr-2"></i> {{ form_action_text|default:_("Сохранить") }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {# jQuery должен быть загружен ПЕРЕД Select2 и form.media.js #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    {# Проверяем, есть ли поля, требующие Select2, ПЕРЕД загрузкой CSS/JS для Select2 #}
    {% if form.fields.department or form.fields.job_title or form.fields.groups %}
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        {% get_current_language as LANGUAGE_CODE %}
        {% if LANGUAGE_CODE %}
            <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'en' }}.js"></script>
        {% endif %}
    {% endif %}
    {{ form.media.js }} {# Для виджетов django-select2 и других виджетов формы #}
    <script>
        $(document).ready(function() {
            // Инициализация Select2 только если библиотека загружена и есть соответствующие поля
            if (typeof $.fn.select2 === 'function' && ($('#id_department').length || $('#id_job_title').length || $('#id_groups').length)) {
                 const defaultSelect2Options = {
                    theme: "default",
                    width: '100%',
                    allowClear: true, // Установите в false, если поле обязательное
                    language: "{{ LANGUAGE_CODE|slice:':2'|default:'en' }}"
                };
                try {
                    // Инициализация для полей, которым django-select2 или Crispy Forms уже добавили классы
                    // Или вы можете явно указать ID полей, которые должны использовать Select2
                    $('.select2-widget, .django-select2, .select2-basic, #id_department, #id_job_title, #id_groups').each(function() {
                        if (!$(this).data('select2')) { // Инициализировать только если еще не инициализирован
                            const isMultiple = $(this).is('[multiple]');
                            const placeholderText = $(this).data('placeholder') || (isMultiple ? '{% trans "Выберите одно или несколько..." %}' : '{% trans "Выберите..." %}');
                            $(this).select2({
                                ...defaultSelect2Options,
                                placeholder: placeholderText,
                                allowClear: !$(this).prop('required') && !isMultiple, // Allow clear for non-required single selects
                                closeOnSelect: !isMultiple
                            });
                        }
                    });
                } catch (e) { console.error("Error initializing Select2 for user form:", e); }
            } else {
                if (!$('#id_department').length && !$('#id_job_title').length && !$('#id_groups').length) {
                    // console.log("No Select2 fields found on this form.");
                } else {
                    console.warn("Select2 library not loaded, but Select2 fields might be present.");
                }
            }
        });
    </script>
{% endblock %}