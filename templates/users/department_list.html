{% comment %} templates/users/department_list.html {% endcomment %}
{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{{ page_title|default:_("Отделы") }}{% endblock %}

{% block page_title_block %}
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <h2 class="text-title-md2 font-bold text-black dark:text-white">
      {{ page_title|default:_("Отделы") }}
    </h2>
    {% if perms.user_profiles.add_department %}
    <nav>
      <a href="{% url 'user_profiles:department_create' %}" class="inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-center font-medium text-white hover:bg-opacity-90 lg:px-6 transition active:scale-95 shadow-sm">
        <i class="fas fa-building mr-2"></i> {% trans 'Создать отдел' %}
      </a>
    </nav>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
<div class="rounded-sm border border-stroke bg-white px-5 pt-6 pb-2.5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 xl:pb-1">
  <div class="max-w-full overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 dark:scrollbar-thumb-boxdark-2">
    <table class="w-full table-auto">
      <thead>
        <tr class="bg-gray-2 text-left dark:bg-meta-4">
          <th class="min-w-[200px] py-4 px-4 font-medium text-black dark:text-white xl:pl-11">{% trans 'Название отдела' %}</th>
          <th class="min-w-[180px] py-4 px-4 font-medium text-black dark:text-white">{% trans 'Руководитель' %}</th>
          <th class="min_w-[180px] py-4 px-4 font-medium text-black dark:text-white">{% trans 'Вышестоящий' %}</th>
          <th class="min-w-[100px] py-4 px-4 font-medium text-black dark:text-white text-center">{% trans 'Сотрудников' %}</th>
          <th class="min-w-[100px] py-4 px-4 font-medium text-black dark:text-white text-center">{% trans 'Команд' %}</th>
          <th class="py-4 px-4 font-medium text-black dark:text-white text-center">{% trans 'Действия' %}</th>
        </tr>
      </thead>
      <tbody>
        {% for dept_item in object_list %} {# Renamed dept to dept_item #}
        <tr id="dept-row-{{ dept_item.pk }}">
          <td class="border-b border-[#eee] py-5 px-4 pl-9 dark:border-strokedark xl:pl-11">
            <a href="{{ dept_item.get_absolute_url }}" class="font-medium text-primary hover:underline dark:text-blue-400">
                {{ dept_item.name }}
            </a>
            {% if dept_item.description %}
                <p class="text-xs text-meta mt-0.5 truncate" title="{{ dept_item.description }}">{{ dept_item.description|truncatechars:50 }}</p>
            {% endif %}
          </td>
          <td class="border-b border-[#eee] py-5 px-4 dark:border-strokedark">
            <p class="text-black dark:text-white">{{ dept_item.head.display_name|default:"-" }}</p>
          </td>
          <td class="border-b border-[#eee] py-5 px-4 dark:border-strokedark">
            <p class="text-black dark:text-white">{{ dept_item.parent.name|default:"-" }}</p>
          </td>
          <td class="border-b border-[#eee] py-5 px-4 dark:border-strokedark text-center">
            <p class="text-black dark:text-white">{{ dept_item.num_employees|default:0 }}</p> {# num_employees annotated in view #}
          </td>
           <td class="border-b border-[#eee] py-5 px-4 dark:border-strokedark text-center">
            <p class="text-black dark:text-white">{{ dept_item.num_teams|default:0 }}</p> {# num_teams annotated in view #}
          </td>
          <td class="border-b border-[#eee] py-5 px-4 dark:border-strokedark">
            <div class="flex items-center justify-center space-x-3.5">
              <a href="{{ dept_item.get_absolute_url }}" class="hover:text-primary" title="{% trans 'Подробнее' %}"><i class="fas fa-eye"></i></a>
              {% if perms.user_profiles.change_department %}
              <a href="{% url 'user_profiles:department_update' pk=dept_item.pk %}" class="hover:text-primary" title="{% trans 'Редактировать' %}"><i class="fas fa-edit"></i></a>
              {% endif %}
              {% if perms.user_profiles.delete_department %}
              <a href="{% url 'user_profiles:department_delete' pk=dept_item.pk %}" class="hover:text-danger" title="{% trans 'Удалить' %}"><i class="fas fa-trash"></i></a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
            <tr><td colspan="6" class="py-10 px-4 text-center text-meta">{% trans 'Отделы не найдены.' %}</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if is_paginated %}
    <div class="py-4 px-4">
        {% include "includes/pagination.html" with page_obj=page_obj %}
    </div>
  {% endif %}
</div>
{% endblock %}