{% extends 'base.html' %}
{% load i18n static crispy_forms_tags %}
{% block title %}{{ page_title }}{% endblock %}
{% block list_title %}
<div class="flex items-center justify-between">
    <h1 class="text-3xl font-semibold text-gray-900 dark:text-gray-100 sm:text-4xl">
        {{ page_title }}
    </h1>
    <a href="{% url 'user_profiles:password_change' %}" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-ios-blue dark:hover:bg-blue-500 dark:focus:ring-offset-dark-800 transition active:scale-95 shadow-sm inline-flex items-center">
        <i class="fas fa-key mr-2"></i> {% trans "Сменить пароль" %}
    </a>
</div>
{% endblock %}
{% block list_content %}
<div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-2">
        <div class="bg-white dark:bg-dark-800 shadow-lg rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="flex items-center mb-6 pb-6 border-b border-gray-200 dark:border-dark-600">
                    <img class="w-20 h-20 rounded-full object-cover shadow-md border border-gray-300 dark:border-dark-600" src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ user.display_name }}">
                    <div class="ml-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">{{ user.display_name }}</h2>
                        <p class="text-sm text-gray-500 dark:text-gray-400">@{{ user.username }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ user.email }}</p>
                    </div>
                </div>
                {% crispy form %}
                {% if form.non_field_errors %}
                    <div class="mt-4 p-4 border border-red-300 bg-red-50 text-red-700 dark:bg-red-900/30 dark:border-red-700/50 dark:text-red-300 rounded-md">
                        <h4 class="font-bold">{% trans "Ошибка формы:" %}</h4>
                        {% for error in form.non_field_errors %}<p class="text-sm">{{ error }}</p>{% endfor %}
                    </div>
                {% endif %}
                <div class="flex justify-end mt-6 pt-6 border-t border-gray-200 dark:border-dark-600">
                    <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-ios-blue dark:hover:bg-blue-500 dark:focus:ring-offset-dark-800 transition active:scale-95 shadow-sm">
                        <i class="fas fa-save mr-2"></i> {% trans "Сохранить изменения" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div class="lg:col-span-1">
        <div class="bg-white dark:bg-dark-800 shadow-lg rounded-xl border border-gray-200 dark:border-dark-700 p-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
                <i class="fas fa-history mr-2 text-gray-500"></i>{% trans 'История задач' %}
            </h3>
            {% if task_history_page.object_list %}
                <ul class="space-y-3 max-h-96 overflow-y-auto pr-2 scrollbar-thin">
                    {% for task in task_history_page.object_list %}
                        <li class="p-3 rounded-md border border-gray-200 dark:border-dark-600 hover:bg-gray-50 dark:hover:bg-dark-700 transition">
                            <a href="{{ task.get_absolute_url }}" class="block">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="font-medium text-sm text-blue-600 dark:text-blue-400">#{{ task.task_number }}</span>
                                     <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full
                                        {% if task.status == 'new' %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% elif task.status == 'in_progress' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/80 dark:text-yellow-200{% elif task.status == 'on_hold' %}bg-blue-100 text-blue-800 dark:bg-blue-900/80 dark:text-blue-200{% elif task.status == 'canceled' %}bg-gray-100 text-gray-500 dark:bg-dark-700 dark:text-gray-400 line-through{% elif task.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900/80 dark:text-green-200{% elif task.status == 'overdue' %}bg-red-100 text-red-800 dark:bg-red-900/80 dark:text-red-200{% else %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% endif %}">
                                        {{ task.get_status_display }}
                                      </span>
                                </div>
                                <p class="text-sm font-medium text-gray-800 dark:text-gray-100 truncate">{{ task.title }}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                    {% trans "Проект:" %} {{ task.project.name }} | {% trans "Обновлено:" %} {{ task.updated_at|timesince }} {% trans "назад" %}
                                </p>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                {% if task_history_page.paginator.num_pages > 1 %}
                    <div class="mt-4 text-center">
                        {% include "includes/pagination_simple.html" with page_obj=task_history_page param_name='task_page' %}
                    </div>
                {% endif %}
            {% else %}
                <p class="text-gray-500 dark:text-gray-400 italic text-sm">{% trans "Нет задач для отображения в истории." %}</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
    {{ block.super }}
    {# Add crispy forms media if needed for profile form fields #}
    {{ form.media.js }}
{% endblock %}