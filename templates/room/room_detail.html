{% extends "base.html" %}
{% load static i18n %}
{% load app_filters %}

{% block title %}{{ page_title }} | {% trans "Чат" %}{% endblock %}

{% block head_extra %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/chat_room.css' %}">
<style>
    #chat-messages-container::-webkit-scrollbar {
        width: 8px;
    }
    #chat-messages-container::-webkit-scrollbar-track {
        background: transparent;
    }
    #chat-messages-container::-webkit-scrollbar-thumb {
        background-color: #D1D5DB; /* theme('colors.gray.300') */
        border-radius: 4px;
    }
    #chat-messages-container {
        scrollbar-width: thin;
        scrollbar-color: #D1D5DB transparent; /* theme('colors.gray.300') */
    }
    .hide-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .hide-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
</style>
{% endblock %}

{% block page_header %}{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-theme(space.16)-theme(space.10)-2px)] -mt-6 -mx-4 border-t border-gray-200">
    <!-- Боковая панель с комнатами (для десктопа) -->
    <aside class="w-64 bg-white border-r border-gray-200 flex-col hidden md:flex shrink-0">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h2 class="text-lg font-semibold text-gray-800">{% trans "Комнаты" %}</h2>
            <a href="{% url 'room:create_room' %}" title="{% trans 'Создать новую комнату' %}"
                class="text-indigo-600 hover:text-indigo-500 p-1.5 rounded-full hover:bg-gray-100 transition">
                <i class="fas fa-plus"></i>
            </a>
        </div>
        <nav id="sidebar-room-list" class="flex-1 overflow-y-auto p-2 space-y-1">
            {% include "room/partials/room_list_item_sidebar.html" with room_item=room current_room_slug=room.slug %}
            {% for r_item in rooms_for_sidebar %}
            {% include "room/partials/room_list_item_sidebar.html" with room_item=r_item current_room_slug=room.slug %}
            {% empty %}
            <p class="text-xs text-gray-500 p-3 text-center italic">{% trans "Нет других комнат." %}</p>
            {% endfor %}
        </nav>
    </aside>

    <!-- Основная часть чата -->
    <main class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
        <!-- Заголовок комнаты -->
        <header class="p-3 md:p-4 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="open-sidebar-btn"
                        class="md:hidden mr-3 p-1.5 text-gray-500 hover:bg-gray-100 rounded-full">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="text-xl font-semibold text-gray-800 truncate pr-4" title="{{ room.name }}">
                        # {{ room.name }}
                    </h1>
                </div>
                <div class="relative" x-data="{ open: false }">
                    <button @click="open = !open"
                        class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full focus:outline-none"
                        title="{% trans 'Действия с комнатой' %}">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div x-show="open" @click.outside="open = false"
                        x-transition:enter="transition ease-out duration-100"
                        x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                        x-transition:leave="transition ease-in duration-75"
                        x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                        class="absolute right-0 mt-1 w-56 bg-white shadow-xl rounded-md border border-gray-200 z-30 overflow-hidden"
                        x-cloak>
                        <ul class="py-1 text-sm text-gray-700">
                            <li>
                                <button type="button" id="archive-room-btn" data-room-slug="{{ room.slug }}"
                                    data-room-name="{{ room.name|escapejs }}"
                                    class="w-full text-left flex items-center px-4 py-2.5 hover:bg-gray-100 text-red-600">
                                    <i class="fas fa-archive w-4 mr-2.5"></i> {% trans "Архивировать комнату" %}
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="online-users-panel" class="text-xs text-gray-500 mt-1.5 flex items-center">
                <span class="relative flex h-2.5 w-2.5 mr-1.5">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                </span>
                <span id="online-count" class="font-medium">0</span> {% trans "в сети" %}:
                <span id="online-list" class="ml-1.5 truncate italic">{% trans "Загрузка..." %}</span>
            </div>
            <div id="typing-indicator-panel" class="text-xs text-gray-500 mt-1 h-4">
            </div>
        </header>

        <!-- Область сообщений -->
        <div id="chat-messages-container" class="flex-1 overflow-y-auto p-3 md:p-4 space-y-4">
            <div id="older-messages-loader" class="text-center py-4 hidden">
                <button id="load-older-messages-btn" class="text-sm text-indigo-600 hover:underline">
                    <i class="fas fa-spinner fa-spin mr-1"></i> {% trans "Загрузить предыдущие сообщения..." %}
                </button>
            </div>
            <div id="chat-messages-list">
                {% for message_obj in messages_list %}
                {% include "room/partials/message_item.html" with msg=message_obj current_user_id=request.user.pk %}
                {% empty %}
                <p id="no-messages-placeholder" class="text-center text-gray-500 italic py-10">
                    {% trans "Сообщений пока нет. Начните диалог!" %}
                </p>
                {% endfor %}
            </div>
            <div id="message-anchor"></div>
        </div>

        <!-- Подвал с полем ввода -->
        <footer class="p-3 md:p-4 border-t border-gray-200 bg-white flex-shrink-0">
            <div id="reply-preview-area" class="mb-2 text-xs p-2 bg-gray-100 rounded hidden border-l-4 border-indigo-500">
                <div class="flex justify-between items-center">
                    <div class="truncate">
                        <span class="text-gray-600">{% trans "Ответ на:" %}</span>
                        <strong id="reply-preview-user" class="text-gray-800"></strong>:
                        <em id="reply-preview-text" class="italic text-gray-700"></em>
                    </div>
                    <button type="button" id="cancel-reply-btn"
                        class="ml-2 text-gray-500 hover:text-red-600 text-lg font-semibold leading-none p-1">×</button>
                </div>
                <input type="hidden" id="reply-message-id-hidden" value="">
            </div>

            <div id="file-preview-area" class="mb-2 text-xs p-2 bg-gray-100 rounded hidden items-center justify-between border-l-4 border-gray-400">
                <div class="flex items-center truncate">
                    <i class="fas fa-paperclip mr-2 text-gray-600"></i>
                    <span id="file-preview-name" class="font-medium text-gray-800"></span>
                    <span id="file-preview-size" class="ml-2 text-gray-500"></span>
                </div>
                <button type="button" id="remove-file-btn"
                    class="ml-2 text-red-500 hover:text-red-700 font-semibold p-1 leading-none">×</button>
            </div>

            <form id="chat-message-form" class="flex items-end space-x-2">
                <label for="chat-file-input-trigger"
                    class="flex-shrink-0 p-2.5 rounded-full hover:bg-gray-100 cursor-pointer text-gray-500 focus-within:ring-2 focus-within:ring-indigo-500"
                    title="{% trans 'Прикрепить файл' %}">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" id="chat-file-input" class="hidden">
                </label>
                <div class="flex-1 relative">
                    <textarea id="chat-message-input" placeholder="{% trans 'Введите сообщение...' %}" rows="1"
                        class="form-textarea block w-full px-4 py-2 pr-12 border border-gray-300 rounded-2xl shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm resize-none overflow-y-auto hide-scrollbar"
                        style="max-height: 120px;" autocomplete="off"></textarea>
                </div>
                <button type="submit" id="chat-message-submit-btn"
                    class="flex-shrink-0 inline-flex items-center justify-center w-10 h-10 border border-transparent rounded-full shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                    title="{% trans 'Отправить' %}" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </footer>
    </main>
</div>

<!-- Мобильная боковая панель (скрыта по умолчанию) -->
<div id="mobile-sidebar" class="fixed inset-0 flex z-40 md:hidden hidden">
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-25"></div>
    <aside class="relative flex-1 flex flex-col max-w-xs w-full bg-white border-r border-gray-200">
        <div class="absolute top-0 right-0 -mr-12 pt-2">
            <button id="close-sidebar-btn" type="button"
                class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                <span class="sr-only">{% trans "Закрыть сайдбар" %}</span>
                <i class="fas fa-times text-white"></i>
            </button>
        </div>
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h2 class="text-lg font-semibold">{% trans "Комнаты" %}</h2>
            <a href="{% url 'room:create_room' %}" title="{% trans 'Создать новую комнату' %}"
                class="text-indigo-600 hover:text-indigo-500 p-1.5 rounded-full hover:bg-gray-100 transition"><i class="fas fa-plus"></i></a>
        </div>
        <nav class="flex-1 overflow-y-auto p-2 space-y-1">
            {% include "room/partials/room_list_item_sidebar.html" with room_item=room current_room_slug=room.slug %}
            {% for r_item in rooms_for_sidebar %}
            {% include "room/partials/room_list_item_sidebar.html" with room_item=r_item current_room_slug=room.slug %}
            {% endfor %}
        </nav>
    </aside>
    <div class="flex-shrink-0 w-14"></div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    window.chatConfig = {
        roomSlug: "{{ room.slug|escapejs }}",
        currentUserId: {{ request.user.pk }},
        currentUsername: "{{ request.user.username|escapejs }}",
        initialMessagesCount: {{ messages_list|length }},
        messagesPageSize: {{ chat_messages_page_size|default:50 }},
        i18n: {
            loadOlderButton: "{% trans 'Загрузить еще...' %}",
            loadingOlder: "{% trans 'Загрузка...' %}",
            noMoreMessages: "{% trans 'Больше нет сообщений.' %}",
            messageDeleted: "{% trans 'Сообщение удалено' %}",
            fileNotAvailable: "{% trans 'Файл недоступен' %}",
            confirmArchiveRoom: "{% trans 'Вы уверены, что хотите заархивировать комнату \"%s\"?' %}",
            replyTo: "{% trans 'Ответ на:' %}",
            file: "{% trans '[Файл]' %}",
            edit: "{% trans 'Редактировать' %}",
            delete: "{% trans 'Удалить' %}",
            edited: "{% trans 'ред.' %}",
            reply: "{% trans 'Ответить' %}",
            react: "{% trans 'Реагировать' %}",
            editMessagePrompt: "{% trans 'Введите новый текст сообщения:' %}",
            confirmDeleteMessage: "{% trans 'Вы уверены, что хотите удалить это сообщение?' %}",
            reactPrompt: "{% trans 'Введите эмодзи для реакции:' %}",
            serverError: "{% trans 'Ошибка сервера' %}",
            isTyping: "{% trans 'печатает...' %}",
            areTyping: "{% trans 'печатают...' %}",
            andOthersAreTyping: "{% trans 'и другие печатают...' %}",
            noOneOnline: "{% trans 'Никого нет в сети' %}",
            andMore: "{% trans 'и еще' %}",
        }
    };

    function getWebSocketPath(type, slug = null) {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        if (type === 'chat' && slug) { return `${protocol}//${host}/ws/chat/${slug}/`; }
        console.warn(`Unknown WebSocket path type: ${type}`);
        return `${protocol}//${host}/ws/`;
    }
    window.djangoWsPath = getWebSocketPath;
</script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="{% static 'js/chat_room.js' %}" defer></script>
<script src="{% static 'js/room_actions.js' %}" defer></script>
{% endblock %}