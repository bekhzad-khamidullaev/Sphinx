{% extends 'base.html' %}
{% load static i18n %}
{% load app_filters %}
{% block title %}{{ room.name }} | {% trans "Чат" %}{% endblock %}
{% block head_extra %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/chat.css' %}">
    <style>
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: transparent; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: theme('colors.gray.300'); border-radius: 3px; }
        html.dark #chat-messages::-webkit-scrollbar-thumb { background-color: theme('colors.dark.600'); }
        #chat-messages { scrollbar-width: thin; scrollbar-color: theme('colors.gray.300') transparent; }
        html.dark #chat-messages { scrollbar-color: theme('colors.dark.600') transparent; }
    </style>
{% endblock %}
{% block list_title %}{% endblock %}
{% block list_title_mobile %}{% endblock %}
{% block list_actions %}{% endblock %}
{% block list_actions_mobile %}{% endblock %}
{% block list_content %}
    <div class="flex h-[calc(100vh-theme(space.16)-theme(space.10))] -mt-6 -mx-4">
        <aside class="w-64 bg-white dark:bg-dark-800 border-r border-gray-200 dark:border-dark-700 flex-col hidden md:flex">
             <div class="p-4 border-b border-gray-200 dark:border-dark-700 flex justify-between items-center flex-shrink-0">
                 <h2 class="text-lg font-semibold">{% trans "Комнаты" %}</h2>
                 <a href="{% url 'room:create_room' %}" title="{% trans 'Создать новую комнату' %}" class="text-blue-600 dark:text-blue-400 hover:underline p-1 rounded hover:bg-gray-100 dark:hover:bg-dark-700">
                     <i class="fas fa-plus"></i>
                 </a>
             </div>
             <nav id="sidebar-room-list" class="flex-1 overflow-y-auto p-2 space-y-1 scrollbar-thin">
                 {% for r in rooms_for_sidebar %}
                     {% include "includes/room_list_item.html" with room=r current_room=room %}
                 {% empty %}
                     <p class="text-xs text-gray-500 p-3 text-center italic">{% trans "Нет других комнат." %}</p>
                 {% endfor %}
             </nav>
        </aside>
        <main class="flex-1 flex flex-col bg-gray-50 dark:bg-dark-900">
            <header class="p-4 border-b border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-800 shadow-sm flex-shrink-0">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-semibold truncate pr-4"># {{ room.name }}</h1>
                     <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="p-1.5 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-700 rounded-full focus:outline-none" title="{% trans 'Действия с комнатой' %}">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                        <div x-show="open" @click.outside="open = false"
                             x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100"
                             x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
                             class="absolute right-0 mt-1 w-48 bg-white dark:bg-dark-800 shadow-lg rounded-md border border-gray-200 dark:border-dark-600 z-20 overflow-hidden" x-cloak>
                            <ul class="py-1 text-sm text-gray-700 dark:text-gray-300">
                                 <li>
                                     <button type="button"
                                             data-action="archive-room"
                                             data-url="{% url 'room:archive_room' room.slug %}"
                                             data-room-name="{{ room.name|escapejs }}"
                                             class="w-full text-left flex items-center px-4 py-2 hover:bg-gray-100 dark:hover:bg-dark-700 text-red-600 dark:text-red-400">
                                         <i class="fas fa-archive w-4 mr-2"></i> {% trans "Архивировать" %}
                                     </button>
                                 </li>
                             </ul>
                        </div>
                    </div>
                </div>
                 <div id="online-users" class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center">
                    <span class="relative flex h-2 w-2 mr-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span id="online-count">0</span> {% trans "в сети" %}:
                    <span id="online-list" class="ml-1 truncate">{% trans "Загрузка..." %}</span>
                </div>
            </header>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin">
                 <div id="older-messages-loading" class="text-center py-4 hidden">
                     <i class="fas fa-spinner fa-spin text-gray-400"></i>
                 </div>
                 {% for message in messages %}
                     {% include "room/partials/messages_list.html" with message=message %}
                 {% empty %}
                     <p id="no-messages" class="text-center text-gray-500 dark:text-gray-400 italic py-10">{% trans "Сообщений пока нет. Начните диалог!" %}</p>
                 {% endfor %}
                 <div id="message-anchor"></div>
            </div>
            <footer class="p-3 md:p-4 border-t border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-800 flex-shrink-0">
                 <div id="reply-preview-area" class="mb-2 text-xs p-2 bg-gray-100 dark:bg-dark-700 rounded hidden border-l-4 border-blue-500">
                     <div class="flex justify-between items-center">
                        <span>{% trans "Ответ на:" %} <strong id="reply-preview-user"></strong>: <em id="reply-preview-text" class="truncate inline-block max-w-xs italic"></em></span>
                        <button type="button" id="cancel-reply-btn" class="text-gray-500 hover:text-red-600 text-lg font-semibold leading-none p-1">×</button>
                     </div>
                     <input type="hidden" id="reply-message-id" value="">
                 </div>
                 <div id="file-preview" class="mb-2 text-xs p-2 bg-gray-100 dark:bg-dark-700 rounded hidden flex items-center justify-between border-l-4 border-gray-400">
                     <span><i class="fas fa-paperclip mr-1"></i> <span id="file-preview-name" class="font-medium"></span></span>
                     <button type="button" id="remove-file-btn" class="text-red-500 hover:text-red-700 ml-2 font-semibold p-1 leading-none">×</button>
                 </div>
                <form id="chat-message-form" class="flex items-center space-x-2">
                    <label for="chat-file-input" class="flex-shrink-0 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-700 cursor-pointer text-gray-500 dark:text-gray-400" title="{% trans 'Прикрепить файл' %}">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" id="chat-file-input" class="hidden">
                    </label>
                    <input type="text" id="chat-message-input" placeholder="{% trans 'Введите сообщение...' %}" autocomplete="off"
                           class="flex-1 form-input block w-full px-4 py-2 border border-gray-300 rounded-full shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-dark-700 dark:border-dark-600 dark:text-gray-200 dark:placeholder-gray-500">
                    <button type="submit" id="chat-message-submit"
                            class="flex-shrink-0 inline-flex items-center justify-center w-10 h-10 border border-transparent rounded-full shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:bg-ios-blue dark:hover:bg-blue-500" title="{% trans 'Отправить' %}">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </footer>
        </main>
    </div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script>
    window.roomSlug = "{{ room.slug|escapejs }}";
    window.currentUserId = {{ request.user.pk|default:'null' }};
    window.currentUsername = "{{ request.user.username|escapejs }}";
    function getWebsocketPath(type, slug = null) {
        if (type === 'chat' && slug) { return `/ws/chat/${slug}/`; }
        if (type === 'search') { return `/ws/user_search/`; }
        console.warn(`Unknown WS path type: ${type}`); return '/ws/';
    }
    window.djangoWsPath = getWebsocketPath;
</script>
<script src="{% static 'js/chat.js' %}" defer></script>
<script src="{% static 'js/room_actions.js' %}" defer></script>
{% endblock %}