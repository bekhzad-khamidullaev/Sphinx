{% extends 'base.html' %}

{% block title %}{{ room.name }} | {% endblock %}

{% block content %}
<div class="pt-16 flex h-screen bg-gray-100">

    <!-- Sidebar with Chat List -->
    <div class="w-1/4 bg-white p-4 border-r hidden md:block">
        <ul id="chat-list" class="space-y-4">
            {% for room in rooms %}
            <li id="chat-{{ room.name }}" class="rounded-lg border-1 border-gray-200 shadow-lg hover:shadow-md transition-shadow">
                <a href="{% url 'room:room' room.slug %}" class="block p-3 text-lg font-semibold rounded-md hover:bg-gray-100">
                    {{ room.name|default:room.slug }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>


    <!-- Chat Window -->
    <div class="flex-1 flex flex-col bg-white">
        <div class="flex-none bg-white p-4 border-b">
            <h2 class="text-xl font-medium">{{ room.name }}</h2>
        </div>

        <!-- Messages List -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            {% for message in messages %}
            <div id="message-{{ message.id }}" class="flex {% if message.user.username == request.user.username %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-[80%] p-3 rounded-lg 
                            {% if message.user.username == request.user.username %}bg-blue-500 text-white{% else %}bg-white shadow-md{% endif %}">
                    <div class="text-sm break-words">{{ message.content }}</div>
                    <div class="flex items-center justify-end mt-2">
                        <span class="text-xs {% if message.user.username == request.user.username %}text-blue-200{% else %}text-gray-500{% endif %}">
                            {{ message.date_added|date:"H:i" }}
                        </span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-gray-500 text-center py-4 text-sm">No messages yet.</div>
            {% endfor %}
        </div>

        <!-- Message Input -->
        <div class="p-4 bg-white border-t">
            <form method="post" action="." class="flex gap-3" id="message-form">
                {% csrf_token %}
                <input type="text" name="content" aria-label="Message input" class="w-full p-3 rounded-full text-sm border focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder:text-gray-400" placeholder="Type your message..." id="chat-message-input">
                <button type="submit" id="chat-message-submit" class="p-3 rounded-full bg-blue-500 hover:bg-blue-600 text-white">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                    </svg>
                </button>
            </form>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ room.slug|json_script:"json-roomname" }}
{{ request.user.username|json_script:"json-username" }}

<script>
    const roomName = JSON.parse(document.getElementById('json-roomname').textContent);
    const userName = JSON.parse(document.getElementById('json-username').textContent);
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/' + roomName + '/'
    );

    chatSocket.onclose = function(e) {
        console.log('WebSocket closed:', e);
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.message) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', data.username === userName ? 'justify-end' : 'justify-start');
            messageDiv.innerHTML = `
                <div class="max-w-[80%] p-3 rounded-lg ${data.username === userName ? 'bg-blue-500 text-white' : 'bg-white shadow-md'}">
                    <div class="text-sm break-words">${data.message}</div>
                    <div class="flex items-center justify-end mt-2">
                        <span class="text-xs ${data.username === userName ? 'text-blue-200' : 'text-gray-500'}">${new Date().toLocaleTimeString().slice(0, 5)}</span>
                    </div>
                </div>
            `;
            document.querySelector('#chat-messages').appendChild(messageDiv);
        } else {
            alert('The message was empty!');
        }

        scrollToBottom();
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeydown = function(e) {
        if (e.keyCode === 13) {
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        e.preventDefault();

        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        if (!message.trim()) return;

        chatSocket.send(JSON.stringify({
            'message': message,
            'username': userName,
            'room': roomName
        }));

        messageInputDom.value = '';
        return false;
    };

    function scrollToBottom() {
        let objDiv = document.getElementById("chat-messages");
        objDiv.scrollTop = objDiv.scrollHeight;
    }

    scrollToBottom();
</script>
{% endblock %}
