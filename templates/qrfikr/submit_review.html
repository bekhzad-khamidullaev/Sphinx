{% extends "qrfikr/base.html" %}
{% load i18n %}
{% load static %}
{% load form_attrs %}
{% block title %}{{ page_title|default:_("Submit Your Valuable Feedback") }}{% endblock %}

{% block head_extra %}
<style>
    /* Стили для скрытого input[type=file] и его кастомного label */
    .custom-file-input-container input[type="file"] {
        opacity: 0;
        position: absolute;
        width: 0.1px;
        height: 0.1px;
        overflow: hidden;
        z-index: -1;
    }
    .custom-file-input-container label.file-label-button {
        display: inline-block;
        padding: 0.625rem 1.25rem; /* 10px 20px */
        font-size: 0.875rem; /* 14px */
        font-weight: 600; /*semibold*/
        text-align: center;
        color: white;
        background-color: #4f46e5; /* indigo-600 */
        border: 1px solid transparent;
        border-radius: 0.5rem; /* rounded-lg */
        cursor: pointer;
        transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
    }
    .custom-file-input-container label.file-label-button:hover {
        background-color: #4338ca; /* indigo-700 */
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
    }
    .dark .custom-file-input-container label.file-label-button {
        background-color: #5c6ac4; /* indigo-500 for dark */
        color: #e0e7ff; /* indigo-100 for dark text */
    }
    .dark .custom-file-input-container label.file-label-button:hover {
        background-color: #4f46e5; /* indigo-600 for dark hover */
    }

    /* Стили для кнопок фильтров изображений */
    .filter-button {
        padding: 0.375rem 0.875rem; /* py-1.5 px-3.5 */
        font-size: 0.8125rem; /* ~13px */
        font-weight: 500; /* medium */
        border-radius: 9999px; /* rounded-full */
        border-width: 1px;
        transition: all 0.15s ease-in-out;
        line-height: 1.25; /* Для лучшего вида текста в кнопке */
    }
    .filter-button-inactive {
        border-color: #cbd5e1; /* slate-300 */
        color: #475569; /* slate-600 */
        background-color: white;
    }
    .filter-button-inactive:hover {
        background-color: #f1f5f9; /* slate-100 */
        border-color: #94a3b8; /* slate-400 */
    }
    .dark .filter-button-inactive {
        border-color: #475569; /* slate-600 */
        color: #cbd5e1; /* slate-300 */
        background-color: #1e293b; /* slate-800 */
    }
    .dark .filter-button-inactive:hover {
        background-color: #334155; /* slate-700 */
        border-color: #64748b; /* slate-500 */
    }
    .filter-button-active { /* Когда фильтр выбран */
        border-color: #6366f1; /* indigo-500 */
        background-color: #e0e7ff; /* indigo-100 */
        color: #4338ca; /* indigo-700 */
        font-weight: 600; /* semibold */
    }
    .dark .filter-button-active {
        border-color: #818cf8; /* indigo-400 */
        background-color: #3730a3; /* indigo-700 */
        color: #c7d2fe; /* indigo-200 */
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-100 via-gray-50 to-slate-200 dark:from-slate-900 dark:via-slate-800 dark:to-black text-slate-800 dark:text-slate-100 py-16 sm:py-24 px-4"
     x-data="mainPageController()">

  <div class="max-w-2xl mx-auto">
    
    <header class="mb-12 text-center">
      {% comment %} Убедитесь, что 'logo_image' - правильное имя поля {% endcomment %}
      {% if qr_link.location and qr_link.location.logo_image %}
      <div class="inline-block p-1.5 bg-white dark:bg-slate-700 rounded-3xl shadow-xl mb-8 transform hover:scale-105 transition-transform duration-300">
        <img src="{{ qr_link.location.logo_image.url }}" alt="{{ qr_link.location.name }} {% trans 'Logo' %}" class="h-24 w-24 sm:h-28 sm:w-28 object-contain rounded-2xl">
      </div>
      {% endif %}
      <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 dark:from-indigo-400 dark:via-purple-400 dark:to-pink-400 pb-2 leading-tight">
        {{ page_title }} {# page_title уже передается из view #}
      </h1>
      {% if location_description %}
      <p class="mt-4 text-lg sm:text-xl text-slate-600 dark:text-slate-400 max-w-xl mx-auto">{{ location_description }}</p>
      {% endif %}
    </header>

    {% comment %} Django messages будут отображаться здесь, если были добавлены в view (например, при ошибках, не связанных с полями, или если бы не было редиректа на thank_you) {% endcomment %}
    {% if messages %}
    <div class="mb-10 space-y-4">
        {% for message in messages %}
        <div class="p-4 rounded-xl text-sm shadow-lg border-l-4
                    {% if message.tags == 'success' %} bg-green-50 dark:bg-green-900/50 border-green-500 text-green-700 dark:text-green-200
                    {% elif message.tags == 'error' %} bg-red-50 dark:bg-red-900/50 border-red-500 text-red-700 dark:text-red-200
                    {% elif message.tags == 'warning' %} bg-yellow-50 dark:bg-yellow-900/50 border-yellow-500 text-yellow-700 dark:text-yellow-200
                    {% else %} bg-indigo-50 dark:bg-indigo-900/50 border-indigo-500 text-indigo-700 dark:text-indigo-200
                    {% endif %}" role="alert">
            <div class="flex items-center">
                <div class="mr-3 flex-shrink-0">
                    {% if message.tags == 'success' %} <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                    {% elif message.tags == 'error' %} <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                    {% else %} <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-base">{{ message.tags|capfirst }}</p>
                    <p>{{ message|safe }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if form.non_field_errors %}
        <div class="mb-10 p-4 text-sm text-red-700 dark:text-red-100 bg-red-100 dark:bg-red-800/40 border border-red-300 dark:border-red-600/70 rounded-xl shadow-lg" role="alert">
            <p class="font-bold text-lg mb-2">{% trans "Something went wrong:" %}</p>
            <ul class="list-disc list-inside space-y-1">
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" 
          id="feedbackForm"
          @submit.prevent="submitFeedbackForm($event.target)"
          class="bg-white dark:bg-slate-800/70 backdrop-blur-xl dark:backdrop-blur-2xl border border-slate-200/70 dark:border-slate-700/50 shadow-2xl rounded-2xl p-6 sm:p-10 space-y-10">
        {% csrf_token %}
        {{ form.honeypot }}

        <!-- Rating -->
        <div>
            <label class="block text-xl font-semibold text-slate-800 dark:text-slate-100 mb-4 text-center">
                {{ form.rating.label }}
                {% if form.rating.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
            </label>
            {# Скрытое поле Django для хранения значения рейтинга #}
            {{ form.rating }} {# Это отрендерит <input type="hidden" name="rating" id="id_rating_hidden_input" ... > #}

            <div class="flex justify-center space-x-2 sm:space-x-3">
                {# form.rating.field.choices - это список кортежей [(value, label), ...] #}
                {% for value, display_label in form.rating.field.choices %}
                <div class="relative group">
                    {# Нам не нужен отдельный input type="radio" здесь, так как Alpine будет управлять id_rating_hidden_input #}
                    <label for="star_label_{{ value }}" {# Нужен уникальный for, но он не будет связан с реальным инпутом #}
                           title="{{ display_label }}"
                           @click="formValues.currentRating = '{{ value }}'; document.getElementById('id_rating_hidden_input').value = '{{ value }}';"
                           @mouseenter="formValues.hoverRating = {{ value }}"
                           @mouseleave="formValues.hoverRating = 0"
                           class="block cursor-pointer p-2 rounded-full transition-all duration-200 ease-out transform group-hover:scale-125 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 dark:focus-visible:ring-offset-slate-800"
                           x-bind:class="ratingClass({{ value }})">
                        <svg class="w-8 h-8 sm:w-9 sm:h-9 fill-current" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 20">
                            <path d="M20.924 7.625a1.523 1.523 0 0 0-1.238-1.044l-5.051-.734-2.259-4.577a1.534 1.534 0 0 0-2.752 0L7.365 5.847l-5.051.734A1.535 1.535 0 0 0 1.463 9.2l3.656 3.563-.863 5.031a1.532 1.532 0 0 0 2.226 1.616L11 17.033l4.518 2.375a1.534 1.534 0 0 0 2.226-1.617l-.863-5.03L20.537 9.2a1.523 1.523 0 0 0 .387-1.575Z"/>
                        </svg>
                    </label>
                </div>
                {% endfor %}
            </div>
            {% if form.rating.errors %}
                <p class="mt-2.5 text-sm text-red-600 dark:text-red-400 text-center font-medium">
                {% for error in form.rating.errors %}{{ error }}{% endfor %}
                </p>
            {% endif %}
        </div>

        <!-- Feedback Text -->
        <div>
            <label for="{{ form.text.id_for_label }}" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mb-2">
                {{ form.text.label }}{% if form.text.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
            </label>
            {{ form.text }} {# Django рендерит <textarea> с классами из forms.py #}
            {% if form.text.errors %}
                <p class="mt-1.5 text-sm text-red-600 dark:text-red-400 font-medium">
                {% for error in form.text.errors %}{{ error }}{% endfor %}
                </p>
            {% endif %}
        </div>
        
        <!-- Photo Upload with Filters -->
        <div class="space-y-4" x-data="imagePreviewWithFilters('{{ form.photo.auto_id }}')"> {# Используем auto_id для инпута #}
            <label class="block text-lg font-medium text-slate-700 dark:text-slate-200">
                {{ form.photo.label }}{% if form.photo.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
            </label>
            
            <div class="custom-file-input-container">
                {# Этот label теперь для КНОПКИ, а не для инпута напрямую, инпут сам по себе #}
                <label for="{{ form.photo.auto_id }}" class="file-label-button" x-text="photoPreview.imageUrl ? '{% trans "Change Photo" %}' : '{% trans "Choose Photo" %}'"></label>
                {# Django рендерит <input type="file" name="photo" id="id_photo" class="custom-file-input"> #}
                {# Мы добавим @change к этому инпуту через Alpine, если он не часть {{ form.photo }} рендеринга #}
                {# Но лучше, чтобы {{ form.photo }} уже содержал нужный ID и Alpine мог его найти #}
                {{ form.photo|attr:"@change:updatePreviewAndForm($event)"|attr:"x-ref:photoInputForAlpine" }}
            </div>

            <template x-if="photoPreview.imageUrl">
                {# ... остальная часть превью ... #}
            </template>
            {% if form.photo.errors %}<p class="mt-1.5 text-sm text-red-600 dark:text-red-400 font-medium">{% for error in form.photo.errors %}{{ error }}{% endfor %}</p>{% endif %}
        </div>
        <!-- Contact Info -->
        <div>
            <label for="{{ form.contact_info.id_for_label }}" class="block text-lg font-medium text-slate-700 dark:text-slate-200 mb-2">
                {{ form.contact_info.label }}{% if form.contact_info.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
            </label>
            {{ form.contact_info }} {# Django рендерит <input type="text"> с классами из forms.py #}
            {% if form.contact_info.help_text %}
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">{{ form.contact_info.help_text|safe }}</p>
            {% endif %}
            {% if form.contact_info.errors %}
                <p class="mt-1.5 text-sm text-red-600 dark:text-red-400 font-medium">
                {% for error in form.contact_info.errors %}{{ error }}{% endfor %}
                </p>
            {% endif %}
        </div>

        <div class="pt-6">
            <button type="submit"
                    x-bind:disabled="formValues.isSubmitting"
                    class="w-full flex justify-center items-center py-3.5 px-7 border border-transparent rounded-xl text-lg font-semibold text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-purple-500/70 dark:focus:ring-offset-slate-800 disabled:opacity-60 disabled:from-slate-500 disabled:to-slate-400 dark:disabled:from-slate-600 dark:disabled:to-slate-500 transition-all duration-300 ease-in-out shadow-lg hover:shadow-xl transform hover:-translate-y-1 active:translate-y-0 active:shadow-lg">
                <span x-show="!formValues.isSubmitting">{% trans "Submit Feedback" %}</span>
                <span x-show="formValues.isSubmitting" class="inline-flex items-center">
                    {% trans "Processing..." %}
                    <svg class="animate-spin ml-3 -mr-1 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                </span>
            </button>
        </div>
    </form>
  </div>
</div>
{% endblock %}

{% block script_extra %}
<script>
function mainPageController() {
    return {
        formValues: {
            isSubmitting: false,
            currentRating: String({{ form.rating.value|default:'0' }}),
            hoverRating: 0,
        },
        
        init() {
            let initialRatingElement = document.querySelector('input[name="{{ form.rating.html_name }}"]:checked');
            if (initialRatingElement) {
                this.formValues.currentRating = initialRatingElement.value;
            }
        },

        ratingClass(starValue) {
            const hover = parseInt(this.formValues.hoverRating);
            const current = parseInt(this.formValues.currentRating);
            const isActiveBySelection = (hover === 0 && current >= starValue && current > 0);
            const isActiveByHover = (hover > 0 && starValue <= hover);
            const isActive = isActiveBySelection || isActiveByHover;
            let classes = 'transition-all duration-200 ease-out ';
            if (isActive) {
                classes += 'scale-110 ';
                const effectiveRating = hover > 0 ? hover : current;
                if (effectiveRating <= 2 && effectiveRating > 0) { classes += 'text-red-400 dark:text-red-500'; }
                else if (effectiveRating === 3) { classes += 'text-yellow-400 dark:text-yellow-500'; }
                else if (effectiveRating >= 4) { classes += 'text-green-400 dark:text-green-500'; }
                else { classes += 'text-slate-300 dark:text-slate-600'; }
            } else {
                classes += 'text-slate-300 dark:text-slate-600 ';
                if (starValue <= 2) { classes += 'hover:text-red-300 dark:hover:text-red-600'; }
                else if (starValue === 3) { classes += 'hover:text-yellow-300 dark:hover:text-yellow-600'; }
                else { classes += 'hover:text-green-300 dark:hover:text-green-600'; }
            }
            return classes;
        },

        submitFeedbackForm(formElement) { 
            this.formValues.isSubmitting = true;
            if (typeof gtag === 'function') {
                gtag('event', 'feedback_submitted', {
                    'event_category': 'Feedback Form',
                    'event_label': `{{ qr_link.short_code|default:"Unknown QR" }} - {{ qr_link.location.name|default:"Unknown Location"|escapejs }}`,
                    'value': parseInt(this.formValues.currentRating) || 0
                });
            } else { console.warn('gtag function not found. Analytics event not sent.'); }
            formElement.submit(); 
        }
    }
}

function imagePreviewWithFilters(photoInputId) { // Удален parentFormValues, т.к. он не используется
    return {
        photoPreview: { 
            imageUrl: null, selectedFilterValue: '',
            filters: [
                { name: 'Normal', css: '' }, { name: 'Grayscale', css: 'grayscale(100%)' },
                { name: 'Sepia', css: 'sepia(100%)' }, { name: 'Vintage', css: 'sepia(60%) contrast(90%) brightness(110%) saturate(120%)' },
                { name: 'Warm', css: 'brightness(110%) saturate(130%) sepia(20%)' }, { name: 'Cool', css: 'contrast(110%) brightness(105%) hue-rotate(-15deg) saturate(110%)' },
                { name: 'Invert', css: 'invert(100%)' },
            ]
        },
        photoInputId: photoInputId, // Используем id_for_label поля {{ form.photo }}
        init() {
            // this.photoInputId теперь это ID, который Django присвоит инпуту (e.g., "id_photo")
            const djangoFileInput = document.getElementById(this.photoInputId);
            if (djangoFileInput) {
                // Если файл уже выбран (например, после ошибки валидации)
                if (djangoFileInput.files && djangoFileInput.files[0]) {
                    this.updatePreview({ target: djangoFileInput });
                }
            } else {
                console.warn(`Photo input for preview with ID "${this.photoInputId}" not found.`);
            }
        },
        updatePreviewAndForm(event) { // Вызывается из @change на input, добавленного через фильтр
            this.updatePreview(event);
        },
        updatePreviewAndForm(event) { // Вызывается из @change на <input type="file">
            this.updatePreview(event);
        },
        updatePreview(e) {
            const file = e.target.files[0];
            if (!file) {
                this.photoPreview.imageUrl = null;
                this.photoPreview.selectedFilterValue = '';
                return;
            }
            if (file.size > 5 * 1024 * 1024) { 
                alert("{% trans 'File is too large. Maximum 5MB allowed.' %}");
                e.target.value = ''; this.photoPreview.imageUrl = null; return;
            }
            if (!['image/jpeg', 'image/png', 'image/gif', 'image/webp'].includes(file.type)) {
                alert("{% trans 'Invalid file type. Only JPG, PNG, GIF, and WEBP images are allowed.' %}");
                e.target.value = ''; this.photoPreview.imageUrl = null; return;
            }
            if (this.photoPreview.imageUrl) {
                URL.revokeObjectURL(this.photoPreview.imageUrl);
            }
            this.photoPreview.imageUrl = URL.createObjectURL(file);
            this.photoPreview.selectedFilterValue = '';
        },
        applyFilter(filterCss) { this.photoPreview.selectedFilterValue = filterCss; }
    }
}
</script>
{% endblock %}