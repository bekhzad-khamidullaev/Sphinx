{% extends 'base.html' %}

{% block content %}
<div class="max-w-3xl mx-auto p-6 bg-white shadow-lg rounded-lg">
    <h2 class="text-2xl font-bold mb-4">Chat: {{ chat.name|default:chat.pk }} <span id="reading-status" class="text-sm text-gray-500"></span></h2>
    {% if chat.task %}
        <p class="text-gray-600">Related Task: <a href="{% url 'tasks:task_detail' chat.task.id %}" class="text-blue-600 hover:underline">{{ chat.task.title }}</a></p>
    {% elif chat.ticket %}
        <p class="text-gray-600">Related Ticket: <a href="{% url 'tickets:ticket_detail' chat.ticket.id %}" class="text-blue-600 hover:underline">{{ chat.ticket.subject }}</a></p>
        <button id="create-chat" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 mt-2">Create Chat</button>
    {% endif %}

    <ul id="message-list" class="space-y-2 mt-4 overflow-auto max-h-96 p-2 border rounded-lg bg-gray-50">
        {% for message in messages %}
        <li id="message-{{ message.id }}" class="p-3 rounded-lg {% if message.sender == request.user %}bg-green-100 text-right{% else %}bg-gray-200 text-left{% endif %}">
            <strong>{{ message.sender.username }}</strong> <span class="text-xs text-gray-500">({{ message.timestamp }})</span>
            {% if message.file and message.file.url.endswith(('jpg', 'jpeg', 'png', 'gif')) %}
                <br><img src="{{ message.file.url }}" alt="Image" class="max-w-xs rounded-lg mt-2">
            {% elif message.file %}
                <a href="{{ message.file.url }}" target="_blank" class="text-blue-600 hover:underline">Download File</a>
            {% endif %}
            <p class="mt-1">{{ message.content }}</p>
            {% if message.sender != request.user %}
                <span class="text-sm text-gray-500">
                    {% if message.read_by.all %} Read {% else %} Unread {% endif %}
                </span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>

    <h3 class="text-lg font-semibold mt-4">Send Message</h3>
    <form id="message-form" enctype="multipart/form-data" class="mt-2 space-y-2">
        <textarea id="message-content" name="content" required class="w-full p-3 border rounded-lg focus:ring focus:ring-blue-200"></textarea>
        <input type="file" id="message-file" name="file" class="block w-full text-sm text-gray-600 border rounded-lg"/>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Send</button>
        <span id="loading-indicator" class="hidden text-gray-600">Sending...</span>
    </form>
</div>

<script>
    const chatId = {{ chat.id }};
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chats/' + chatId + '/');

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'chat.message') {
            const message = data.data;
            const messageList = document.getElementById('message-list');
            const newMessageItem = document.createElement('li');
            newMessageItem.classList.add('p-3', 'rounded-lg', message.sender_username === "{{ request.user.username }}" ? 'bg-green-100 text-right' : 'bg-gray-200 text-left');
            newMessageItem.innerHTML = `<strong>${message.sender_username}</strong> <span class="text-xs text-gray-500">(${new Date(message.timestamp).toLocaleString()})</span><p class="mt-1">${message.content}</p>`;
            if (message.file) {
                if (message.file.match(/\.(jpg|jpeg|png|gif)$/)) {
                    newMessageItem.innerHTML += `<br><img src="${message.file}" class="max-w-xs rounded-lg mt-2">`;
                } else {
                    newMessageItem.innerHTML += `<a href="${message.file}" target="_blank" class="text-blue-600 hover:underline">Download File</a>`;
                }
            }
            messageList.appendChild(newMessageItem);
            messageList.scrollTop = messageList.scrollHeight; 
        }
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.getElementById('message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const messageContent = document.getElementById('message-content').value.trim();
        const messageFile = document.getElementById('message-file').files[0];
        if (!messageContent && !messageFile) {
            alert('Message cannot be empty');
            return;
        }

        document.getElementById('loading-indicator').classList.remove('hidden');
        const formData = new FormData();
        formData.append('content', messageContent);
        if (messageFile) formData.append('file', messageFile);

        fetch(`/api/chats/${chatId}/messages/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('message-content').value = '';
            document.getElementById('message-file').value = '';
            document.getElementById('loading-indicator').classList.add('hidden');
            document.getElementById('message-content').focus(); 
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to send message');
            document.getElementById('loading-indicator').classList.add('hidden');
        });
    });
</script>
{% endblock %}