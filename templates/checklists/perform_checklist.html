{% extends 'base.html' %}
{% load i18n static %}
{% load widget_tweaks %}

{% block title %}{% trans "Выполнение чеклиста" %}: {{ template.name }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {{ formset.media.css }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .checklist-radio-group label {
            display: inline-flex;
            align-items: center;
            margin-right: 0.5rem;
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border: 1px solid theme('colors.gray.300');
            border-radius: 0.375rem;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            background-color: theme('colors.white');
            font-size: theme('fontSize.sm');
        }
        .checklist-radio-group input[type="radio"] {
            @apply form-radio h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500;
            margin-right: 0.4rem;
        }
        .checklist-radio-group input[type="radio"]:checked + span {
            font-weight: 600;
        }
        .checklist-radio-group label:hover {
            background-color: theme('colors.gray.100');
            border-color: theme('colors.gray.400');
        }
        .checklist-radio-group input[value="ok"]:checked ~ label {
            border-color: theme('colors.green.500') !important;
            background-color: theme('colors.green.50') !important;
            color: theme('colors.green.800') !important;
        }
        .checklist-radio-group input[value="not_ok"]:checked ~ label {
            border-color: theme('colors.red.500') !important;
            background-color: theme('colors.red.50') !important;
            color: theme('colors.red.800') !important;
        }
        .checklist-radio-group input[value="na"]:checked ~ label {
            border-color: theme('colors.gray.400') !important;
            background-color: theme('colors.gray.100') !important;
            color: theme('colors.gray.600') !important;
        }
        .comments-wrapper:not([data-status="not_ok"]),
        .is-corrected-wrapper:not([data-status="not_ok"]) {
            display: none;
        }
        .comments-wrapper[data-status="not_ok"],
        .is-corrected-wrapper[data-status="not_ok"] {
            display: block;
        }
    </style>
{% endblock %}

{% block list_title %}
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 sm:text-3xl">
                {% trans "Выполнение чеклиста" %}
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ template.name }} {% if template.category %}({{ template.category.name }}){% endif %}
            </p>
            <p class="text-xs text-gray-500 mt-1">
                {% trans "Выполняет" %}: {{ request.user.display_name|default:request.user.username }} | {% trans "Время начала" %}: {{ checklist_run.performed_at|date:"H:i" }}
            </p>
        </div>
        <div>
        </div>
    </div>
{% endblock %}

{% block list_content %}
    <div class="bg-white shadow-lg rounded-xl border border-gray-200 p-6 md:p-8 mt-6">
        {% include 'includes/form_errors.html' with formset=formset %}
        <form method="post" action="{% url 'checklists:checklist_perform' template_pk=template.pk %}" id="perform-checklist-form" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ formset.management_form }}
            <input type="hidden" name="checklist_run_id" value="{{ checklist_run.id }}">
            <div class="space-y-5">
                {% for form in formset %}
                <div class="result-form p-4 border border-gray-200 rounded-lg bg-gray-50 {% if form.errors %}border-red-500{% endif %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                    {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}
                    <div class="mb-3">
                        <p class="text-sm font-medium text-gray-800">
                            {{ forloop.counter }}. {{ form.template_item_display.initial }}
                            {% if form.template_item_point_display.initial %}
                                <span class="text-xs text-gray-500 ml-1">{{ form.template_item_point_display.initial }}</span>
                            {% endif %}
                        </p>
                        {% if form.help_text_display.initial %}
                            <p class="mt-1 text-xs text-gray-500 italic">{{ form.help_text_display.initial }}</p>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <div class="checklist-radio-group status-input-group flex flex-wrap gap-x-1 gap-y-2">
                            {% for radio in form.status %}
                            <label for="{{ radio.id_for_label }}">
                                {{ radio.tag }}
                                <span class="ml-2 text-sm">{{ radio.choice_label }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        {% if form.status.errors %}<div class="text-red-500 text-xs mt-1">{{ form.status.errors|first }}</div>{% endif %}
                    </div>
                    <div class="value-input-container ml-1 mt-2">
                        {% for field in form %}
                            {% if field.name in 'value,numeric_value,boolean_value,date_value,datetime_value,time_value,file_attachment,media_url' %}
                                {% if not field.is_hidden %}
                                    <div class="mb-2">
                                        <label for="{{ field.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase mb-1">{{ field.label }}</label>
                                        {% if field.widget_type == 'checkbox' %}
                                            <label class="inline-flex items-center">
                                                {% render_field field class+="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" %}
                                            </label>
                                        {% elif field.widget_type == 'radioselect' %}
                                            <div class="checklist-radio-group flex flex-wrap gap-x-1 gap-y-1">
                                                {% for radio in field %}
                                                    <label for="{{ radio.id_for_label }}">
                                                        {{ radio.tag }}
                                                        <span class="ml-2 text-sm">{{ radio.choice_label }}</span>
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        {% elif field.widget_type == 'select' %}
                                            {% render_field field class+="form-select select2-basic block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                        {% elif field.widget_type == 'textarea' %}
                                            {% render_field field class+="form-textarea block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" rows="2" %}
                                        {% elif field.widget_type == 'clearablefileinput' %}
                                            {% render_field field class+="form-input block w-full text-sm rounded-md border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                            {% if form.instance and field.name == 'file_attachment' and form.instance.file_attachment %}
                                                <div class="mt-1 text-xs">
                                                    <span class="text-gray-500">{% trans "Текущий" %}:</span>
                                                    <a href="{{ form.instance.file_attachment.url }}" target="_blank" class="text-blue-600 hover:underline">{{ form.instance.file_attachment.name|cut:"checklist_files/"|truncatechars:20 }}</a>
                                                </div>
                                            {% endif %}
                                        {% elif field.widget_type == 'date' or field.widget_type == 'datetime-local' or field.widget_type == 'time' %}
                                            {% render_field field class+="form-input flatpickr-input block w-auto text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                        {% else %}
                                            {% render_field field class+="form-input block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                        {% endif %}
                                        {% if field.errors %}<div class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</div>{% endif %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="comments-wrapper mt-2" data-status="{{ form.status.value|default:'pending' }}">
                        <label for="{{ form.comments.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase mb-1">{% trans "Комментарий" %}</label>
                        {% render_field form.comments class+="form-textarea block w-full text-sm rounded-md border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" rows="1" %}
                        {% if form.comments.errors %}<div class="text-red-500 text-xs mt-1">{{ form.comments.errors|first }}</div>{% endif %}
                    </div>
                    <div class="is-corrected-wrapper mt-2" data-status="{{ form.status.value|default:'pending' }}">
                        <label for="{{ form.is_corrected.id_for_label }}" class="inline-flex items-center text-xs">
                            {% render_field form.is_corrected class+="form-checkbox h-4 w-4 mr-1.5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" %}
                            {{ form.is_corrected.label }}
                        </label>
                        {% if form.is_corrected.errors %}<div class="text-red-500 text-xs mt-1">{{ form.is_corrected.errors|first }}</div>{% endif %}
                    </div>
                    {% if form.non_field_errors %}
                        <div class="mt-2 text-sm text-red-600">
                            {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% empty %}
                    <p class="text-gray-500 italic">{% trans "В этом шаблоне нет пунктов для выполнения." %}</p>
                {% endfor %}
            </div>
            <div class="flex justify-end items-center space-x-3 pt-6 mt-8 border-t border-gray-200">
                <a href="{% url 'checklists:template_list' %}" class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition active:scale-95 shadow-sm">
                    {% trans 'Отмена' %}
                </a>
                <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition active:scale-95 shadow-sm">
                    <i class="fas fa-check-circle mr-2"></i> {% trans 'Завершить чеклист' %}
                </button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>
    {{ formset.media.js }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function initPerformFlatpickr() {
                if (typeof flatpickr !== 'undefined') {
                    const lang = "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}";
                    flatpickr(".flatpickr-input[type='date']", { dateFormat: "Y-m-d", altInput: true, altFormat: "d.m.Y", locale: lang });
                    flatpickr(".flatpickr-input[type='datetime-local']", { enableTime: true, dateFormat: "Y-m-d H:i", altInput: true, altFormat: "d.m.Y H:i", locale: lang});
                    flatpickr(".flatpickr-input[type='time']", { enableTime: true, noCalendar: true, dateFormat: "H:i", altInput: true, altFormat: "H:i", locale: lang});
                } else { console.warn("Flatpickr not loaded for perform_checklist.");}
            }
            initPerformFlatpickr();

            document.querySelectorAll('.result-form').forEach(formDiv => {
                const statusGroup = formDiv.querySelector('.status-input-group');
                const commentsWrapper = formDiv.querySelector('.comments-wrapper');
                const correctedWrapper = formDiv.querySelector('.is-corrected-wrapper');

                if (statusGroup && (commentsWrapper || correctedWrapper)) {
                    function updateVisibility(statusValue) {
                        if (commentsWrapper) commentsWrapper.dataset.status = statusValue;
                        if (correctedWrapper) correctedWrapper.dataset.status = statusValue;
                    }

                    statusGroup.addEventListener('change', (event) => {
                        if (event.target.type === 'radio') {
                            updateVisibility(event.target.value);
                        }
                    });

                    // Initial check
                    const checkedRadio = statusGroup.querySelector('input[type="radio"]:checked');
                    updateVisibility(checkedRadio ? checkedRadio.value : 'pending'); // 'pending' or any default
                }
            });
        });
    </script>
{% endblock %}