{% extends 'base.html' %}
{% load i18n static %}
{% load widget_tweaks %} {# Load widget_tweaks #}

{% block title %}{% trans "Выполнение чеклиста" %}: {{ template.name }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {{ formset.media.css }}
    {# Load Flatpickr CSS #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        /* Style radio buttons for better layout */
        .checklist-radio-group label {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem; /* Spacing between options */
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border: 1px solid theme('colors.gray.300'); /* Default border */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            background-color: theme('colors.white');
        }
        html.dark .checklist-radio-group label {
             background-color: theme('colors.dark.700');
             border-color: theme('colors.dark.600');
             color: theme('colors.gray.300');
        }
         .checklist-radio-group input[type="radio"] {
             margin-right: 0.4rem;
             height: 1rem; width: 1rem; /* Slightly smaller */
             accent-color: theme('colors.indigo.600'); /* Use browser default styling */
         }
        /* Styling for selected radio labels */
        .checklist-radio-group input[type="radio"]:checked + span {
            font-weight: 600; /* semibold */
        }
         /* Optional: Hover effect */
         .checklist-radio-group label:hover {
             background-color: theme('colors.gray.100');
             border-color: theme('colors.gray.400');
         }
         html.dark .checklist-radio-group label:hover {
             background-color: theme('colors.dark.600');
             border-color: theme('colors.dark.500');
         }

         /* Specific colors for status */
        .checklist-radio-group input[value="ok"]:checked + span { color: theme('colors.green.700'); }
        .checklist-radio-group input[value="ok"]:checked ~ label { border-color: theme('colors.green.500'); background-color: theme('colors.green.50'); }
        html.dark .checklist-radio-group input[value="ok"]:checked + span { color: theme('colors.green.400'); }
        html.dark .checklist-radio-group input[value="ok"]:checked ~ label { border-color: theme('colors.green.600'); background-color: theme('colors.green.900/30'); }

        .checklist-radio-group input[value="not_ok"]:checked + span { color: theme('colors.red.700'); }
        .checklist-radio-group input[value="not_ok"]:checked ~ label { border-color: theme('colors.red.500'); background-color: theme('colors.red.50'); }
        html.dark .checklist-radio-group input[value="not_ok"]:checked + span { color: theme('colors.red.400'); }
        html.dark .checklist-radio-group input[value="not_ok"]:checked ~ label { border-color: theme('colors.red.600'); background-color: theme('colors.red.900/30'); }

        .checklist-radio-group input[value="na"]:checked + span { color: theme('colors.gray.500'); }
        .checklist-radio-group input[value="na"]:checked ~ label { border-color: theme('colors.gray.400'); background-color: theme('colors.gray.100'); }
        html.dark .checklist-radio-group input[value="na"]:checked + span { color: theme('colors.gray.400'); }
        html.dark .checklist-radio-group input[value="na"]:checked ~ label { border-color: theme('colors.dark.500'); background-color: theme('colors.dark.600');}

        /* Hide elements based on status using CSS data attributes */
        .comments-wrapper:not([data-status="not_ok"]),
        .is-corrected-wrapper:not([data-status="not_ok"]) {
            display: none;
        }
         /* Ensure wrappers are block when visible */
         .comments-wrapper[data-status="not_ok"],
         .is-corrected-wrapper[data-status="not_ok"] {
             display: block;
         }


    </style>
{% endblock %}

{% block list_title %}
<div class="flex items-center justify-between flex-wrap gap-4">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
            {% trans "Выполнение чеклиста" %}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
           {{ template.name }} {% if template.category %}({{ template.category.name }}){% endif %}
        </p>
         <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
             {% trans "Выполняет" %}: {{ request.user.display_name|default:request.user.username }} | {% trans "Время начала" %}: {{ checklist_run.performed_at|date:"H:i" }}
         </p>
    </div>
    <div>
        {# Maybe add a Save Progress button later if needed #}
        {# <button type="submit" form="perform-checklist-form" name="save_draft" class="btn-secondary">Сохранить черновик</button> #}
    </div>
</div>
{% endblock %}

{% block list_content %}
<div class="bg-white dark:bg-dark-800 shadow-xl rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8 mt-6">

    {# Display any global formset errors #}
    {% include 'includes/form_errors.html' with formset=formset %}

    <form method="post" action="{% url 'checklists:checklist_perform' template_pk=template.pk %}" id="perform-checklist-form" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}
        {# Pass checklist run ID back #}
        <input type="hidden" name="checklist_run_id" value="{{ checklist_run.id }}">

        {# Iterate through each form in the formset #}
        <div class="space-y-5">
            {% for form in formset %}
            <div class="result-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 {% if form.errors %}border-red-500 dark:border-red-700{% endif %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                {# Hidden fields for this form (Result ID, FKs etc.) #}
                 {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}

                 {# --- Item Info (Readonly) --- #}
                 <div class="mb-3">
                     <p class="text-sm font-medium text-gray-800 dark:text-gray-200">
                         {{ forloop.counter }}. {{ form.template_item_display.initial }}
                          {% if form.template_item_point_display.initial %}
                               <span class="text-xs text-gray-500 dark:text-gray-400 ml-1">{{ form.template_item_point_display.initial }}</span>
                           {% endif %}
                     </p>
                     {% if form.help_text_display.initial %}
                           <p class="mt-1 text-xs text-gray-500 dark:text-gray-400 italic">{{ form.help_text_display.initial }}</p>
                      {% endif %}
                 </div>

                 {# --- Status Radio Buttons --- #}
                 <div class="mb-3">
                    {# <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">{% trans "Результат" %}</label> #}
                    <div class="checklist-radio-group status-input-group flex flex-wrap gap-x-1 gap-y-2">
                        {% for radio in form.status %}
                        <label for="{{ radio.id_for_label }}">
                             {{ radio.tag }} {# Renders the <input type="radio"> #}
                             <span class="ml-2 text-sm">{{ radio.choice_label }}</span>
                         </label>
                        {% endfor %}
                    </div>
                    {% if form.status.errors %}<div class="text-red-500 text-xs mt-1">{{ form.status.errors|first }}</div>{% endif %}
                 </div>

                 {# --- Dynamic Value Input Field --- #}
                 <div class="value-input-container ml-1 mt-2">
                      {% for field in form %}
                          {# CORRECTED: Only check actual value fields #}
                          {% if field.name in 'value,numeric_value,boolean_value,date_value,datetime_value,time_value,file_attachment,media_url' %}
                               {# Check if the widget for THIS value field is NOT hidden (set in forms.py) #}
                               {% if not field.is_hidden %}
                                   <div class="mb-2">
                                        <label for="{{ field.id_for_label }}" class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">{{ field.label }}</label>
                                        {# Render the field, applying necessary classes #}
                                        {% if field.widget_type == 'checkbox' %}
                                            <label class="inline-flex items-center">
                                                 {% render_field field class+="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 border-gray-300 dark:border-dark-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:checked:bg-indigo-500 dark:bg-dark-600" %}
                                                 {# No label text needed usually for single checkbox, but you can add it if needed #}
                                                 {# <span class="ml-2 text-sm">{{ field.label }}</span> #}
                                            </label>
                                        {% elif field.widget_type == 'radioselect' %}
                                             <div class="checklist-radio-group flex flex-wrap gap-x-1 gap-y-1">
                                                  {% for radio in field %}
                                                       <label for="{{ radio.id_for_label }}">
                                                            {{ radio.tag }}
                                                            <span class="ml-2 text-sm">{{ radio.choice_label }}</span>
                                                       </label>
                                                  {% endfor %}
                                             </div>
                                         {% elif field.widget_type == 'select' %}
                                             {% render_field field class+="form-select select2-basic block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                                         {% elif field.widget_type == 'textarea' %}
                                             {% render_field field class+="form-textarea block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" rows="2" %}
                                         {% elif field.widget_type == 'clearablefileinput' %}
                                              {% render_field field class+="form-input block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md" %}
                                              {# Display current file link if exists #}
                                              {% if form.instance and field.name == 'file_attachment' and form.instance.file_attachment %}
                                                  <div class="mt-1 text-xs">
                                                      <span class="text-gray-500 dark:text-gray-400">{% trans "Текущий" %}:</span>
                                                      <a href="{{ form.instance.file_attachment.url }}" target="_blank" class="text-blue-600 hover:underline">{{ form.instance.file_attachment.name|cut:"checklist_files/"|truncatechars:20 }}</a>
                                                  </div>
                                              {% endif %}
                                         {% elif field.widget_type == 'date' or field.widget_type == 'datetime-local' or field.widget_type == 'time' %}
                                              {# Add flatpickr-input class for JS targeting #}
                                              {% render_field field class+="form-input flatpickr-input block w-auto text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                                         {% else %} {# Default input styling #}
                                              {% render_field field class+="form-input block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                                         {% endif %}
                                         {% if field.errors %}<div class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</div>{% endif %}
                                    </div>
                               {% endif %}
                          {% endif %}
                      {% endfor %}
                 </div>


                 {# --- Comments Textarea (Conditional display handled by JS/CSS) --- #}
                 {# Initial state set by data-status attribute #}
                 <div class="comments-wrapper mt-2" data-status="{{ form.status.value|default:'pending' }}">
                    <label for="{{ form.comments.id_for_label }}" class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">{% trans "Комментарий" %}</label>
                    {% render_field form.comments class+="form-textarea block w-full text-sm rounded-md dark:bg-dark-700 dark:border-dark-600" rows="1" %}
                    {% if form.comments.errors %}<div class="text-red-500 text-xs mt-1">{{ form.comments.errors|first }}</div>{% endif %}
                 </div>

                 {# --- Is Corrected Checkbox (Conditional display handled by JS/CSS) --- #}
                 {# Initial state set by data-status attribute #}
                  <div class="is-corrected-wrapper mt-2" data-status="{{ form.status.value|default:'pending' }}">
                       <label for="{{ form.is_corrected.id_for_label }}" class="inline-flex items-center text-xs">
                            {% render_field form.is_corrected class+="form-checkbox h-4 w-4 mr-1.5 text-indigo-600 dark:text-indigo-400 border-gray-300 dark:border-dark-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:checked:bg-indigo-500 dark:bg-dark-600" %}
                            {{ form.is_corrected.label }}
                       </label>
                       {% if form.is_corrected.errors %}<div class="text-red-500 text-xs mt-1">{{ form.is_corrected.errors|first }}</div>{% endif %}
                  </div>

                 {# Display any other non-field errors for this specific form #}
                 {% if form.non_field_errors %}
                     <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                         {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                     </div>
                 {% endif %}

            </div>
            {% empty %}
                <p class="text-gray-500 dark:text-gray-400 italic">{% trans "В этом шаблоне нет пунктов для выполнения." %}</p>
            {% endfor %}
        </div>

        {# Action Buttons #}
        <div class="flex justify-end items-center space-x-3 pt-6 mt-8 border-t border-gray-200 dark:border-dark-600">
            <a href="{% url 'checklists:template_list' %}" class="btn-secondary">
                {% trans 'Отмена' %}
            </a>
            <button type="submit" class="btn-primary bg-green-600 hover:bg-green-700 dark:bg-ios-green dark:hover:bg-green-500 focus:ring-green-500">
                 <i class="fas fa-check-circle mr-2"></i> {% trans 'Завершить чеклист' %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {# Load Flatpickr JS #}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script> {# Russian locale for Flatpickr #}
    {# Load Select2 JS if needed for any dynamic fields #}
    {# <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" defer></script> #}
    {# <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script> #}
    {# <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}.js" defer></script> #}

    {{ formset.media.js }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
             // --- Initialize Flatpickr ---
             function initPerformFlatpickr() {
                 if (typeof flatpickr !== 'undefined') {
                    // Use a more specific selector if needed, e.g., within #perform-checklist-form
                    flatpickr(".flatpickr-input[type='date']", { dateFormat: "Y-m-d", altInput: true, altFormat: "d.m.Y", locale: "ru" });
                    flatpickr(".flatpickr-input[type='datetime-local']", { enableTime: true, dateFormat: "Y-m-d H:i", altInput: true, altFormat: "d.m.Y H:i", locale: "ru"});
                    flatpickr(".flatpickr-input[type='time']", { enableTime: true, noCalendar: true, dateFormat: "H:i", altInput: true, altFormat: "H:i", locale: "ru"});
                    // console.log("Flatpickr Initialized for perform_checklist");
                 } else { console.warn("Flatpickr not loaded for perform_checklist.");}
             }
             initPerformFlatpickr(); // Init on load

             // --- Conditional Display Logic ---
             document.querySelectorAll('.result-form').forEach(formDiv => {
                 const statusGroup = formDiv.querySelector('.status-input-group');
                 const commentsWrapper = formDiv.querySelector('.comments-wrapper');
                 const correctedWrapper = formDiv.querySelector('.is-corrected-wrapper');

                 if (statusGroup && (commentsWrapper || correctedWrapper)) {
                     function updateVisibility(statusValue) {
                         // Update data-status for CSS selectors
                         if (commentsWrapper) commentsWrapper.dataset.status = statusValue;
                         if (correctedWrapper) correctedWrapper.dataset.status = statusValue;
                     }

                     // Add change listener
                     statusGroup.addEventListener('change', (event) => {
                         if (event.target.type === 'radio') {
                             updateVisibility(event.target.value);
                         }
                     });

                     // Initial check
                     const checkedRadio = statusGroup.querySelector('input[type="radio"]:checked');
                     updateVisibility(checkedRadio ? checkedRadio.value : 'pending');
                 }
             });

        }); // End DOMContentLoaded
    </script>
{% endblock %}