{% extends 'base.html' %}
{% load i18n static widget_tweaks %}

{% block title %}{% trans "Выполнение чеклиста" %}: {{ template.name }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {# No main form media, but formset might have some #}
    {{ formset.media.css }}
    <style>
        /* Style radio buttons for better layout */
        .checklist-radio-group label {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem; /* Spacing between options */
            cursor: pointer;
            padding: 0.3rem 0.6rem;
            border: 1px solid transparent;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
         .checklist-radio-group input[type="radio"] {
             margin-right: 0.4rem;
             height: 1rem; width: 1rem; /* Slightly smaller */
             /* Custom styling using ::before might be needed for perfect Tailwind look */
         }
        /* Styling for selected radio labels */
        .checklist-radio-group input[type="radio"]:checked + span {
            font-weight: 600; /* semibold */
        }
         /* Optional: Hover effect */
         .checklist-radio-group label:hover {
             background-color: theme('colors.gray.100');
             border-color: theme('colors.gray.300');
         }
         html.dark .checklist-radio-group label:hover {
             background-color: theme('colors.dark.700');
             border-color: theme('colors.dark.600');
         }
         /* Specific colors for status */
         .checklist-radio-group input[value="ok"]:checked ~ span { color: theme('colors.green.700'); }
         html.dark .checklist-radio-group input[value="ok"]:checked ~ span { color: theme('colors.green.400'); }
         .checklist-radio-group input[value="ok"]:checked:hover + span { background-color: theme('colors.green.50'); border-color: theme('colors.green.300');}
         html.dark .checklist-radio-group input[value="ok"]:checked:hover + span { background-color: theme('colors.green.900/30'); border-color: theme('colors.green.700');}

         .checklist-radio-group input[value="not_ok"]:checked ~ span { color: theme('colors.red.700'); }
         html.dark .checklist-radio-group input[value="not_ok"]:checked ~ span { color: theme('colors.red.400'); }
         .checklist-radio-group input[value="not_ok"]:checked:hover + span { background-color: theme('colors.red.50'); border-color: theme('colors.red.300');}
         html.dark .checklist-radio-group input[value="not_ok"]:checked:hover + span { background-color: theme('colors.red.900/30'); border-color: theme('colors.red.700');}

         .checklist-radio-group input[value="na"]:checked ~ span { color: theme('colors.gray.500'); }
         html.dark .checklist-radio-group input[value="na"]:checked ~ span { color: theme('colors.gray.400'); }
         .checklist-radio-group input[value="na"]:checked:hover + span { background-color: theme('colors.gray.100'); border-color: theme('colors.gray.300');}
         html.dark .checklist-radio-group input[value="na"]:checked:hover + span { background-color: theme('colors.dark.700'); border-color: theme('colors.dark.600');}

    </style>
{% endblock %}


{% block list_title %}
<div class="flex items-center justify-between flex-wrap gap-4">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
            {% trans "Выполнение чеклиста" %}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
           {{ template.name }} {% if template.category %}({{ template.category.name }}){% endif %}
        </p>
    </div>
    <div>
        {# Maybe add a Save Progress button later if needed #}
    </div>
</div>
{% endblock %}

{% block list_content %}
<div class="bg-white dark:bg-dark-800 shadow-xl rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8 mt-6">

    <form method="post" action="{% url 'checklists:checklist_perform' template_pk=template.pk %}" id="perform-checklist-form" novalidate>
        {% csrf_token %}
        {{ formset.management_form }}

        {# Display Non-Form Errors for the formset #}
        {% if formset.non_form_errors %}
        <div role="alert" class="mb-6 p-4 border border-red-300 bg-red-50 text-red-700 dark:bg-red-900/30 dark:border-red-700/50 dark:text-red-300 rounded-md">
            <h4 class="font-bold">{% trans "Ошибка сохранения:" %}</h4>
             <ul class="list-disc list-inside text-sm mt-1">
            {% for error in formset.non_form_errors %}
                <li>{{ error }}</li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}

        {# Iterate through each form in the formset #}
        <div class="space-y-5">
            {% for form in formset %}
            <div class="result-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 {% if form.errors %}border-red-500 dark:border-red-700{% endif %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                {# Hidden fields for this form (ID of result, link to checklist_run) #}
                 {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}

                 {# Display Item Text (Readonly) #}
                 <div class="mb-3">
                     <label class="block text-sm font-medium text-gray-800 dark:text-gray-200 mb-1">
                        {{ forloop.counter }}. {% trans "Пункт" %}
                     </label>
                     <p class="text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-dark-700 p-2 rounded border-none">
                         {{ form.instance.template_item.item_text }}
                     </p>
                 </div>

                 {# Status Radio Buttons #}
                 <div class="mb-3">
                    <label class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">{% trans "Результат" %}</label>
                    <div class="checklist-radio-group flex flex-wrap gap-x-4 gap-y-2">
                        {% for radio in form.status %}
                        <label for="{{ radio.id_for_label }}" class="text-sm">
                             {{ radio.tag }} {# Renders the <input type="radio"> #}
                             <span class="ml-2">{{ radio.choice_label }}</span>
                         </label>
                        {% endfor %}
                    </div>
                    {% if form.status.errors %}<div class="text-red-500 text-xs mt-1">{{ form.status.errors|first }}</div>{% endif %}
                 </div>

                 {# Comments Textarea #}
                 <div class="mb-1">
                    <label for="{{ form.comments.id_for_label }}" class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">{% trans "Комментарий" %}</label>
                    {% render_field form.comments class+="form-textarea block w-full text-sm rounded-md" rows="1" %}
                    {% if form.comments.errors %}<div class="text-red-500 text-xs mt-1">{{ form.comments.errors|first }}</div>{% endif %}
                 </div>

                 {# Display any other non-field errors for this specific form #}
                 {% if form.non_field_errors %}
                     <div class="mt-2 text-sm text-red-600 dark:text-red-400">
                         {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                     </div>
                 {% endif %}

            </div>
            {% empty %}
                <p class="text-gray-500 dark:text-gray-400 italic">{% trans "В этом шаблоне нет пунктов для выполнения." %}</p>
            {% endfor %}
        </div>

        {# Action Buttons #}
        <div class="flex justify-end items-center space-x-3 pt-6 mt-8 border-t border-gray-200 dark:border-dark-600">
            <a href="{% url 'checklists:template_list' %}" class="btn-secondary">
                {% trans 'Отмена' %}
            </a>
            <button type="submit" class="btn-primary bg-green-600 hover:bg-green-700 dark:bg-ios-green dark:hover:bg-green-500 focus:ring-green-500">
                 <i class="fas fa-check-circle mr-2"></i> {% trans 'Завершить чеклист' %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {{ formset.media.js }}
{% endblock %}