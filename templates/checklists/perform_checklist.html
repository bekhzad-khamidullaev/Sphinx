{% extends 'base.html' %}
{% load i18n static app_filters %}
{% load widget_tweaks %}

{% block title %}{% trans "Выполнение чеклиста" %}: {{ template.name }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {% if formset %}{{ formset.media.css }}{% endif %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block list_title %}
    <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 sm:text-3xl">
                {% trans "Выполнение чеклиста" %}
            </h1>
            <p class="text-sm text-gray-500 mt-1">
                {{ template.name }} {% if template.category %}({{ template.category.name }}){% endif %}
            </p>
            <p class="text-xs text-gray-500 mt-1">
                {% trans "Выполняет" %}: {{ request.user.display_name|default:request.user.username }} | {% trans "Время начала" %}: {{ checklist_run.performed_at|date:"H:i" }}
            </p>
        </div>
    </div>
{% endblock %}

{% block list_content %}
    <div class="bg-white shadow-lg rounded-xl border border-gray-200 p-6 md:p-8 mt-6">
        {% include 'includes/form_errors.html' with formset=formset form=None general_errors=None %}

        <form method="post" action="{% url 'checklists:checklist_perform' template_pk=template.pk %}" id="perform-checklist-form" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            {{ formset.management_form }}
            <input type="hidden" name="checklist_run_id" value="{{ checklist_run.id }}">
            <div class="space-y-5">
                {% for form_item in formset %}
                <div class="result-form p-4 border border-gray-200 rounded-lg bg-gray-50 {% if form_item.errors %}border-red-500{% endif %}" id="{{ formset.prefix }}-{{ forloop.counter0 }}">
                    {% for hidden_field in form_item.hidden_fields %}{{ hidden_field }}{% endfor %}

                    {% if form_item.fields.template_item_display %}
                        <div class="mb-1">
                             {{ form_item.template_item_display }}
                        </div>
                    {% endif %}
                    {% if form_item.fields.template_item_point_display and form_item.template_item_point_display.initial %}
                        <div class="mb-1 -mt-1">
                            {{ form_item.template_item_point_display }}
                        </div>
                    {% endif %}
                    {% if form_item.fields.help_text_display and form_item.help_text_display.initial %}
                         <div class="mb-2">
                            {{ form_item.help_text_display }}
                        </div>
                    {% endif %}

                    {% if form_item.fields.status %}
                        <div class="mb-3">
                            <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">{{ form_item.status.label }}</label>
                            <div class="status-input-group flex flex-wrap gap-x-1 gap-y-2">
                                {% for radio in form_item.status %}
                                <label for="{{ radio.id_for_label }}" class="inline-flex items-center cursor-pointer px-3 py-1.5 border border-gray-300 rounded-md transition-colors duration-200 bg-white text-sm hover:bg-gray-100 hover:border-gray-400
                                    has-[input[type=radio][value=ok]:checked]:border-green-500 has-[input[type=radio][value=ok]:checked]:bg-green-50 has-[input[type=radio][value=ok]:checked]:text-green-800
                                    has-[input[type=radio][value=not_ok]:checked]:border-red-500 has-[input[type=radio][value=not_ok]:checked]:bg-red-50 has-[input[type=radio][value=not_ok]:checked]:text-red-800
                                    has-[input[type=radio][value=na]:checked]:border-gray-400 has-[input[type=radio][value=na]:checked]:bg-gray-100 has-[input[type=radio][value=na]:checked]:text-gray-600">
                                    <input type="radio" name="{{ form_item.status.html_name }}" id="{{ radio.id_for_label }}" value="{{ radio.data.value }}" {% if radio.data.selected %}checked{% endif %} class="form-radio peer h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1.5">
                                    <span class="text-sm peer-checked:font-semibold">{{ radio.choice_label }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            {% if form_item.status.errors %}<div class="text-red-500 text-xs mt-1">{{ form_item.status.errors|first }}</div>{% endif %}
                        </div>
                    {% endif %}

                    {% for field in form_item.visible_fields %}
                        {% if field.name in form_item.Meta.fields and field.name not in "status,comments,is_corrected,template_item_display,template_item_point_display,help_text_display" and not field.is_hidden %}
                             <div class="value-input-container-specific mb-2">
                                <label for="{{ field.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase mb-1">{{ field.label }}</label>
                                {% if field.widget_type == 'checkbox' %}
                                     <label class="inline-flex items-center">
                                        {% render_field field class+="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 !block !w-auto" %}
                                    </label>
                                {% elif field.widget_type == 'radioselect' %}
                                    <div class="flex flex-wrap gap-x-1 gap-y-1">
                                        {% for radio_option in field %}
                                            <label for="{{ radio_option.id_for_label }}" class="inline-flex items-center cursor-pointer px-3 py-1.5 border border-gray-300 rounded-md transition-colors duration-200 bg-white text-sm hover:bg-gray-100 hover:border-gray-400 has-[input[type=radio]:checked]:border-indigo-500 has-[input[type=radio]:checked]:bg-indigo-50 has-[input[type=radio]:checked]:text-indigo-800">
                                               <input type="radio" name="{{ field.html_name }}" id="{{ radio_option.id_for_label }}" value="{{ radio_option.data.value }}" {% if radio_option.data.selected %}checked{% endif %} class="form-radio peer h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-1.5">
                                                <span class="text-sm peer-checked:font-semibold">{{ radio_option.choice_label }}</span>
                                            </label>
                                        {% endfor %}
                                    </div>
                                {% elif field.widget_type == 'select' %}
                                     {% render_field field class+="form-select select2-basic block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                {% elif field.widget_type == 'clearablefileinput' or field.widget_type == 'fileinput' %}
                                    {% render_field field class+="form-input block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-3 file:rounded-l-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" %}
                                    {% if form_item.instance and field.name == 'file_attachment' and form_item.instance.file_attachment and form_item.instance.file_attachment.url %}
                                        <div class="mt-1 text-xs">
                                            <span class="text-gray-500">{% trans "Текущий" %}:</span>
                                            <a href="{{ form_item.instance.file_attachment.url }}" target="_blank" class="text-blue-600 hover:underline">{{ form_item.instance.file_attachment.name|filename|truncatechars:25 }}</a>
                                        </div>
                                    {% endif %}
                                {% elif field.widget_type == 'dateinput' or field.widget_type == 'datetimeinput' or field.widget_type == 'timeinput' %}
                                     {% render_field field class+="form-input flatpickr-input block w-auto text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" data-widget-type=field.widget_type %}
                                {% elif field.widget_type == 'textarea' %}
                                     {% render_field field class+="form-input block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" rows=field.field.widget.attrs.rows|default:2 %}
                                {% else %}
                                     {% render_field field class+="form-input block w-full text-sm rounded-md shadow-sm border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" %}
                                {% endif %}
                                {% if field.errors %}<div class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</div>{% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    <div class="comments-wrapper mt-2 hidden">
                        <label for="{{ form_item.comments.id_for_label }}" class="block text-xs font-semibold text-gray-600 uppercase mb-1">{{ form_item.comments.label }}</label>
                        {% render_field form_item.comments class+="form-input block w-full text-sm rounded-md border-gray-300 focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 shadow-sm" rows="1" %}
                        {% if form_item.comments.errors %}<div class="text-red-500 text-xs mt-1">{{ form_item.comments.errors|first }}</div>{% endif %}
                    </div>
                    <div class="is-corrected-wrapper mt-2 hidden">
                        <label for="{{ form_item.is_corrected.id_for_label }}" class="inline-flex items-center text-xs">
                            {% render_field form_item.is_corrected class+="form-checkbox h-4 w-4 mr-1.5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" %}
                            {{ form_item.is_corrected.label }}
                        </label>
                        {% if form_item.is_corrected.errors %}<div class="text-red-500 text-xs mt-1">{{ form_item.is_corrected.errors|first }}</div>{% endif %}
                    </div>
                    {% if form_item.non_field_errors %}
                        <div class="mt-2 text-sm text-red-600">
                            {% for error in form_item.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}
                </div>
                {% empty %}
                    <p class="text-gray-500 italic">{% trans "В этом шаблоне нет пунктов для выполнения." %}</p>
                {% endfor %}
            </div>
            <div class="flex flex-col sm:flex-row justify-end items-center space-y-3 sm:space-y-0 sm:space-x-3 pt-6 mt-8 border-t border-gray-200">
                <button type="submit" name="action" value="save_draft" class="w-full sm:w-auto px-4 py-2 rounded-md text-sm font-medium text-indigo-700 bg-indigo-100 border border-transparent hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition active:scale-95 shadow-sm">
                    <i class="fas fa-save mr-2"></i> {% trans 'Сохранить черновик' %}
                </button>
                <button type="submit" name="action" value="submit_final" class="w-full sm:w-auto px-4 py-2 rounded-md text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition active:scale-95 shadow-sm">
                    <i class="fas fa-check-circle mr-2"></i> {% trans 'Завершить и отправить' %}
                </button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}.js" defer></script>
    {% if formset %}{{ formset.media.js }}{% endif %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('.select2-basic').select2({
                    theme: 'default',
                    language: "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}",
                    width: '100%',
                    allowClear: true,
                    placeholder: "{% trans 'Выберите...' %}",
                });
            }

            if (typeof flatpickr !== 'undefined') {
                const lang = "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}";
                const commonDateConfig = { altInput: true, altFormat: "d.m.Y", locale: lang };
                document.querySelectorAll(".flatpickr-input").forEach(function(element) {
                    let config = { ...commonDateConfig };
                    let widgetType = element.dataset.widgetType;

                    if (widgetType === 'dateinput') {
                        config.dateFormat = "Y-m-d";
                    } else if (widgetType === 'datetimeinput') {
                        config.enableTime = true;
                        config.dateFormat = "Y-m-d H:i";
                        config.altFormat = "d.m.Y H:i";
                    } else if (widgetType === 'timeinput') {
                        config.enableTime = true;
                        config.noCalendar = true;
                        config.dateFormat = "H:i";
                        config.altFormat = "H:i";
                    }
                    if (config.dateFormat) {
                        flatpickr(element, config);
                    }
                });
            }

            document.querySelectorAll('.result-form').forEach(formDiv => {
                const statusGroup = formDiv.querySelector('.status-input-group');
                function updateConditionalVisibility(currentFormDiv, statusValue) {
                    const comments = currentFormDiv.querySelector('.comments-wrapper');
                    const corrected = currentFormDiv.querySelector('.is-corrected-wrapper');
                    if (comments) comments.classList.toggle('hidden', statusValue !== 'not_ok');
                    if (corrected) corrected.classList.toggle('hidden', statusValue !== 'not_ok');
                }
                if (statusGroup) {
                    statusGroup.addEventListener('change', (event) => {
                        if (event.target.type === 'radio' && event.target.name.endsWith('-status')) {
                            updateConditionalVisibility(formDiv, event.target.value);
                        }
                    });
                    const checkedRadio = statusGroup.querySelector('input[type="radio"]:checked');
                    updateConditionalVisibility(formDiv, checkedRadio ? checkedRadio.value : 'pending');
                }
            });
        });
    </script>
{% endblock %}
