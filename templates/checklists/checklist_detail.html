{% extends 'base.html' %}
{% load i18n static app_filters %}

{% block title %}
    {% trans "Результаты чеклиста" %}: {{ checklist_run }}
{% endblock %}

{% block head_extra %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    {{ status_form.media.css }}
    <style>
        html.dark .select2-container--default .select2-selection--single {
            background-color: theme('colors.dark.700');
            border-color: theme('colors.dark.600');
        }
        html.dark .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: theme('colors.gray.300');
        }
        html.dark .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: theme('colors.gray.400') transparent transparent transparent;
        }
        html.dark .select2-dropdown {
            background-color: theme('colors.dark.800');
            border-color: theme('colors.dark.600');
        }
        html.dark .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: theme('colors.blue.600');
        }
        html.dark .select2-results__option[aria-selected=true] {
            background-color: theme('colors.dark.600');
        }
        html.dark .select2-search--dropdown .select2-search__field {
            background-color: theme('colors.dark.700');
            border-color: theme('colors.dark.600');
            color: theme('colors.gray.300');
        }
    </style>
{% endblock %}

{% block list_title %}
    {{ block.super }}
{% endblock %}

{% block list_content %}
<div class="mt-6 space-y-6">

    {# Пример секции информации о чеклисте #}
    <div class="bg-white p-6 rounded-lg shadow border dark:bg-dark-800 dark:border-dark-700">
        <h2 class="text-xl font-semibold mb-4">{% trans "Общая информация" %}</h2>
        <p>{{ checklist_run }}</p>
    </div>

    {# Пример секции с результатами #}
    {% if results %}
        <div class="space-y-4">
            {% for result in results %}
                {% include "includes/checklist_result_display.html" with result=result %}
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 italic">{% trans "Нет результатов." %}</p>
    {% endif %}

</div>
{% endblock %}


{% block scripts %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>
{% if status_form %}
    {{ status_form.media.js }}
{% endif %}

<script>
    document.addEventListener('alpine:init', () => {
        const btn = document.getElementById('toggleStatusFormBtn');
        const container = document.getElementById('statusFormContainer');
        if (btn && container) {
            btn.addEventListener('click', () => {
                container.dispatchEvent(new CustomEvent('open-status-form'));
                btn.classList.add('hidden');
            });
            container.addEventListener('open-status-form', () => {
                const alpineComponent = Alpine.$data(container);
                if (alpineComponent) {
                    alpineComponent.statusFormOpen = true;
                }
                container.classList.remove('hidden');
            });
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof Alpine === 'undefined') {
            const btn = document.getElementById('toggleStatusFormBtn');
            const container = document.getElementById('statusFormContainer');
            const cancelBtn = container?.querySelector('.btn-secondary');
            if (btn && container && cancelBtn) {
                btn.addEventListener('click', () => {
                    container.classList.remove('hidden');
                    btn.classList.add('hidden');
                });
                cancelBtn.addEventListener('click', () => {
                    container.classList.add('hidden');
                    btn.classList.remove('hidden');
                });
            }
        }
    });
</script>

<script defer>
    document.addEventListener('DOMContentLoaded', function () {
        const statusContainer = document.getElementById('statusFormContainer');
        if (statusContainer) {
            if (typeof flatpickr !== 'undefined') {
                flatpickr("#id_approved_at", {
                    enableTime: true,
                    dateFormat: "Y-m-d H:i",
                    altInput: true,
                    altFormat: "d.m.Y H:i",
                    locale: "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}"
                });
            } else {
                console.warn("Flatpickr library not loaded.");
            }

            if (typeof $ !== 'undefined' && $.fn.select2) {
                $('#id_status').select2({
                    theme: 'default',
                    language: "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}",
                    width: '100%',
                    minimumResultsForSearch: Infinity
                });
                $('#id_approved_by').select2({
                    theme: 'default',
                    language: "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}",
                    width: '100%',
                    placeholder: "{% trans 'Выберите пользователя...' %}",
                    allowClear: true
                });
            } else {
                console.warn("jQuery or Select2 not loaded.");
            }
        }
    });
</script>
{% endblock %}
