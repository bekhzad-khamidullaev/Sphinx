{% extends 'base.html' %}
{% load i18n static app_filters %} {# Load necessary tags #}

{% block title %}{% trans "Результаты чеклиста" %}: {{ checklist_run }}{% endblock %}

{% block list_title %}
<div class="flex items-center justify-between flex-wrap gap-4">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
            {% trans "Результаты чеклиста" %}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
           {{ checklist_run.template.name }} {% if checklist_run.template.category %}({{ checklist_run.template.category.name }}){% endif %}
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
           {% blocktrans with user=checklist_run.performed_by.display_name|default:"-" time=checklist_run.performed_at|date:"d.m.Y H:i" %}Выполнен: {{ user }} в {{ time }}{% endblocktrans %}
        </p>
    </div>
    <div class="flex space-x-3 flex-shrink-0">
         <a href="{% url 'checklists:history_list' %}" class="btn-secondary text-sm">
             <i class="fas fa-arrow-left mr-2"></i> {% trans 'К истории' %}
        </a>
        {# Add other actions like print/export if needed #}
         {# Status Change Button (visible if allowed) #}
         {% if request.user.is_staff and checklist_run.status == 'submitted' %}
             <button id="toggleStatusFormBtn" type="button" class="btn-secondary text-sm bg-yellow-100 text-yellow-800 border-yellow-300 hover:bg-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-700 dark:hover:bg-yellow-800/50">
                 <i class="fas fa-check-double mr-1.5"></i> {% trans 'Изменить статус' %}
             </button>
         {% endif %}
    </div>
</div>
{% endblock %}

{% block list_content %}
<div class="mt-6 space-y-6">

    {# Status Change Form (Hidden initially, toggled by button) #}
     {% if request.user.is_staff and checklist_run.status == 'submitted' %}
          <div id="statusFormContainer" class="hidden bg-yellow-50 dark:bg-dark-800 shadow-md rounded-lg border border-yellow-300 dark:border-dark-700 p-6 mb-6" x-data="{ statusFormOpen: false }" x-cloak>
               <h3 class="text-lg font-semibold mb-4 dark:text-white text-yellow-800 dark:text-yellow-300">{% trans "Одобрение / Отклонение чеклиста" %}</h3>
               <form method="post" action="{% url 'checklists:checklist_status_change' pk=checklist_run.pk %}" id="status-update-form" novalidate>
                   {% csrf_token %}
                   {# Render status form fields manually or using crispy #}
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                       {% include 'includes/form_field.html' with field=status_form.status %}
                       {% include 'includes/form_field.html' with field=status_form.approved_by %}
                       {% include 'includes/form_field.html' with field=status_form.approved_at %}
                       <div class="md:col-span-2">{% include 'includes/form_field.html' with field=status_form.notes %}</div>
                   </div>
                   <div class="flex justify-end space-x-3 mt-4 pt-4 border-t border-yellow-200 dark:border-dark-600">
                       <button type="button" @click="statusFormOpen = false; document.getElementById('statusFormContainer').classList.add('hidden'); document.getElementById('toggleStatusFormBtn').classList.remove('hidden');" class="btn-secondary text-sm">{% trans "Отмена" %}</button>
                       <button type="submit" class="btn-primary text-sm">{% trans "Сохранить статус" %}</button>
                   </div>
               </form>
          </div>
          {# Script to link button click to Alpine toggle - ensure Alpine is loaded #}
          <script>
             document.addEventListener('alpine:init', () => {
                 // This requires AlpineJS to be loaded before this script runs
                 // It links the external button to the Alpine component's state
                 const btn = document.getElementById('toggleStatusFormBtn');
                 const container = document.getElementById('statusFormContainer');
                 if (btn && container) {
                     btn.addEventListener('click', () => {
                          container.dispatchEvent(new CustomEvent('open-status-form'));
                          // Optionally hide the button itself
                          btn.classList.add('hidden');
                     });
                     container.addEventListener('open-status-form', () => {
                          // Assuming the container has x-data="{ statusFormOpen: false }"
                          // Find the Alpine component and set the state
                          const alpineComponent = Alpine.$data(container);
                          if(alpineComponent) {
                               alpineComponent.statusFormOpen = true;
                          }
                         container.classList.remove('hidden');
                     });
                 }
             });
             // Fallback if Alpine isn't used or fails
             document.addEventListener('DOMContentLoaded', () => {
                  if (typeof Alpine === 'undefined') {
                      const btn = document.getElementById('toggleStatusFormBtn');
                      const container = document.getElementById('statusFormContainer');
                      const cancelBtn = container?.querySelector('.btn-secondary'); // Assuming cancel button exists
                      if (btn && container) {
                          btn.addEventListener('click', () => { container.classList.remove('hidden'); btn.classList.add('hidden'); });
                          cancelBtn?.addEventListener('click', () => { container.classList.add('hidden'); btn.classList.remove('hidden'); });
                      }
                  }
             });
           </script>

     {% endif %}


    {# General Info section #}
    <div class="bg-white dark:bg-dark-800 shadow rounded-lg border border-gray-200 dark:border-dark-700 p-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 border-b dark:border-dark-600 pb-2">{% trans "Общая информация" %}</h2>
        <dl class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3 text-sm">
            <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Шаблон:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.template.name }}</dd></div>
            <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Выполнен:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.performed_by.display_name|default:'-' }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Статус:" %}</dt>
                 <dd>
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                        {% if checklist_run.status == 'approved' %} bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100
                        {% elif checklist_run.status == 'submitted' %} bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100
                        {% elif checklist_run.status == 'rejected' %} bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100
                        {% elif checklist_run.status == 'in_progress' %} bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100
                        {% else %} bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300
                        {% endif %}">
                        {{ checklist_run.get_status_display }}
                      </span>
                 </dd>
             </div>
            <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Время начала:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.performed_at|date:"d.m.Y H:i:s" }}</dd></div>
            <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Время завершения:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.completion_time|date:"d.m.Y H:i:s"|default:'-' }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Одобрено:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.approved_by.display_name|default:'-' }}{% if checklist_run.approved_at %} ({{ checklist_run.approved_at|date:"d.m.Y H:i" }}){% endif %}</dd></div>
             {% if checklist_run.related_task %}
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Связанная задача:" %}</dt><dd class="text-gray-800 dark:text-gray-200"><a href="{{ checklist_run.related_task.get_absolute_url }}" class="text-blue-600 hover:underline">{{ checklist_run.related_task.task_number }} - {{ checklist_run.related_task.title }}</a></dd></div>
             {% endif %}
             {% if checklist_run.location %}
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Местоположение:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.location }}</dd></div>
             {% endif %}
              {% if checklist_run.point %}
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Точка:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ checklist_run.point }}</dd></div>
             {% endif %}
              <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Оценка:" %}</dt><dd class="text-gray-800 dark:text-gray-200 font-semibold">{{ checklist_run.score|default:"-" }}</dd></div>
              <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Есть проблемы?" %}</dt>
                 <dd class="text-gray-800 dark:text-gray-200 font-semibold {% if checklist_run.has_issues %}text-red-600 dark:text-red-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                    {% if checklist_run.has_issues %}{% trans "Да" %}{% else %}{% trans "Нет" %}{% endif %}
                 </dd>
              </div>
             {% if checklist_run.notes %}
             <div class="lg:col-span-3"><dt class="text-gray-500 dark:text-gray-400 mb-1">{% trans "Общие примечания:" %}</dt><dd class="text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-dark-700 p-2 rounded border dark:border-dark-600">{{ checklist_run.notes|linebreaksbr }}</dd></div>
             {% endif %}
        </dl>
    </div>

    {# Results Section #}
    <div class="bg-white dark:bg-dark-800 shadow rounded-lg border border-gray-200 dark:border-dark-700 p-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">{% trans "Результаты по пунктам" %}</h2>
         {% if results %}
            <div class="space-y-5">
                 {% regroup results by template_item.section as results_by_section %}
                 {% for section in results_by_section %}
                      <div>
                           {% if section.grouper %}
                                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-dark-600 pb-1">
                                    {% trans "Секция" %}: {{ section.grouper.title }} ({{ section.grouper.order }})
                                </h3>
                           {% else %}
                                <h3 class="text-base font-semibold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-dark-600 pb-1">
                                    {% trans "Пункты без секции" %}
                                </h3>
                           {% endif %}

                           <div class="space-y-4 mt-3">
                                {% for result in section.list %}
                                <div class="result-item p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 flex flex-col md:flex-row md:items-start gap-4">
                                    <div class="flex-grow">
                                        <p class="text-sm font-medium text-gray-800 dark:text-gray-200 mb-1">{{ result.template_item.order }}. {{ result.template_item.item_text }}</p>
                                         <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                             {% if result.template_item.target_point %}<span class="mr-2">[{% trans "Точка" %}: {{ result.template_item.target_point.name }}]</span>{% endif %}
                                             (<span class="mr-2">{% trans "Тип" %}: {{ result.template_item.get_answer_type_display }}</span>)
                                              {% if result.template_item.help_text %}<span class="italic">({% trans "Подсказка" %}: {{ result.template_item.help_text }})</span>{% endif %}
                                         </div>
                                         {% if result.comments %}
                                            <p class="text-xs text-gray-600 dark:text-gray-400 mt-2 pl-4 border-l-2 border-gray-300 dark:border-dark-600 italic">{% trans "Комментарий:" %} {{ result.comments }}</p>
                                        {% endif %}
                                    </div>
                                    <div class="flex-shrink-0 md:text-right space-y-1">
                                         <div class="flex items-center justify-end">
                                             {# Display Answer Value #}
                                             <span class="text-sm mr-2 font-medium text-gray-700 dark:text-gray-200">
                                                  {% if result.template_item.answer_type == 'file' %}
                                                      {% if result.file_attachment %}
                                                          <a href="{{ result.file_attachment.url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-paperclip mr-1"></i> {{ result.file_attachment.name|cut:"checklist_files/"|truncatechars:20 }}</a>
                                                      {% else %}-{% endif %}
                                                  {% elif result.template_item.answer_type == 'url' %}
                                                      {% if result.media_url %}
                                                          <a href="{{ result.media_url }}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-link mr-1"></i> {% trans "Ссылка" %}</a>
                                                      {% else %}-{% endif %}
                                                  {% else %}
                                                      {{ result.display_value|default:"-"|linebreaksbr }}
                                                  {% endif %}
                                             </span>
                                             {# Status Badge #}
                                             <span class="status-badge px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full
                                                {% if result.status == 'ok' %}bg-green-100 text-green-800 dark:bg-green-900/60 dark:text-green-200
                                                {% elif result.status == 'not_ok' %}bg-red-100 text-red-800 dark:bg-red-900/60 dark:text-red-200
                                                {% elif result.status == 'na' %}bg-gray-100 text-gray-500 dark:bg-dark-600 dark:text-gray-400
                                                {% else %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/60 dark:text-yellow-200{% endif %}">
                                                {{ result.get_status_display }}
                                            </span>
                                         </div>
                                         {# Corrected Badge #}
                                         {% if result.status == 'not_ok' and result.is_corrected %}
                                             <span class="status-badge px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/60 dark:text-blue-200">
                                                 <i class="fas fa-wrench mr-1"></i> {% trans "Исправлено" %}
                                            </span>
                                         {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                           </div>
                      </div>
                 {% endfor %} {# End regroup results #}
            </div>
         {% else %}
             <p class="text-gray-500 dark:text-gray-400 italic">{% trans "Нет результатов для этого прогона." %}</p>
         {% endif %}
    </div>

</div>
{% endblock %}

{% block scripts %}
 {{ block.super }}
 {# Load AlpineJS if needed for status form toggle #}
 {# <script src="//unpkg.com/alpinejs" defer></script> #}
 {# Load Flatpickr if needed for status form #}
 <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
 <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>
 {{ status_form.media.js }} {# Include media for the status form #}
 <script defer>
    document.addEventListener('DOMContentLoaded', function() {
       // Initialize flatpickr for the status form if it exists
        if (typeof flatpickr !== 'undefined') {
            flatpickr("#id_approved_at", { // Target specific ID
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                altInput: true,
                altFormat: "d.m.Y H:i",
                locale: "{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}"
            });
        }
         // Initialize Select2 for the status form if it exists
         if (typeof $ !== 'undefined' && $.fn.select2) {
             $('#id_status').select2({theme: 'default', width: '100%', minimumResultsForSearch: Infinity});
             $('#id_approved_by').select2({theme: 'default', width: '100%', placeholder: "{% trans 'Выберите пользователя...' %}", allowClear: true});
         }
    });
 </script>
{% endblock %}