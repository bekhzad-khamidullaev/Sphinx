{% extends 'base.html' %}
{% load i18n static %}
{% load taggit_helpers %} {# Optional: if you want to display tags nicely #}

{% block title %}{% trans "Шаблон чеклиста" %}: {{ template.name }}{% endblock %}

{% block list_title %}
<div class="flex items-center justify-between flex-wrap gap-4">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
            {{ template.name }} {% if template.version %}(v{{ template.version }}){% endif %}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
           {% if template.category %}{% trans 'Категория' %}: {{ template.category.name }}{% else %}{% trans 'Без категории' %}{% endif %}
           <span class="mx-2 text-gray-300 dark:text-gray-600">|</span>
           {% if template.is_active %}
               <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300">
                   <i class="fas fa-check mr-1"></i>{% trans 'Активен' %}
               </span>
           {% else %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300">
                    <i class="fas fa-times mr-1"></i>{% trans 'Неактивен' %}
               </span>
           {% endif %}
            {% if template.is_archived %}
                <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                    <i class="fas fa-archive mr-1"></i>{% trans 'Архивирован' %}
               </span>
           {% endif %}
        </p>
    </div>
    {# Action Buttons Section #}
    <div class="flex flex-wrap gap-2 sm:gap-3 flex-shrink-0">
        {# Perform Button (Green) #}
        <a href="{% url 'checklists:checklist_perform' template_pk=template.pk %}"
           class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 dark:bg-ios-green dark:hover:bg-green-500 dark:focus:ring-offset-dark-800 transition-all active:scale-95">
             <i class="fas fa-play mr-2"></i> {% trans 'Выполнить' %}
        </a>
        {# Edit Button (Yellow) #}
        <a href="{% url 'checklists:template_update' pk=template.pk %}"
           class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-gray-900 bg-yellow-400 hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 dark:bg-ios-yellow dark:text-black dark:hover:bg-yellow-300 dark:focus:ring-offset-dark-800 transition-all active:scale-95">
            <i class="fas fa-edit mr-2"></i> {% trans 'Редактировать' %}
        </a>
        {# Back Button (Standard secondary/gray) #}
         <a href="{% url 'checklists:template_list' %}"
            class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-dark-700 dark:text-gray-300 dark:hover:bg-dark-600 dark:focus:ring-offset-dark-800 transition-all active:scale-95">
             <i class="fas fa-arrow-left mr-2"></i> {% trans 'К списку шаблонов' %}
        </a>
         {# Delete Button (Red) #}
        <a href="{% url 'checklists:template_delete' pk=template.pk %}"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-ios-red dark:hover:bg-red-500 dark:focus:ring-offset-dark-800 transition-all active:scale-95">
             <i class="fas fa-trash mr-2"></i> {% trans 'Удалить' %}
        </a>
    </div>
</div>
{% endblock %}

{% block list_content %}
<div class="mt-6 space-y-6">

    {# Main Info Card #}
    <div class="bg-white dark:bg-dark-800 shadow rounded-lg border border-gray-200 dark:border-dark-700 p-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4 border-b dark:border-dark-600 pb-2">{% trans "Основная информация" %}</h2>
        <dl class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-3 text-sm">
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "UUID:" %}</dt><dd class="text-gray-800 dark:text-gray-200 break-all">{{ template.uuid }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Целевое Местоположение:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.target_location|default:"-" }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Целевая Точка:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.target_point|default:"-" }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Периодичность:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.frequency|default:"-" }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "След. дата:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.next_due_date|date:"d.m.Y"|default:"-" }}</dd></div>
              <div>
                 <dt class="text-gray-500 dark:text-gray-400 mb-1">{% trans "Теги:" %}</dt>
                 <dd class="flex flex-wrap gap-1">
                      {% if template.tags.all %}
                         {% for tag in template.tags.all %}
                              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100">
                                  {{ tag.name }}
                              </span>
                         {% endfor %}
                      {% else %}
                          <span class="text-gray-800 dark:text-gray-200">-</span>
                      {% endif %}
                 </dd>
             </div>
             <div class="lg:col-span-3"><dt class="text-gray-500 dark:text-gray-400 mb-1">{% trans "Описание:" %}</dt><dd class="prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-gray-300">{{ template.description|default:"-"|linebreaksbr }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Создан:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.created_at|date:"d.m.Y H:i" }}</dd></div>
             <div><dt class="text-gray-500 dark:text-gray-400">{% trans "Обновлен:" %}</dt><dd class="text-gray-800 dark:text-gray-200">{{ template.updated_at|date:"d.m.Y H:i" }}</dd></div>
        </dl>
    </div>

    {# Items Section #}
    <div class="bg-white dark:bg-dark-800 shadow rounded-lg border border-gray-200 dark:border-dark-700 p-6">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">{% trans "Пункты чеклиста" %} ({{ template.items.count }})</h2>

        {% regroup template.items.all by section as items_by_section %}
        <div class="space-y-5">
            {% for section_group in items_by_section %}
                <div>
                    {% if section_group.grouper %}
                        <h3 class="text-base font-semibold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-dark-600 pb-1">
                            {% trans "Секция" %}: {{ section_group.grouper.title }} ({{ section_group.grouper.order }})
                        </h3>
                    {% else %}
                         <h3 class="text-base font-semibold text-gray-700 dark:text-gray-200 mb-2 border-b dark:border-dark-600 pb-1">
                            {% trans "Пункты без секции" %}
                        </h3>
                    {% endif %}

                    <ol class="space-y-3 text-gray-700 dark:text-gray-300 text-sm mt-3">
                        {% for item in section_group.list %}
                            <li class="bg-gray-50 dark:bg-dark-700 p-3 rounded-md border border-gray-200 dark:border-dark-600 flex items-start">
                                <span class="mr-3 font-mono text-xs text-gray-500 dark:text-gray-400 pt-0.5">{{ item.order }}.</span> {# Item order within section #}
                                <div class="flex-1">
                                    <span class="font-medium">{{ item.item_text|linebreaksbr }}</span>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                         <span class="mr-2">({% trans "Тип" %}: {{ item.get_answer_type_display }})</span>
                                         {% if item.target_point %}<span class="mr-2">[{% trans "Точка" %}: {{ item.target_point.name }}]</span>{% endif %}
                                         {% if item.help_text %}<span class="mr-2 italic">({% trans "Подсказка" %}: {{ item.help_text }})</span>{% endif %}
                                         {% if item.default_value %}<span class="mr-2">[{% trans "По умолч." %}: {{ item.default_value }}]</span>{% endif %}
                                         {% if item.parent_item %}<span class="mr-2 text-blue-500">[{% trans "Родитель" %}: #{{ item.parent_item.order }}]</span>{% endif %}
                                     </div>
                                      {# Optional: Display sub-items #}
                                     {% if item.sub_items.exists %}
                                         <ul class="mt-2 pl-4 border-l-2 border-gray-300 dark:border-dark-500 text-xs space-y-1">
                                         {% for sub_item in item.sub_items.all %}
                                              <li>
                                                    <span class="font-semibold">{{ sub_item.order }}. {{ sub_item.item_text }}</span>
                                                    <span class="text-gray-500 dark:text-gray-400 ml-1">({{ sub_item.get_answer_type_display }})</span>
                                               </li>
                                         {% endfor %}
                                         </ul>
                                     {% endif %}
                                </div>
                            </li>
                        {% empty %}
                             <p class="text-gray-500 dark:text-gray-400 italic">{% trans "В этой секции нет пунктов." %}</p>
                        {% endfor %}
                    </ol>
                </div>
            {% empty %}
                <p class="text-gray-500 dark:text-gray-400 italic">{% trans "В этом шаблоне пока нет пунктов." %}</p>
            {% endfor %}
        </div>
    </div>

</div>
{% endblock %}