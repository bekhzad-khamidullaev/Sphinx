{% load i18n static widget_tweaks %}

{# Represents one row in the formset #}
<div class="formset-item item-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 space-y-3" id="{{ prefix }}-{% if forloop %}{{ forloop.counter0 }}{% else %}__prefix__{% endif %}">
     {# Hidden fields for the form (ID, FKs, etc.) #}
     {% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}

     <div class="flex items-start justify-between gap-4">
         {# Main Form Fields (order, item_text, answer_type etc.) #}
         <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 flex-grow">
             {% for field in form.visible_fields %}
             <div>
                 <label for="{{ field.id_for_label }}" class="block text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase mb-1">
                     {{ field.label }} {% if field.field.required %}<span class="text-red-500">*</span>{% endif %}
                 </label>
                  {% if field.widget_type == 'checkbox' %}
                       <div class="flex items-center pt-1">
                           {% render_field field class+="form-checkbox h-4 w-4 text-indigo-600 dark:text-indigo-400 border-gray-300 dark:border-dark-600 rounded focus:ring-indigo-500 dark:focus:ring-indigo-400 dark:checked:bg-indigo-500 dark:bg-dark-600" %}
                           <label for="{{ field.id_for_label }}" class="ml-2 block text-xs text-gray-900 dark:text-gray-300">{{ field.label }}</label>
                      </div>
                      <script>document.querySelector('label[for="{{ field.id_for_label }}"]').classList.add('hidden');</script> {# Hide original label #}
                  {% elif field.widget_type == 'select' %}
                      {% render_field field class+="form-select select2-basic block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                  {% elif field.widget_type == 'textarea' %}
                      {% render_field field class+="form-textarea block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" rows="1" %}
                  {% elif field.name == 'order' %}
                      {% render_field field class+="form-input w-16 text-center text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                  {% else %} {# Default input #}
                      {% render_field field class+="form-input block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" %}
                  {% endif %}
                  {% if field.errors %}<p class="mt-1 text-xs text-red-600 dark:text-red-400">{{ field.errors|striptags }}</p>{% endif %}
             </div>
             {% endfor %}
         </div>
         {# Delete Button #}
         {% if formset.can_delete %}
         <div class="flex-shrink-0 pt-5">
             <button type="button" title="{% trans 'Удалить пункт' %}" class="delete-formset-item p-2 text-red-500 dark:text-red-400 hover:bg-red-100 dark:hover:bg-dark-600 rounded-md transition-colors">
                 <i class="fas fa-trash fa-fw"></i>
             </button>
              {# The actual DELETE checkbox is hidden #}
              <div class="hidden">{{ form.DELETE }}</div>
         </div>
         {% endif %}
     </div>
      {# Display Non-field errors specific to this form #}
      {% if form.non_field_errors %}
         <div class="text-sm text-red-600 dark:text-red-400">
             {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
         </div>
      {% endif %}
</div>