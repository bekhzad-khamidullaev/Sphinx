{% load static i18n %}
{% load app_filters %} {# Ensure app_filters is loaded if filename filter exists #}

{# Determine if message is from the current user #}
<div class="message-item flex {% if is_own_message %}justify-end{% else %}justify-start{% endif %} group" id="message-{{ message.id }}" data-message-id="{{ message.id }}">
    <div class="flex items-end max-w-[85%] sm:max-w-[75%] md:max-w-[65%] {% if is_own_message %}flex-row-reverse{% endif %} space-x-2 rtl:space-x-reverse">

        {# Avatar (Show only for other users' messages) #}
        {% if not is_own_message %}
        <img src="{% if message.user.avatar_url %}{{ message.user.avatar_url }}{% elif message.user.image %}{{ message.user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ message.user.username|default:'System' }}" class="w-6 h-6 rounded-full flex-shrink-0 mb-1 object-cover self-start mt-1"> {# Align avatar top #}
        {% endif %}

        {# Message Bubble Container #}
        <div class="flex flex-col space-y-0.5 text-sm {% if is_own_message %} items-end {% else %} items-start {% endif %}">
            {# Username (only for others' messages) #}
            {% if not is_own_message %}
                <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 px-1">{{ message.user.username|default:"System" }}</span>
            {% endif %}

            {# Reply Context #}
            {% if message.reply_to %}
            <a href="#message-{{ message.reply_to.id }}" onclick="document.getElementById('message-{{ message.reply_to.id }}')?.scrollIntoView({behavior:'smooth', block:'center'}); return false;"
               class="block text-xs p-2 rounded-lg border {% if is_own_message %}bg-blue-100 border-blue-200 dark:bg-blue-900/50 dark:border-blue-700/50{% else %}bg-gray-100 border-gray-200 dark:bg-dark-600 dark:border-dark-500{% endif %} opacity-80 hover:opacity-100 mb-1 max-w-xs cursor-pointer" title="{% trans 'Перейти к сообщению' %}">
                <p class="font-medium text-gray-700 dark:text-gray-300">{% trans "В ответ" %} {{ message.reply_to.user.username|default:"System" }}</p>
                <p class="text-gray-500 dark:text-gray-400 italic truncate">
                    {% if message.reply_to.is_deleted %}{% trans "[сообщение удалено]" %}
                    {% elif message.reply_to.file %}<i class="fas fa-file mr-1"></i> {% trans "Файл:" %} {{ message.reply_to.get_filename|default:message.reply_to.file.name }} {# Use model method #}
                    {% else %}{{ message.reply_to.content|truncatechars:50 }}
                    {% endif %}
                </p>
            </a>
            {% endif %}

            {# Main Bubble Content #}
            <div class="relative px-3 py-2 rounded-xl min-w-[70px] {% if is_own_message %}rounded-br-none bg-blue-600 dark:bg-ios-blue text-white{% else %}rounded-bl-none bg-white dark:bg-dark-700 text-gray-900 dark:text-gray-100 shadow-sm border border-gray-200 dark:border-dark-600{% endif %}">
                 {# Message Content #}
                 {% if message.is_deleted %}
                    <em class="text-xs italic opacity-70">{% trans "Сообщение удалено" %}</em>
                 {% elif message.file %}
                    <div class="flex items-center space-x-2 py-1">
                         <span class="text-2xl {% if is_own_message %}text-blue-100{% else %}text-gray-400 dark:text-gray-500{% endif %}"><i class="fas fa-file-alt"></i></span>
                         <div class="flex-1 min-w-0"> {# Allow truncation #}
                             <a href="{{ message.file.url }}" target="_blank" rel="noopener noreferrer" class="block hover:underline break-all font-medium text-sm {% if is_own_message %}text-white hover:text-blue-100{% else %}text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300{% endif %}" title="{{ message.get_filename|default:message.file.name }}">
                                 {{ message.get_filename|default:message.file.name|truncatechars:35 }} {# Use model method, truncate #}
                             </a>
                             {% if message.file.size %} {# Display size if available #}
                                 <span class="text-xs {% if is_own_message %}text-blue-200{% else %}text-gray-500 dark:text-gray-400{% endif %}">({{ message.file.size|filesizeformat }})</span>
                             {% endif %}
                             {% if message.content %} {# Optional caption #}
                                 <p class="mt-1 text-xs opacity-90 {% if is_own_message %}text-blue-100{% endif %}">{{ message.content|linebreaksbr }}</p>
                             {% endif %}
                         </div>
                    </div>
                 {% else %}
                     {# Apply linebreaks and escape for safety if needed, linkify URLs #}
                     <p class="whitespace-pre-wrap break-words">{{ message.content|linebreaksbr|urlizetrunc:40 }}</p>
                 {% endif %}

                 {# Timestamp & Edit Status Container #}
                 <div class="text-right {% if is_own_message %}text-blue-200{% else %}text-gray-400 dark:text-gray-500{% endif %} text-[11px] mt-1 pt-0.5 leading-none">
                     {% if message.edited_at %}<span title="{% trans 'Отредактировано' %} {{ message.edited_at|date:'d.m H:i' }}">(ред.)</span>{% endif %}
                     <span title="{{ message.date_added|date:'d.m.Y H:i:s' }}">{{ message.date_added|date:"H:i" }}</span>
                 </div>

                 {# Reactions Area #}
                 <div class="reactions-area mt-1 flex flex-wrap gap-1 {% if is_own_message %}justify-end{% else %}justify-start{% endif %}" id="reactions-{{ message.id }}">
                    {# Reactions populated by JS using generateReactionsHtml #}
                 </div>

                 {# Action Buttons (Appear on group hover) - Adjusted positioning #}
                 <div class="absolute top-[-8px] {% if is_own_message %}left-[-10px]{% else %}right-[-10px]{% endif %} z-10 hidden group-hover:flex space-x-1 bg-gray-100 dark:bg-dark-600 p-1 rounded-full shadow text-gray-600 dark:text-gray-300 text-xs">
                    <button type="button" data-action="add-reaction" title="{% trans 'Реагировать' %}" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 focus:outline-none"><i class="far fa-smile"></i></button>
                    <button type="button" data-action="reply-message" title="{% trans 'Ответить' %}" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 focus:outline-none"><i class="fas fa-reply"></i></button>
                    {% if is_own_message and not message.is_deleted %} {# Check if own message and not deleted #}
                    <button type="button" data-action="edit-message" title="{% trans 'Редактировать' %}" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 focus:outline-none"><i class="fas fa-pen"></i></button>
                    <button type="button" data-action="delete-message" title="{% trans 'Удалить' %}" class="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-dark-500 text-red-500 hover:text-red-700 focus:outline-none"><i class="fas fa-trash"></i></button>
                    {% endif %}
                 </div>
            </div>
        </div>
    </div>
</div>