{% load i18n app_filters static %}

<div id="task-list"
    class="mt-6 overflow-x-auto bg-white dark:bg-dark-800 shadow-lg rounded-xl border border-gray-200 dark:border-dark-700 hidden">
    <table class="min-w-full divide-y divide-gray-200 dark:divide-dark-600">
        <thead class="bg-gray-50 dark:bg-dark-700/50 sticky top-0 z-10">
            <tr class="text-xs text-left text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                {% include 'includes/sortable_th.html' with column_name='task_number' display_name='#' current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='title' display_name=_('Название') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='project' display_name=_('Проект') current_sort=current_sort request=request %} {# Sorted by project.name via view #}
                {% include 'includes/sortable_th.html' with column_name='status' display_name=_('Статус') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='priority' display_name=_('Приоритет') current_sort=current_sort request=request %}
                <th scope="col" class="px-4 py-3.5">{% trans 'Участники' %}</th>
                {% include 'includes/sortable_th.html' with column_name='due_date' display_name=_('Срок') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='created_by' display_name=_('Инициатор') current_sort=current_sort request=request %} {# Sorted by created_by.username via view #}
                <th scope="col" class="px-4 py-3.5 text-center"><i class="fas fa-cogs fa-fw mr-1"></i>{% trans 'Действия' %}</th>
            </tr>
        </thead>
        <tbody class="bg-white dark:bg-dark-800 divide-y divide-gray-200 dark:divide-dark-700">
            {% for task in tasks_for_table %}
            <tr id="task-row-{{ task.pk }}" class="hover:bg-gray-50 dark:hover:bg-dark-700/50 transition-colors duration-150 text-sm text-gray-700 dark:text-gray-300">
                <td class="px-4 py-3 whitespace-nowrap">
                    <a href="{% url 'tasks:task_detail' pk=task.pk %}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                        #{{ task.task_number|default:task.pk }}
                    </a>
                </td>
                <td class="px-4 py-3">{{ task.title|truncatechars:40 }}</td>
                <td class="px-4 py-3 whitespace-nowrap">
                    {% if task.project %}
                        <a href="{{ task.project.get_absolute_url }}" class="hover:underline" title="{{task.project.name}}">{{ task.project.name|truncatechars:20 }}</a>
                    {% else %}-{% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                     <select class="status-dropdown appearance-none px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full focus:outline-none focus:ring-1 focus:ring-blue-400 transition-all border border-transparent hover:border-gray-300 dark:hover:border-dark-600 focus:border-blue-400 cursor-pointer
                        {% if task.status == task.StatusChoices.NEW %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200
                        {% elif task.status == task.StatusChoices.IN_PROGRESS %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/80 dark:text-yellow-200
                        {% elif task.status == task.StatusChoices.ON_HOLD %}bg-blue-100 text-blue-800 dark:bg-blue-900/80 dark:text-blue-200
                        {% elif task.status == task.StatusChoices.CANCELLED or task.status == 'canceled' %}bg-gray-100 text-gray-500 dark:bg-dark-700 dark:text-gray-400 line-through
                        {% elif task.status == task.StatusChoices.COMPLETED %}bg-green-100 text-green-800 dark:bg-green-900/80 dark:text-green-200
                        {% elif task.status == task.StatusChoices.OVERDUE %}bg-red-100 text-red-800 dark:bg-red-900/80 dark:text-red-200
                        {% else %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% endif %}"
                        name="status" data-task-id="{{ task.pk }}" title="{% trans 'Изменить статус' %}"
                        {% if task.is_overdue and task.status != task.StatusChoices.COMPLETED and task.status != task.StatusChoices.CANCELLED %}disabled{% endif %}>
                        {% for status_val, status_name in status_choices_list %} {# status_choices_list from main template context #}
                            <option value="{{ status_val }}"{% if task.status == status_val %} selected{% endif %}>{{ status_name }}</option>
                        {% endfor %}
                    </select>
                    {% if task.is_overdue and task.status != task.StatusChoices.COMPLETED and task.status != task.StatusChoices.CANCELLED %}
                        <span class="text-xs italic text-red-500 dark:text-red-400 ml-1" title="{% trans 'Задача просрочена.' %}">
                            <i class="fas fa-lock"></i>
                        </span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    <span class="inline-flex items-center gap-1 text-xs font-medium
                        {% if task.priority == task.TaskPriority.HIGH %} text-red-600 dark:text-red-400
                        {% elif task.priority == task.TaskPriority.MEDIUM_HIGH %} text-orange-600 dark:text-orange-400
                        {% elif task.priority == task.TaskPriority.MEDIUM %} text-yellow-600 dark:text-yellow-400
                        {% elif task.priority == task.TaskPriority.MEDIUM_LOW %} text-blue-600 dark:text-blue-400
                        {% elif task.priority == task.TaskPriority.LOW %} text-green-600 dark:text-green-400
                        {% else %} text-gray-500 dark:text-gray-400 {% endif %}">
                        {% if task.priority == task.TaskPriority.HIGH %}<i class="fas fa-flag fa-fw"></i>
                        {% elif task.priority == task.TaskPriority.MEDIUM_HIGH %}<i class="fas fa-angle-double-up fa-fw"></i>
                        {% elif task.priority == task.TaskPriority.MEDIUM %}<i class="fas fa-equals fa-fw"></i>
                        {% elif task.priority == task.TaskPriority.MEDIUM_LOW %}<i class="fas fa-angle-double-down fa-fw"></i>
                        {% elif task.priority == task.TaskPriority.LOW %}<i class="fas fa-angle-down fa-fw"></i>
                        {% endif %}
                        {{ task.get_priority_display }}
                    </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-xs">
                    {% for assignment in task.assignments.all %}
                        {% if assignment.role == task.TaskAssignment.RoleChoices.RESPONSIBLE %}
                            <span class="font-semibold block" title="{% trans 'Ответственный' %}">{{ assignment.user.display_name|default:assignment.user.username|truncatechars:18 }}</span>
                        {% endif %}
                    {% endfor %}
                    {% for assignment in task.assignments.all %}
                        {% if assignment.role == task.TaskAssignment.RoleChoices.EXECUTOR %}
                             <span class="block text-gray-600 dark:text-gray-400" title="{% trans 'Исполнитель' %}">{{ assignment.user.display_name|default:assignment.user.username|truncatechars:18 }}</span>
                        {% endif %}
                    {% endfor %}
                    {% if not task.assignments.all %}-{% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    {% if task.due_date %}
                        <span class="inline-flex items-center gap-1 text-xs {% if task.is_overdue %}text-red-600 dark:text-red-400 font-semibold{% else %}text-gray-500 dark:text-gray-300{% endif %}">
                            <i class="fas fa-calendar-alt"></i> {{ task.due_date|date:"d.m.Y" }}
                        </span>
                    {% else %}
                        <span class="text-gray-400 dark:text-gray-500">—</span>
                    {% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap">
                    {% if task.created_by %}
                        {{ task.created_by.display_name|default:task.created_by.username|truncatechars:18 }}
                    {% else %}-{% endif %}
                </td>
                <td class="px-4 py-3 text-center whitespace-nowrap">
                    <div class="flex items-center justify-center space-x-1">
                        <a href="{% url 'tasks:task_detail' pk=task.pk %}" title="{% trans 'Подробнее' %}" class="p-1.5 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-dark-600 transition-colors"><i class="fas fa-eye fa-fw"></i></a>
                        <a href="{% url 'tasks:task_update' pk=task.pk %}" title="{% trans 'Редактировать' %}" class="p-1.5 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-dark-600 transition-colors"><i class="fas fa-edit fa-fw"></i></a>
                        <button type="button" data-action="delete-task" data-task-id="{{ task.pk }}"
                            data-task-name="{{ task.title|escapejs }}"
                            {# data-delete-url will be constructed by JS using template from task-list-config #}
                            title="{% trans 'Удалить' %}"
                            class="p-1.5 rounded-full text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-dark-600 transition-colors">
                            <i class="fas fa-trash fa-fw"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400 italic">
                    <i class="fas fa-folder-open fa-3x mb-3 text-gray-400 dark:text-gray-500"></i><br>
                    {% trans 'Задачи не найдены.' %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>