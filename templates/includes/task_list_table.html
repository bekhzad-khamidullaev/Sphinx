{% load i18n app_filters static %}
{# Табличное представление задач (изначально видимо) #}
<div id="task-list-table"
    class="mt-6 overflow-x-auto bg-white dark:bg-dark-800 shadow-lg rounded-xl border border-gray-200 dark:border-dark-700"
    {# data-ajax-base-url="{{ ajax_base_url }}" #} {# URL для AJAX можно передать через JS #}
    >
    <table class="min-w-full divide-y divide-gray-200 dark:divide-dark-600">
        <thead class="bg-gray-50 dark:bg-dark-700/50 sticky top-0 z-10">
            <tr class="text-xs text-left text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                {# Заголовки таблицы с сортировкой #}
                {% include 'includes/sortable_th.html' with column_name='task_number' display_name='#' current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='title' display_name=_('Название') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='project__name' display_name=_('Проект') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='status' display_name=_('Статус') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='priority' display_name=_('Приоритет') current_sort=current_sort request=request %}
                {% include 'includes/sortable_th.html' with column_name='deadline' display_name=_('Срок') current_sort=current_sort request=request %}
                <th scope="col" class="px-4 py-3.5">{% trans 'Участники' %}</th> {# Без сортировки #}
                {% include 'includes/sortable_th.html' with column_name='created_by__username' display_name=_('Инициатор') current_sort=current_sort request=request %}
                <th scope="col" class="px-4 py-3.5 text-center"><i class="fas fa-cogs fa-fw mr-1"></i>{% trans 'Действия' %}</th>
            </tr>
        </thead>
        <tbody id="task-table-tbody" class="bg-white dark:bg-dark-800 divide-y divide-gray-200 dark:divide-dark-700">
            {% for task in tasks_list %} {# Используем tasks_list (или page_obj.object_list) #}
            <tr id="task-row-{{ task.pk }}" class="hover:bg-gray-50 dark:hover:bg-dark-700/50 transition-colors duration-150 text-sm text-gray-700 dark:text-gray-300">
                {# Номер задачи #}
                <td class="px-4 py-3 whitespace-nowrap">
                    <a href="{% url 'tasks:task_detail' pk=task.pk %}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                        {{ task.task_number }}
                    </a>
                </td>
                {# Название #}
                <td class="px-4 py-3">
                     <a href="{% url 'tasks:task_detail' pk=task.pk %}" class="hover:text-blue-700 dark:hover:text-blue-400 transition-colors">{{ task.title|truncatechars:40 }}</a>
                </td>
                {# Проект #}
                <td class="px-4 py-3 whitespace-nowrap">
                    <a href="{{ task.project.get_absolute_url }}" class="text-gray-600 dark:text-gray-400 hover:underline">{{ task.project.name }}</a>
                </td>
                {# Статус (с выпадающим списком) #}
                <td class="px-4 py-3 whitespace-nowrap">
                    <select class="status-dropdown appearance-none px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full focus:outline-none focus:ring-1 focus:ring-blue-400 transition-all border border-transparent hover:border-gray-300 dark:hover:border-dark-600 focus:border-blue-400 cursor-pointer
                        {% if task.status == 'new' %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200
                        {% elif task.status == 'in_progress' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/80 dark:text-yellow-200
                        {% elif task.status == 'on_hold' %}bg-blue-100 text-blue-800 dark:bg-blue-900/80 dark:text-blue-200
                        {% elif task.status == 'canceled' %}bg-gray-100 text-gray-500 dark:bg-dark-700 dark:text-gray-400 line-through
                        {% elif task.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900/80 dark:text-green-200
                        {% elif task.status == 'overdue' %}bg-red-100 text-red-800 dark:bg-red-900/80 dark:text-red-200
                        {% else %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% endif %}"
                        name="status" data-task-id="{{ task.pk }}" title="{% trans 'Изменить статус' %}"
                        {% if not task.has_permission|call:"request.user,'change_status'" %}disabled{% endif %}> {# Отключаем, если нет прав #}
                        {% for status_val, status_name in task.StatusChoices.choices %}
                            <option value="{{ status_val }}"{% if task.status == status_val %} selected{% endif %}>{{ status_name }}</option>
                        {% endfor %}
                    </select>
                </td>
                {# Приоритет #}
                <td class="px-4 py-3 whitespace-nowrap">
                     {% with priority_color_class=task.priority|get_priority_tailwind_color %}
                     <span class="inline-flex items-center gap-1 text-xs font-medium {{ priority_color_class|replace_str:'border-l-4 border-,text-' }}" title="{{ task.get_priority_display }}">
                         {% if task.priority == task.TaskPriority.HIGH %}<i class="fas fa-flag fa-fw text-red-500"></i>
                         {% elif task.priority == task.TaskPriority.MEDIUM_HIGH %}<i class="fas fa-angle-double-up fa-fw text-orange-500"></i>
                         {% elif task.priority == task.TaskPriority.MEDIUM %}<i class="fas fa-equals fa-fw text-yellow-500"></i>
                         {% elif task.priority == task.TaskPriority.MEDIUM_LOW %}<i class="fas fa-angle-double-down fa-fw text-blue-500"></i>
                         {% elif task.priority == task.TaskPriority.LOW %}<i class="fas fa-angle-down fa-fw text-green-500"></i>
                         {% else %}<i class="fas fa-question-circle fa-fw text-gray-400"></i>
                         {% endif %}
                         {{ task.get_priority_display }}
                     </span>
                     {% endwith %}
                </td>
                {# Срок #}
                <td class="px-4 py-3 whitespace-nowrap">
                    {% if task.deadline %}
                        <span class="inline-flex items-center gap-1 text-xs {% if task.is_overdue %}text-red-600 dark:text-red-400 font-semibold{% else %}text-gray-500 dark:text-gray-300{% endif %}">
                            <i class="far fa-calendar-alt"></i> {{ task.deadline|date:"d.m.Y" }}
                        </span>
                    {% else %}
                        <span class="text-gray-400 dark:text-gray-500">—</span>
                    {% endif %}
                </td>
                 {# Участники (Ответственный/Исполнители) #}
                 <td class="px-4 py-3 whitespace-nowrap text-xs">
                     {% with responsible=task.get_responsible_users executors=task.get_executors %}
                     <div class="flex flex-col space-y-0.5">
                          {% if responsible %}
                             <span class="text-gray-600 dark:text-gray-300" title="{% trans 'Ответственный' %}">
                                 <i class="fas fa-user-shield fa-fw text-gray-400 dark:text-gray-500"></i> {{ responsible.0.display_name|truncatechars:15 }}
                             </span>
                          {% endif %}
                          {% if executors %}
                             <span class="text-gray-500 dark:text-gray-400" title="{% trans 'Исполнители' %}">
                                 <i class="fas fa-user-cog fa-fw text-gray-400 dark:text-gray-500"></i> {{ executors.0.display_name|truncatechars:15 }}{% if executors|length > 1 %} +{{ executors|length|add:"-1" }}{% endif %}
                             </span>
                          {% endif %}
                          {% if not responsible and not executors %}<span class="text-gray-400 dark:text-gray-500 italic">—</span>{% endif %}
                     </div>
                     {% endwith %}
                 </td>
                {# Создатель #}
                <td class="px-4 py-3 whitespace-nowrap text-xs">{{ task.created_by.display_name|default:"-" }}</td>
                {# Действия #}
                <td class="px-4 py-3 text-center whitespace-nowrap">
                    <div class="flex items-center justify-center space-x-1">
                        <a href="{% url 'tasks:task_detail' pk=task.pk %}" title="{% trans 'Подробнее' %}" class="p-1.5 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-dark-600 transition-colors"><i class="fas fa-eye fa-fw"></i></a>
                        {% if task.has_permission|call:"request.user,'change'" %}
                        <a href="{% url 'tasks:task_update' pk=task.pk %}" title="{% trans 'Редактировать' %}" class="p-1.5 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-600 transition-colors"><i class="fas fa-edit fa-fw"></i></a>
                        {% endif %}
                        {% if task.has_permission|call:"request.user,'delete'" %}
                        <button type="button" data-action="delete-task" data-task-id="{{ task.pk }}" data-task-name="{{ task.title|escapejs }}" title="{% trans 'Удалить' %}" class="p-1.5 rounded-full text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-dark-600 transition-colors">
                            <i class="fas fa-trash fa-fw"></i>
                        </button>
                         {% endif %}
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400 italic">
                    <i class="fas fa-folder-open fa-3x mb-3 text-gray-400 dark:text-gray-500"></i><br>
                    {% trans 'Задачи не найдены. Попробуйте изменить фильтры.' %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div> {# Конец #task-list-table #}

{# Скрытый шаблон для новой строки таблицы (если используется JS для добавления) #}
{# <template id="task-row-template"> ... </template> #}