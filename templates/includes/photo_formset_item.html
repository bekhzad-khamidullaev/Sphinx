{% load i18n widget_tweaks %}

{# Скрытые поля для этой формы #}
{% for hidden_field in form.hidden_fields %}{{ hidden_field }}{% endfor %}

{# Сетка для полей одного фото #}
<div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-start">

    {# Колонка загрузки фото #}
    <div class="sm:col-span-4">
        <label for="{{ form.photo.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
            {{ form.photo.label }}
            {% if form.photo.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
        </label>

         {# Превью существующего фото #}
         {% if form.instance.pk and form.instance.photo %}
         <div class="mb-2 group relative w-24 h-24">
             <a href="{{ form.instance.photo.url }}" target="_blank" title="{% trans 'Просмотреть полное изображение' %}" class="block">
                {# Предполагаем, что используется easy-thumbnails или аналог #}
                {% load thumbnail %}
                {% thumbnail form.instance.photo 96x96 crop="center" as thumb %}
                    <img src="{{ thumb.url }}" width="{{ thumb.width }}" height="{{ thumb.height }}" alt="{% trans 'Текущее фото' %}" class="w-full h-full object-cover rounded shadow-md border border-gray-300 dark:border-dark-600">
                {% empty %}
                    <img src="{{ form.instance.photo.url }}" alt="{% trans 'Текущее фото' %}" class="w-full h-full object-cover rounded shadow-md border border-gray-300 dark:border-dark-600">
                {% endthumbnail %}
             </a>
             {# Чекбокс удаления поверх превью #}
             {% if formset.can_delete and form.DELETE %}
             <div class="absolute -top-2 -right-2 bg-white dark:bg-dark-800 rounded-full p-0.5 shadow cursor-pointer group-hover:opacity-100 opacity-75 transition-opacity" title="{% trans 'Отметить для удаления' %}">
                 <label for="{{ form.DELETE.id_for_label }}" class="flex items-center justify-center w-5 h-5 text-xs text-red-600 dark:text-red-400 cursor-pointer">
                     {% render_field form.DELETE %} {# Только чекбокс #}
                 </label>
             </div>
             {% endif %}
         </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">{% trans "Загрузите новый файл, чтобы заменить." %}</p>
         {% endif %}

        {# Поле загрузки файла #}
        {% render_field form.photo class+="form-input block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-dark-600 dark:border-dark-500 dark:placeholder-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-gray-600 dark:file:text-gray-300 dark:hover:file:bg-gray-500" %}

        {% if form.photo.help_text %}<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ form.photo.help_text|safe }}</p>{% endif %}
        {% if form.photo.errors %}<div class="mt-1 text-sm text-red-600 dark:text-red-400">{% for error in form.photo.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
    </div>

    {# Колонка описания фото #}
    <div class="sm:col-span-7"> {# Оставляем 1 колонку для кнопки удаления #}
         <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
             {{ form.description.label }}
             {% if form.description.field.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
         </label>
         {% render_field form.description class+="form-textarea block w-full text-sm dark:bg-dark-600 dark:border-dark-500 rounded-md shadow-sm" rows="3" %}
         {% if form.description.help_text %}<p class="mt-1 text-xs text-gray-500 dark:text-gray-400">{{ form.description.help_text|safe }}</p>{% endif %}
         {% if form.description.errors %}<div class="mt-1 text-sm text-red-600 dark:text-red-400">{% for error in form.description.errors %}<p>{{ error }}</p>{% endfor %}</div>{% endif %}
    </div>

    {# Кнопка удаления (для JS) #}
    <div class="sm:col-span-1 flex items-center {% if not formset.can_delete %}hidden{% endif %}"> {# Скрываем, если удаление запрещено #}
         <button type="button" title="{% trans 'Удалить это фото' %}" class="delete-formset-item p-1.5 rounded-full text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-dark-600 transition-colors mt-6">
             <i class="fas fa-trash fa-fw"></i>
         </button>
         {# Скрытое поле DELETE используется, если оно есть в форме #}
         <div class="hidden">
             {% if form.DELETE %}{{ form.DELETE }}{% endif %}
         </div>
    </div>

     {# Ошибки, не связанные с полями, для этой формы фото #}
     {% if form.non_field_errors %}
         <div class="sm:col-span-12 mt-2 text-sm text-red-600 dark:text-red-400">
             {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
         </div>
     {% endif %}

</div> {# Конец сетки #}