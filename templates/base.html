{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="height: 100vh; overflow: hidden;">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="{% static 'img/fav.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v5.12.1/css/pro.min.css">
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" 
          integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- HTMX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.9/htmx.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.9/ext/ws.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js"></script>
    <!-- Apple-Inspired Styles -->
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .cupertino-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
    </style>

    <title>{% block title %}{% endblock %}</title>
</head>
<body class="bg-gray-50 text-gray-900">

{% if user.is_authenticated %}
<!-- Navbar -->
<header class="fixed w-full top-0 z-50 flex items-center bg-white/60 backdrop-blur-lg px-4 py-3 shadow-md">
    <div class="flex-none w-48 flex items-center">
        <a href="/" class="flex items-center">
            <img src="{% static 'img/logo.png' %}" class="w-9">
            <strong class="ml-2 text-teal-600 text-lg font-semibold">Sphinx</strong>
        </a>
    </div>

    <!-- Dropdown Задачи -->
    <div class="relative mx-4">
        <button id="tasksDropdown" class="flex items-center bg-white px-4 py-2 rounded-full shadow hover:bg-gray-100 transition-all duration-200">
            {% trans 'Задачи' %}
            <i class="fas fa-chevron-down ml-2 text-sm"></i>
        </button>
        <div id="tasksMenu" class="absolute left-0 mt-2 w-56 bg-white shadow-xl rounded-2xl overflow-hidden hidden transition-opacity duration-300">
            <ul class="py-2">
                <li><a href="{% url 'tasks:category_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Категории' %}</a></li>
                <li><a href="{% url 'tasks:task_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Список задач' %}</a></li>
                <li><a href="{% url 'tasks:campaign_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Кампании' %}</a></li>
            </ul>
        </div>
    </div>

    <div class="flex-1 flex justify-center">{% block list_actions %}{% endblock %}</div>

    <!-- User Menu -->
    <div class="relative">
        <button id="userMenuBtn" class="flex items-center px-4 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-all">
            <img class="w-8 h-8 rounded-full object-cover" src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}">
            <span class="ml-2 text-gray-800">{{ user.get_full_name }}</span>
        </button>
        <div id="userMenu" class="absolute right-0 mt-2 w-48 bg-white shadow-xl rounded-xl hidden transition-opacity duration-300">
            <a href="#" class="block px-4 py-2 hover:bg-gray-100">{% trans 'Профиль' %}</a>
            <a href="#" class="block px-4 py-2 hover:bg-gray-100">{% trans 'Входящие' %}</a>
            {% if user.is_superuser %}
            <a href="/admin/" class="block px-4 py-2 hover:bg-gray-100">{% trans 'Админка' %}</a>
            {% endif %}
            <hr class="border-gray-200">
            <a href="{% url 'user_profiles:logout' %}" class="block px-4 py-2 hover:bg-gray-100">{% trans 'Выход' %}</a>
        </div>
    </div>
</header>

<!-- Content -->
<main class="mt-16 px-4">
    {% block content %}{% endblock %}
</main>

<!-- Модальное окно -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-center justify-center">
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full relative">
        <button onclick="closeModal()" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800">✖</button>
        <div id="modal-content"></div>
    </div>
</div>


{% else %}
{% include 'users/login.html' %}
{% endif %}


<!-- Script -->
{% block scripts %}{% endblock %}
<script>
    // WebSocket Connection
    const socket = new WebSocket('ws://' + window.location.host + '/ws/tasks/');
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.message) {
            showNotification(data.message);
        }
    };

    // Show Notification
    function showNotification(message) {
        const notification = document.createElement('div');
        notification.classList.add('notification');
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
        const sound = new Audio('/static/sounds/notification.mp3');
        sound.play();
    }
</script>

<!-- CSS for pop-up notifications -->
<style>
    .notification {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #444;
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 16px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    }
</style>

<script>
    // Dropdown меню
    document.getElementById('tasksDropdown').addEventListener('click', function() {
        let menu = document.getElementById('tasksMenu');
        menu.classList.toggle('hidden');
    });
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === "modal-content") {
            openModal(); // ✅ Теперь точно откроется модалка!
        }
    });
    
    function closeModal() {
        let modal = document.getElementById("modal");
        if (modal) {
            modal.classList.add("hidden");
            let modalContent = document.getElementById("modal-content");
            if (modalContent) {
                modalContent.innerHTML = ''; // Очищаем содержимое
            }
        }
    }
    function openModal() {
        let modal = document.getElementById("modal");
        if (modal) {
            modal.classList.remove("hidden");
            console.log("✅ Modal Opened!");
        } else {
            console.error("❌ Modal NOT FOUND!");
        }
    }
    
    // User Menu Toggle
    document.getElementById('userMenuBtn').addEventListener('click', function() {
        let menu = document.getElementById('userMenu');
        menu.classList.toggle('hidden');
        setTimeout(() => menu.classList.toggle('opacity-0'), 10);
    });

    // Sidebar Toggle
    const sideBar = document.getElementById('sideBar');
    const sideBarOpenBtn = document.getElementById('sideBarOpenBtn');
    const sideBarCloseBtn = document.getElementById('sideBarCloseBtn');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');

    function openSidebar() {
        sideBar.classList.remove('-translate-x-full');
        sidebarBackdrop.classList.remove('hidden');
    }

    function closeSidebar() {
        sideBar.classList.add('-translate-x-full');
        sidebarBackdrop.classList.add('hidden');
    }

    sideBarOpenBtn.addEventListener('click', openSidebar);
    sideBarCloseBtn.addEventListener('click', closeSidebar);
    sidebarBackdrop.addEventListener('click', closeSidebar);

    // Dropdown Toggle
    document.getElementById('dropdownTasksButton').addEventListener('click', function() {
        document.getElementById('dropdown-1').classList.toggle('hidden');
    });
    document.getElementById('dropdownChatsButton').addEventListener('click', function() {
        document.getElementById('dropdown-2').classList.toggle('hidden');
    });
</script>

<script src="{% static 'js/scripts.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
</body>
</html>