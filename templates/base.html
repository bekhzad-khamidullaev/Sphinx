{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}" style="height: 100vh;">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="shortcut icon" href="{% static 'img/fav.png' %}" type="image/x-icon">
    <!-- TailwindCSS (using Play CDN for simplicity, consider JIT in production) -->
    <script src="https://cdn.tailwindcss.com/"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
          integrity="sha512-z3gLpd7yknf1YoNbCzqRKc4qyor8gaKU1qmn+CShxbuBusANI9QpRohGBreCFkKxLhei6S9CQXFEbbKuqLg0DA=="
          crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- HTMX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.9/htmx.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/htmx/1.9.9/ext/ws.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Alpine.js -->
    <script src="https://unpkg.com/alpinejs@3.14.9/dist/cdn.min.js" defer></script> <!-- defer is important for Alpine -->

    <!-- Apple-Inspired Styles -->
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .cupertino-shadow {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        /* Preloader Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            transition: opacity 0.5s ease; /* Smooth fade-out */
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3498db; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <title>{% block title %}{% endblock %}</title>
</head>
<body class="bg-gray-50 text-gray-900" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>

<!-- Preloader -->
<div id="preloader">
    <div class="spinner"></div>
</div>

{% if user.is_authenticated %}
<!-- Navbar -->
<header class="fixed w-full top-0 z-50 flex items-center bg-white/60 backdrop-blur-lg px-4 py-3 shadow-md">
    <div class="flex-none w-48 flex items-center">
        <a href="/" class="flex items-center">
            <img src="{% static 'img/logo.png' %}" class="w-9">
            <strong class="ml-2 text-teal-600 text-lg font-semibold">Sphinx</strong>
        </a>
    </div>

     <!-- Dropdown Задачи -->
    <div class="relative mx-4" x-data="{ open: false }">
        <button @click="open = !open" id="tasksDropdown" class="flex items-center bg-white px-4 py-2 rounded-full shadow hover:bg-gray-100 transition-all duration-200">
            {% trans 'Задачи' %}
            <i class="fas fa-chevron-down ml-2 text-sm"></i>
        </button>
        <div x-show="open" @click.outside="open = false" id="tasksMenu" class="absolute left-0 mt-2 w-56 bg-white shadow-xl rounded-2xl overflow-hidden transition-opacity duration-300" x-cloak>
            <ul class="py-2">
                <li><a href="{% url 'tasks:category_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Категории' %}</a></li>
                <li><a href="{% url 'tasks:task_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Список задач' %}</a></li>
                <li><a href="{% url 'tasks:campaign_list' %}" class="block px-4 py-2 hover:bg-gray-100 transition-all">{% trans 'Кампании' %}</a></li>
            </ul>
        </div>
    </div>


    <div class="flex-1 flex justify-center">{% block list_actions %}{% endblock %}</div>

    <!-- User Menu -->
    <div class="relative" x-data="{ open: false }">
        <button @click="open = !open" id="userMenuBtn" class="flex items-center px-4 py-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-all">
            <img class="w-8 h-8 rounded-full object-cover" src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}">
            <span class="ml-2 text-gray-800">{{ user.get_full_name }}</span>
        </button>
        <div x-show="open" @click.outside="open = false" id="userMenu" class="absolute right-0 mt-2 w-48 bg-white shadow-xl rounded-xl  transition-opacity duration-300" x-cloak>
            <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-t-lg">{% trans 'Мой профиль' %}</a>
            <a href="#" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">{% trans 'Входящие' %}</a>
            {% if user.is_superuser %}
            <a href="/admin/" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">{% trans 'Админка' %}</a>
            {% endif %}
            <a href="{% url 'room:rooms' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">{% trans 'Чаты' %}</a>
            <hr class="my-1">
            <!-- Language Switch -->
            <form method="post" action="{% url 'set_language' %}" class="px-4 py-2">
                {% csrf_token %}
                <select name="language" onchange="this.form.submit()" class="w-full text-gray-800 bg-gray-100 rounded-lg p-2 border">
                    <option value="uz" {% if LANGUAGE_CODE == "uz" %}selected{% endif %}>{% trans 'Uzbek' %}</option>
                    <option value="ru" {% if LANGUAGE_CODE == "ru" %}selected{% endif %}>{% trans 'Русский' %}</option>
                    <option value="en" {% if LANGUAGE_CODE == "en" %}selected{% endif %}>{% trans 'English' %}</option>
                    <option value="fr" {% if LANGUAGE_CODE == "fr" %}selected{% endif %}>{% trans 'Français' %}</option>
                    <option value="es" {% if LANGUAGE_CODE == "es" %}selected{% endif %}>{% trans 'Español' %}</option>
                </select>
            </form>
            <hr class="my-1">
            <a href="{% url 'user_profiles:logout' %}" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 rounded-b-lg">{% trans 'Выход' %}</a>
        </div>
    </div>
</header>

<!-- Content -->
<main class="flex-1 overflow-y-auto pt-16 pb-20">
    {% endif %}
    {% block content %}{% endblock %}
</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-30 hidden flex items-center justify-center" x-data="{ open: false }" @modal-open.window="open = true" @modal-close.window="open = false" x-show="open" x-cloak>
    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full relative">
        <button @click="$dispatch('modal-close')" class="absolute top-2 right-2 text-gray-600 hover:text-gray-800">✖</button>
        <div id="modal-content"></div>
    </div>
</div>

{% else %}
    {% include 'users/login.html' %}
{% endif %}


<footer class="fixed bottom-0 left-0 w-full bg-white/70 backdrop-blur-lg border-t border-gray-300 shadow-lg px-6 py-4 flex flex-col md:flex-row md:items-center md:justify-between rounded-t-2xl">
    <span class="text-sm text-gray-600">
        © <span id="year"></span> <a href="/" class="hover:underline text-teal-600 font-medium">Sphinx™</a>. All Rights Reserved.
    </span>
    <ul class="flex flex-wrap items-center mt-2 md:mt-0 text-sm font-medium text-gray-600">
        {% comment %} <li><a href="#" class="hover:text-teal-600 transition-colors px-2">About</a></li> {% endcomment %}
        <li><a href="https://policies.google.com/privacy?hl=uz" class="hover:text-teal-600 transition-colors px-2">Privacy Policy</a></li>
        {% comment %} <li><a href="#" class="hover:text-teal-600 transition-colors px-2">Licensing</a></li>
        <li><a href="#" class="hover:text-teal-600 transition-colors px-2">Contact</a></li> {% endcomment %}
    </ul>
</footer>

<script>
    document.getElementById("year").textContent = new Date().getFullYear();
</script>



<!-- Script -->
{% block scripts %}{% endblock %}

<!-- Notification and WebSocket -->
<script>
    // WebSocket Connection (for task updates)
    const taskSocket = new WebSocket('ws://' + window.location.host + '/ws/tasks/');

    taskSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
    
        if (data.type === 'status_update') {
            // Обработка обновления статуса задачи
            console.log(`Статус задачи ${data.task_id} изменен на: ${data.new_status}`);
        } else if (data.type === 'error') {
            // Отображение ошибки
            showNotification(data.message, 'error');
        }
    };
    
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.classList.add('fixed', 'bottom-5', 'right-5', 'py-2', 'px-4', 'rounded', 'shadow-lg', 'z-50', 'transition-opacity', 'duration-500', 'ease-in-out');
    
        if (type === 'error') {
            notification.classList.add('bg-red-500', 'text-white');
        } else {
            notification.classList.add('bg-blue-500', 'text-white');
        }
    
        notification.textContent = message;
        document.body.appendChild(notification);
    
        // Удаляем уведомление через 5 секунд
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === "modal-content") {
            openModal(); // ✅ Теперь точно откроется модалка!
        }
    });
    
    function closeModal() {
        let modal = document.getElementById("modal");
        if (modal) {
            modal.classList.add("hidden");
            let modalContent = document.getElementById("modal-content");
            if (modalContent) {
                modalContent.innerHTML = ''; // Очищаем содержимое
            }
        }
    }
    function openModal() {
        let modal = document.getElementById("modal");
        if (modal) {
            modal.classList.remove("hidden");
            console.log("✅ Modal Opened!");
        } else {
            console.error("❌ Modal NOT FOUND!");
        }
    }

    {% comment %} // HTMX and Modal Handling
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === "modal-content") {
            // Dispatch a custom event to open the modal
            window.dispatchEvent(new CustomEvent('modal-open'));
        }
    }); {% endcomment %}
    
    // Preloader handling
    window.addEventListener('load', function() {
        const preloader = document.getElementById('preloader');
        preloader.style.opacity = '0'; // Fade out
        setTimeout(() => {
            preloader.style.display = 'none'; // Hide completely after fade
        }, 300); // Match the transition duration
    });
</script>
</body>
</html>