{% extends 'list_base.html' %}
{% load i18n app_filters %}

{% block list_title %}
<h2 class="text-3xl font-semibold text-gray-900 sm:text-4xl">
    {% trans '–ó–∞–¥–∞—á–∏' %}
</h2>
{% endblock %}

{% block list_actions %}
<div class="flex space-x-4">
    <button hx-get="{% url 'tasks:task_create' %}"
        hx-target="#modal-content"
        hx-swap="innerHTML"
        hx-on="htmx:afterSwap: openModal()"
        class="px-5 py-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-all">
        ‚ûï {% trans '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É' %}
    </button>

    <button id="toggleViewBtn"
        class="px-5 py-2 rounded-full shadow-md text-sm font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 transition-all">
        üìå {% trans '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥' %}
    </button>
</div>
{% endblock %}

{% block list_content %}
<!-- üìå –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ -->
<div id="task-list" class="overflow-x-auto bg-white shadow-md rounded-xl border border-gray-200 p-4">
    <table class="min-w-full divide-y divide-gray-300">
        <thead>
            <tr class="bg-gray-100">
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase cursor-pointer sort-header" data-column="task_number">
                    üìå {% trans '–ó–∞–¥–∞—á–∞' %}
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase cursor-pointer sort-header" data-column="campaign">
                    üéØ {% trans '–ö–∞–º–ø–∞–Ω–∏—è' %}
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase cursor-pointer sort-header" data-column="status">
                    üö¶ {% trans '–°—Ç–∞—Ç—É—Å' %}
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase cursor-pointer sort-header" data-column="priority">
                    ‚ö° {% trans '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç' %}
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase">
                    ‚úèÔ∏è {% trans '–î–µ–π—Å—Ç–≤–∏—è' %}
                </th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for task in page_obj %}
            <tr id="task-{{ task.pk }}" class="hover:bg-gray-50 transition-all">
                <td class="px-6 py-4 text-sm font-medium text-gray-900">{{ task.task_number }}</td>
                <td class="px-6 py-4 text-sm text-gray-600">{{ task.campaign.name }}</td>
                <td class="px-6 py-4 text-sm">
                    <select class="status-dropdown px-3 py-1 rounded-full text-xs font-medium text-neutral-800 focus:outline-none transition-all" name="status">
                        {% for status, task_list in tasks_by_status.items %}
                        <option value="{{ status }}" {% if task.status == status %}selected{% endif %}>{{ status|capfirst }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td class="px-6 py-4 text-sm text-gray-600">{{ task.get_priority_display }}</td>
                <td class="px-6 py-4 text-sm flex space-x-2">
                    <button hx-get="{% url 'tasks:task_update' task.pk %}"
                        hx-target="#modal-content"
                        hx-headers='{"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"}'
                        class="px-3 py-1 rounded-md text-sm font-medium text-gray-800 bg-white border border-gray-300 hover:bg-gray-100 transition-all">
                        ‚úèÔ∏è {% trans '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' %}
                    </button>
                    <button hx-get="{% url 'tasks:task_delete' task.pk %}"
                        hx-target="#modal-content"
                        class="px-3 py-1 rounded-md text-sm font-medium text-white bg-red-500 hover:bg-red-600 transition-all">
                        ‚ùå {% trans '–£–¥–∞–ª–∏—Ç—å' %}
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="px-6 py-4 text-sm text-gray-500 text-center">
                    {% trans '–ù–µ—Ç –∑–∞–¥–∞—á.' %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="mt-4 flex justify-between items-center">
    <span class="text-sm text-gray-600">{% trans '–°—Ç—Ä–∞–Ω–∏—Ü–∞' %} {{ page_obj.number }} {% trans '–∏–∑' %} {{ page_obj.paginator.num_pages }}</span>
    <div class="flex space-x-2">
        {% if page_obj.has_previous %}
        <a href="?page=1" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md">&laquo; {% trans '–ü–µ—Ä–≤–∞—è' %}</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md">{% trans '–ù–∞–∑–∞–¥' %}</a>
        {% endif %}
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md">{% trans '–í–ø–µ—Ä–µ–¥' %}</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-md">{% trans '–ü–æ—Å–ª–µ–¥–Ω—è—è' %} &raquo;</a>
        {% endif %}
    </div>
</div>


<!-- üìå –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ -->
<div id="kanban-board" class="hidden mt-8 flex justify-between gap-4">
    {% for status, task_list in tasks_by_status.items %}
    <div class="kanban-column w-full p-4 min-h-[300px] max-h-[550px] border-1 border-neutral-600 rounded-xl shadow-md overflow-y-auto" data-status="{{ status }}">
        <h3 class="text-lg font-semibold text-neutral-800 p-2 shadow-md sticky top-0 z-10
        {% if status == 'new' %}bg-neutral-200
        {% elif status == 'in_progress' %}bg-yellow-400
        {% elif status == 'on_hold' %}bg-blue-100
        {% elif status == 'completed' %}bg-green-400
        {% else %}bg-neutral-50 {% endif %}">
        {{ status_mapping|getkey:status }}
        </h3>
        <div class="kanban-tasks space-y-3 min-h-[100px]">
            {% for task in task_list %}
            <div id="task-{{ task.pk }}" class="kanban-task bg-neutral-300 shadow-md rounded-md p-3 cursor-grab" draggable="true" data-task-id="{{ task.pk }}">
                <h4 class="font-medium text-neutral-900">
                    {{ task.campaign.name }} - {{ task.task_number }}</h4>
            </div>
            {% empty %}
            <p class="text-gray-500 text-sm">{% trans '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–º —Å—Ç–∞—Ç—É—Å–µ' %}</p>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const taskList = document.getElementById('task-list');
        const kanbanBoard = document.getElementById('kanban-board');
        const toggleBtn = document.getElementById('toggleViewBtn');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        const savedView = localStorage.getItem('taskView') || 'kanban';
        if (savedView === 'list') {
            taskList.classList.remove('hidden');
            kanbanBoard.classList.add('hidden');
        } else {
            taskList.classList.add('hidden');
            kanbanBoard.classList.remove('hidden');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–≥–æ –≤ localStorage
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function () {
                if (taskList.classList.contains('hidden')) {
                    taskList.classList.remove('hidden');
                    kanbanBoard.classList.add('hidden');
                    localStorage.setItem('taskView', 'list');
                } else {
                    taskList.classList.add('hidden');
                    kanbanBoard.classList.remove('hidden');
                    localStorage.setItem('taskView', 'kanban');
                }
            });
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        document.querySelectorAll('.sort-header').forEach(header => {
            header.addEventListener('click', function () {
                const table = document.querySelector('tbody');
                const rows = Array.from(table.querySelectorAll('tr'));
                const columnIndex = this.cellIndex;
                const order = this.dataset.order = -(this.dataset.order || -1);

                rows.sort((rowA, rowB) => {
                    const cellA = rowA.cells[columnIndex].textContent.trim();
                    const cellB = rowB.cells[columnIndex].textContent.trim();
                    return order * (cellA.localeCompare(cellB));
                });

                rows.forEach(row => table.appendChild(row));
            });
        });

        // WebSocket –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        const socket = new WebSocket('ws://' + window.location.host + '/ws/task_updates/');

        socket.onopen = function () {
            console.log('WebSocket connection established.');
        };

        document.querySelectorAll('.status-dropdown').forEach(select => {
            select.addEventListener('change', function () {
                const taskId = this.closest('tr').id.replace('task-', '');
                const newStatus = this.value;

                if (!newStatus) {
                    alert("–û—à–∏–±–∫–∞: —Å—Ç–∞—Ç—É—Å –Ω–µ –≤—ã–±—Ä–∞–Ω!");
                    return;
                }

                socket.send(JSON.stringify({
                    type: 'status_update',
                    task_id: taskId,
                    status: newStatus
                }));
            });
        });

        socket.onmessage = function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'status_update' && data.success) {
                const taskRow = document.getElementById('task-' + data.task_id);
                if (taskRow) {
                    taskRow.querySelector('.status-dropdown').value = data.new_status;
                }
            }
        };

        socket.onerror = function (error) {
            console.error('WebSocket error: ' + error);
        };

        socket.onclose = function () {
            console.log('WebSocket connection closed.');
        };

        // Drag & Drop –¥–ª—è Kanban
        let draggedTask = null;

        document.querySelectorAll('.kanban-task').forEach(task => {
            task.draggable = true;

            task.addEventListener('dragstart', function () {
                draggedTask = this;
                setTimeout(() => this.classList.add('opacity-50'), 0);
            });

            task.addEventListener('dragend', function () {
                this.classList.remove('opacity-50');
                draggedTask = null;
            });
        });

        document.querySelectorAll('.kanban-column').forEach(column => {
            column.addEventListener('dragover', function (e) {
                e.preventDefault();
            });

            column.addEventListener('drop', function (e) {
                e.preventDefault();
                if (draggedTask) {
                    const taskId = draggedTask.getAttribute('data-task-id');
                    const newStatus = this.getAttribute('data-status');
                    this.querySelector('.kanban-tasks').appendChild(draggedTask);

                    socket.send(JSON.stringify({
                        type: 'status_update',
                        task_id: taskId,
                        status: newStatus
                    }));
                }
            });
        });
    });
</script>
{% endblock %}