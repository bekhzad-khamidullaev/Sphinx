{% extends 'base.html' %}
{% load static i18n app_filters widget_tweaks %}

{% block title %}{{ page_title|default:_("Задачи") }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {# Подключаем стили для Select2 и Flatpickr, если фильтр их использует #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    {{ filterset.form.media.css }} {# Медиа формы фильтра #}
    {# Стили для drag-and-drop (если используются кастомные) #}
    <style>
        .kanban-tasks.sortable-ghost { background-color: rgba(79, 70, 229, 0.1); border: 2px dashed rgba(79, 70, 229, 0.5); }
        .kanban-task.sortable-drag { opacity: 0.7; transform: rotate(1deg); }
        .kanban-column-wrapper.hidden-column { display: none; }
    </style>
{% endblock %}


{% block list_title %}
<div class="flex items-center justify-between flex-wrap gap-4">
    <h1 class="text-3xl font-semibold text-gray-900 dark:text-gray-100 sm:text-4xl">
        {{ page_title }}
    </h1>
    {# Действия для Desktop #}
    <div class="hidden sm:flex items-center space-x-3">
        {% include "tasks/includes/task_list_actions_desktop.html" %}
    </div>
</div>
{% endblock %}

{% block list_actions_mobile %}
    {# Действия для Mobile #}
    <div class="flex sm:hidden space-x-3 w-full">
         {% include "tasks/includes/task_list_actions_mobile.html" %}
    </div>
{% endblock %}

{% block list_content %}
{# --- Форма Фильтра --- #}
<div x-data="{ open: false }" class="mb-6">
    <button @click="open = !open" type="button" class="flex items-center justify-between w-full px-4 py-2 text-sm font-medium text-left text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 focus:outline-none focus-visible:ring focus-visible:ring-purple-500 focus-visible:ring-opacity-75 dark:bg-dark-700 dark:text-gray-300 dark:hover:bg-dark-600">
         <span>
            <i class="fas fa-filter mr-2"></i> {% trans "Фильтры и Поиск" %}
            <span class="ml-2 px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 text-xs dark:bg-blue-900/50 dark:text-blue-200">{{ request.GET|length }}</span> {# Показывает количество активных фильтров #}
        </span>
        <i class="fas" :class="{ 'fa-chevron-down': !open, 'fa-chevron-up': open }"></i>
    </button>
    <div x-show="open" x-transition class="mt-2 p-4 bg-gray-50 dark:bg-dark-700 rounded-lg border dark:border-dark-600 shadow-inner">
        <form method="get" action="" id="task-filter-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 items-end">
            {# Рендерим каждое поле фильтра #}
            <div class="lg:col-span-2">{% include "includes/filter_field.html" with field=filterset.form.q %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.project %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.status %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.priority %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.responsible %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.executor %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.created_by %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.deadline_after %}</div>
            <div>{% include "includes/filter_field.html" with field=filterset.form.deadline_before %}</div>
            {# Другие поля фильтра... #}
            {# <div>{% include "includes/filter_field.html" with field=filterset.form.category %}</div> #}
            {# <div>{% include "includes/filter_field.html" with field=filterset.form.subcategory %}</div> #}

            {# Кнопки управления фильтром #}
            <div class="lg:col-span-4 flex justify-end space-x-2 mt-2">
                <button type="submit" class="px-4 py-2 rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 dark:bg-ios-blue dark:hover:bg-blue-500 shadow-sm inline-flex items-center">
                    <i class="fas fa-search mr-1"></i> {% trans 'Найти' %}
                </button>
                <a href="{% url 'tasks:task_list' %}" class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-600 border border-gray-300 dark:border-dark-500 hover:bg-gray-100 dark:hover:bg-dark-500 shadow-sm inline-flex items-center">
                     <i class="fas fa-eraser mr-1"></i> {% trans 'Сбросить' %}
                </a>
            </div>
        </form>
    </div>
</div>
{# --- Конец Формы Фильтра --- #}


{# Контейнер для переключения видов #}
<div id="task-view-container">
    {# Канбан-доска (включена через include) #}
    {% include 'includes/kanban_board.html' %}

    {# Таблица задач (включена через include) #}
    {% include 'includes/task_list_table.html' with tasks_list=tasks page_obj=page_obj status_choices=status_mapping_json status_mapping=status_mapping current_sort=current_sort is_paginated=is_paginated %}

    {# Пагинация (отображается только для вида "Список" через JS) #}
    {% if is_paginated %}
    <div id="pagination-container" class="mt-6 hidden"> {# Скрыт по умолчанию #}
        {% include "includes/pagination.html" with page_obj=page_obj %}
    </div>
    {% endif %}
</div> {# Конец task-view-container #}

{# Скрытые данные для JS #}
<div id="task-list-data" class="hidden"
     data-ws-url="{% url 'ws:tasks_list' %}" {# Пример URL для WebSocket #}
     data-update-status-url-template="{% url 'tasks:ajax_update_task_status' task_id=0 %}">
</div>
<script id="status-mapping-script-data" type="application/json">
    {{ status_mapping_json|safe }}
</script>
 <script id="status-choices-script-data" type="application/json">
     {{ status_choices_for_kanban|json_script:"status-choices-payload" }}
 </script>

{% endblock %}

{% block scripts %}
{{ block.super }}
{# Зависимости #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>
{# SortableJS для Drag-and-Drop #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
{# Медиа формы фильтра #}
{{ filterset.form.media.js }}
{# Основной JS для страницы списка задач #}
<script src="{% static 'js/task_list_manager.js' %}" defer></script> {# Вынесен в отдельный файл #}
{% endblock %}