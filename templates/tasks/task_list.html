{% extends 'list_base.html' %}
{% load i18n app_filters %}

{% block list_title %}
<h2 class="text-3xl font-semibold text-gray-900 sm:text-4xl">
    {% trans '–ó–∞–¥–∞—á–∏' %}
</h2>
{% endblock %}

{% block list_actions %}
<div class="flex space-x-4">
    <button hx-get="{% url 'tasks:task_create' %}"
        hx-target="#modal-content"
        hx-swap="innerHTML"
        class="px-5 py-2 rounded-full bg-blue-500 text-white hover:bg-blue-600 transition-all">
        ‚ûï {% trans '–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É' %}
    </button>

    <button id="toggleViewBtn"
        class="px-5 py-2 rounded-full shadow-md text-sm font-medium text-gray-800 bg-gray-100 hover:bg-gray-200 transition-all">
        üìå {% trans '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥' %}
    </button>
    
</div>
{% endblock %}

{% block list_content %}
<!-- üìå –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ -->
<div id="task-list" class="overflow-x-auto bg-white shadow-md rounded-xl border border-gray-200 p-3 {% if view_type == 'kanban' %}hidden{% endif %}">
    <table class="min-w-full divide-y divide-gray-300 text-sm">
        <thead>
            <tr class="bg-gray-100 text-xs text-gray-700 uppercase">
                <th class="px-4 py-2 text-left cursor-pointer sort-header" data-column="task_number">üìå {% trans '–ó–∞–¥–∞—á–∞' %}</th>
                <th class="px-4 py-2 text-left cursor-pointer sort-header" data-column="campaign">üéØ {% trans '–ö–∞–º–ø–∞–Ω–∏—è' %}</th>
                <th class="px-4 py-2 text-left cursor-pointer sort-header" data-column="status">üö¶ {% trans '–°—Ç–∞—Ç—É—Å' %}</th>
                <th class="px-4 py-2 text-left cursor-pointer sort-header" data-column="priority">‚ö° {% trans '–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç' %}</th>
                <th class="px-4 py-2 text-left">‚úèÔ∏è {% trans '–î–µ–π—Å—Ç–≤–∏—è' %}</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
            {% for task in page_obj %}
            <tr id="task-{{ task.pk }}" class="hover:bg-gray-50 transition-all">
                <td class="px-4 py-2 text-gray-900 whitespace-nowrap">{{ task.task_number }}</td>
                <td class="px-4 py-2 text-gray-600 whitespace-nowrap">{{ task.campaign.name }}</td>
                <td class="px-4 py-2">
                    <select class="status-dropdown px-2 py-0.5 rounded-md text-xs font-medium bg-gray-100 focus:outline-none transition-all" name="status" hx-swap="none">
                        {% for status, task_list in tasks_by_status.items %}
                        <option value="{{ status }}" {% if task.status == status %}selected{% endif %}>{% trans status|capfirst %}</option>
                        {% endfor %}
                    </select>
                </td>
                <td class="px-4 py-2 text-gray-600 whitespace-nowrap">{{ task.get_priority_display }}</td>
                <td class="px-4 py-2 flex space-x-1">
                    <button hx-get="{% url 'tasks:task_update' task.pk %}"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        class="px-2 py-1 rounded-md text-xs text-gray-800 bg-gray-200 hover:bg-gray-300 transition-all">
                        ‚úèÔ∏è
                    </button>
                    <button hx-get="{% url 'tasks:task_delete' task.pk %}"
                        hx-target="#modal-content"
                        hx-swap="innerHTML"
                        class="px-2 py-1 rounded-md text-xs text-white bg-red-500 hover:bg-red-600 transition-all">
                        ‚ùå
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="px-4 py-2 text-center text-gray-500">{% trans '–ù–µ—Ç –∑–∞–¥–∞—á.' %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    <div id="pagination" class="mt-4 flex justify-between items-center">
        <span class="text-sm text-gray-600">
            {% trans '–°—Ç—Ä–∞–Ω–∏—Ü–∞' %} {{ page_obj.number }} {% trans '–∏–∑' %} {{ page_obj.paginator.num_pages }}
        </span>
        <div class="flex space-x-1">
            {% if page_obj.has_previous %}
                <a href="?page=1" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg text-sm">¬´</a>
                <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg text-sm">‚Äπ</a>
            {% endif %}
            <span class="px-3 py-1 bg-gray-300 text-gray-900 rounded-lg text-sm">
                {{ page_obj.number }}
            </span>
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg text-sm">‚Ä∫</a>
                <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 bg-gray-200 text-gray-800 rounded-lg text-sm">¬ª</a>
            {% endif %}
        </div>
    </div>

<!-- üìå –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ -->
<div id="kanban-board" class="mt-8 flex justify-between gap-4 {% if view_type == 'list' %}hidden{% endif %}">
    {% for status, task_list in tasks_by_status.items %}
        <!-- Added a wrapping div for padding -->
    <div class="kanban-column-wrapper w-full">
     <div class="kanban-column w-full  min-h-[300px] max-h-[550px] border-1 border-neutral-600 rounded-xl shadow-md overflow-y-auto" data-status="{{ status }}">
        <h3 class="text-lg font-semibold text-neutral-800 p-2 shadow-md sticky top-0 z-10
        {% if status == 'new' %}bg-neutral-200
        {% elif status == 'in_progress' %}bg-yellow-400
        {% elif status == 'on_hold' %}bg-blue-100
        {% elif status == 'completed' %}bg-green-400
        {% else %}bg-neutral-50 {% endif %}">
        {{ status_mapping|getkey:status }}
        </h3>

        <div class="kanban-tasks space-y-3 min-h-[100px] p-2">
            {% for task in task_list %}
            <div id="task-{{ task.pk }}" class="kanban-task bg-neutral-300 shadow-md rounded-md p-3 cursor-grab" draggable="true" data-task-id="{{ task.pk }}">
                <h4 class="font-medium text-neutral-900">
                    {{ task.campaign.name }} - {{ task.task_number }}</h4>
           </div>
            {% empty %}
            <p class="text-gray-500 text-sm">{% trans '–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–º —Å—Ç–∞—Ç—É—Å–µ' %}</p>
            {% endfor %}
        </div>
    </div>
    </div>
    {% endfor %}
</div>
   <div id="loading-indicator" class="hidden fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
        <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-blue-500"></div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskList = document.getElementById('task-list');
    const kanbanBoard = document.getElementById('kanban-board');
    const toggleBtn = document.getElementById('toggleViewBtn');
    const pagination = document.getElementById('pagination'); // Get pagination element

    // Load saved view or default to Kanban
    let currentView = localStorage.getItem('taskView') || 'kanban';
    setView(currentView);

    // Toggle view
    toggleBtn.addEventListener('click', function() {
        currentView = (currentView === 'list') ? 'kanban' : 'list';
        setView(currentView);
        localStorage.setItem('taskView', currentView);
        // Reload the page with the new view type
        window.location.href = `?view=${currentView}`;
    });

  function setView(view) {
    if (view === 'list') {
        taskList.classList.remove('hidden');
        kanbanBoard.classList.add('hidden');
        if (pagination) pagination.classList.remove('hidden'); // Show pagination
    } else {
        taskList.classList.add('hidden');
        kanbanBoard.classList.remove('hidden');
        if (pagination) pagination.classList.add('hidden');   // Hide pagination
    }
}


    // Sorting (client-side)
     document.querySelectorAll('.sort-header').forEach(header => {
        header.addEventListener('click', function() {
            const table = this.closest('table'); // Get the closest table
            const tbody = table.querySelector('tbody'); // Get its tbody
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const columnIndex = this.cellIndex;
            const order = this.dataset.order = -(this.dataset.order || -1);

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].textContent.trim();
                const cellB = rowB.cells[columnIndex].textContent.trim();
                return order * cellA.localeCompare(cellB, undefined, { numeric: true });
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });


    // WebSocket setup
    const socket = new WebSocket('ws://' + window.location.host + '/ws/task_updates/');

    function connectWebSocket() {
        socket.onopen = function() {
            console.log('WebSocket connection established.');
        };

        socket.onerror = function(error) {
            console.error('WebSocket error: ', error);
            document.getElementById('loading-indicator').classList.add('hidden');
            showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.', 'error');
        };
        
        socket.onclose = function() {
            console.log('WebSocket connection closed.');
            showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...', 'error');
            setTimeout(connectWebSocket, 5000);
        };        
    }

    connectWebSocket();

    socket.onopen = function() {
        console.log('WebSocket connection established.');
    };

    // Status dropdown change handler
    document.querySelectorAll('.status-dropdown').forEach(select => {
        let previousStatus = select.value; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    
        select.addEventListener('change', function() {
            const taskId = this.closest('tr').id.replace('task-', '');
            const newStatus = this.value;
    
            if (!newStatus) {
                showNotification("–û—à–∏–±–∫–∞: —Å—Ç–∞—Ç—É—Å –Ω–µ –≤—ã–±—Ä–∞–Ω!", 'error');
                this.value = previousStatus; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                return;
            }
    
            // Show loading indicator
            document.getElementById('loading-indicator').classList.remove('hidden');
    
            socket.send(JSON.stringify({
                type: 'status_update',
                task_id: taskId,
                status: newStatus
            }));
    
            previousStatus = newStatus; // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        });
    });


    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.type === 'status_update') {
            if (data.success) {
                // Find the task by ID in *both* the list and Kanban views
                const taskRowList = document.querySelector(`#task-list #task-${data.task_id}`);
                const taskDivKanban = document.querySelector(`#kanban-board #task-${data.task_id}`);

                if (taskRowList) {
                    taskRowList.querySelector('.status-dropdown').value = data.new_status;
                }

                if (taskDivKanban) {
                    // Move the Kanban card to the correct column
                    const targetColumn = document.querySelector(`.kanban-column[data-status="${data.new_status}"] .kanban-tasks`);
                    if (targetColumn) {
                         targetColumn.appendChild(taskDivKanban);
                    }
                }
                // Hide loading indicator after successful update
                 document.getElementById('loading-indicator').classList.add('hidden');

            } else {
                console.error("Status update failed:", data.message);
                // Hide loading indicator on failure
                document.getElementById('loading-indicator').classList.add('hidden');
                 // Revert the dropdown to the previous value (you'd need to store the old value)
                // select.value = previousStatus; //  Implement this
                alert(data.message); // Show an error to the user.
            }
        }
    };


    socket.onerror = function(error) {
        console.error('WebSocket error: ', error);
         document.getElementById('loading-indicator').classList.add('hidden');
    };

    socket.onclose = function() {
        console.log('WebSocket connection closed.');
    };


    // Drag & Drop for Kanban
    let draggedTask = null;

    function handleDragStart() {
        draggedTask = this;
        setTimeout(() => this.classList.add('opacity-50'), 0);  // Slightly transparent
    }

    function handleDragEnd() {
        this.classList.remove('opacity-50');
        draggedTask = null;
    }

    function handleDragOver(e) {
        e.preventDefault();
        this.classList.add('bg-gray-100'); // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
    }
    
    function handleDragLeave() {
        this.classList.remove('bg-gray-100'); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
    }
    
    function handleDrop() {
        this.classList.remove('bg-gray-100'); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
        if (draggedTask) {
            const taskId = draggedTask.getAttribute('data-task-id');
            const newStatus = this.closest('.kanban-column').getAttribute('data-status');
            this.querySelector('.kanban-tasks').appendChild(draggedTask);
    
            socket.send(JSON.stringify({
                type: 'status_update',
                task_id: taskId,
                status: newStatus
            }));
        }
    }
    function showNotification(message, type = 'info') {
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('fixed', 'top-5', 'right-5', 'bg-white', 'shadow-lg', 'rounded-md', 'p-4', 'border-l-4', 'text-sm', 'transition-all', 'duration-300');
    
        if (type === 'error') {
            messageContainer.classList.add('border-red-500', 'text-red-700', 'bg-red-50');
        } else if (type === 'success') {
            messageContainer.classList.add('border-green-500', 'text-green-700', 'bg-green-50');
        } else {
            messageContainer.classList.add('border-gray-500', 'text-gray-700', 'bg-gray-50');
        }
    
        messageContainer.textContent = message;
        document.body.appendChild(messageContainer);
    
        setTimeout(() => {
            messageContainer.classList.add('opacity-0');
            setTimeout(() => messageContainer.remove(), 500);
        }, 3000);
    }
    

   function handleDrop() {
        if (draggedTask) {
            const taskId = draggedTask.getAttribute('data-task-id');
            const newStatus = this.closest('.kanban-column').getAttribute('data-status');  // Get status from the column
            this.querySelector('.kanban-tasks').appendChild(draggedTask); // Move the element *first*

            // Then send the update via WebSocket:
            socket.send(JSON.stringify({
                type: 'status_update',
                task_id: taskId,
                status: newStatus
            }));
        }
    }


    document.querySelectorAll('.kanban-task').forEach(task => {
        task.addEventListener('dragstart', handleDragStart);
        task.addEventListener('dragend', handleDragEnd);
    });

    document.querySelectorAll('.kanban-column').forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('drop', handleDrop);
    });
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function saveSortState(columnIndex, order) {
        localStorage.setItem('sortColumn', columnIndex);
        localStorage.setItem('sortOrder', order);
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    function restoreSortState() {
        const columnIndex = localStorage.getItem('sortColumn');
        const order = localStorage.getItem('sortOrder');
        if (columnIndex !== null && order !== null) {
            const header = document.querySelector(`.sort-header[data-column="${columnIndex}"]`);
            if (header) {
                header.dataset.order = order;
                header.click(); // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            }
        }
    }

    // –í—ã–∑–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        restoreSortState();
    });

});
</script>
{% endblock %}