{% extends 'base.html' %}
{% load static i18n app_filters crispy_forms_tags %}

{% block title %}{% trans 'Задачи' %}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {% if filterset %}{{ filterset.form.media.css }}{% endif %}
    <style>
        .sort-header[aria-sort="ascending"] .fa-sort::before { content: "\f0de"; }
        .sort-header[aria-sort="descending"] .fa-sort::before { content: "\f0dd"; }
        .sort-header[aria-sort="none"] .fa-sort { opacity: 0.3; }
        .sort-header:hover .fa-sort { opacity: 0.7; }
    </style>
{% endblock %}


{% block list_title %}
<h1 class="text-3xl font-semibold text-gray-900 dark:text-gray-100 sm:text-4xl">
    {% trans 'Задачи' %}
</h1>
{% endblock %}

{% block list_actions %}
<div class="flex items-center ml-4 space-x-3">

    <div class="inline-flex rounded-md shadow-xs" role="group">
        <a href="{% url 'tasks:task_create' %}"
           class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-s-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white transition-colors duration-150">
            <i class="fas fa-plus mr-2 text-blue-500 dark:text-ios-blue"></i> {% trans 'Создать задачу' %}
        </a>
        <button type="button" id="toggleViewBtn"
           class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-r border-gray-200 rounded-e-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700 dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:text-white dark:hover:bg-gray-700 dark:focus:ring-blue-500 dark:focus:text-white transition-colors duration-150"
           aria-pressed="false" data-kanban-text="{% trans 'Канбан' %}" data-list-text="{% trans 'Список' %}">
             <i id="viewIcon" class="fas fa-columns mr-2"></i>
             <span id="viewText">{% trans 'Вид' %}</span>
        </button>
    </div>
     <div id="column-toggle-dropdown" class="relative hidden ml-3">
        <button id="dropdownCheckboxButton" data-dropdown-toggle="dropdownColumnCheckbox"
           class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center inline-flex items-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800" type="button">
            <i class="fas fa-columns mr-2"></i> {% trans 'Колонки' %}
            <svg class="w-2.5 h-2.5 ms-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
            </svg>
        </button>
        <div id="dropdownColumnCheckbox" class="z-50 hidden w-48 bg-white divide-y divide-gray-100 rounded-lg shadow dark:bg-gray-700 dark:divide-gray-600 border dark:border-gray-600">
             <ul class="p-3 space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownCheckboxButton">
                <li><button type="button" id="resetHiddenColumnsBtn" class="flex items-center w-full text-left text-blue-600 dark:text-blue-400 hover:underline focus:outline-none"><i class="fas fa-eye mr-2"></i> {% trans 'Показать все' %}</button></li>
                <hr class="border-gray-200 dark:border-gray-600 !my-2">
                {% for status, _ in status_mapping.items %}
                {% with status_display_name=status_mapping|getkey:status %}<li><div class="flex items-center"><input id="checkbox-column-{{ status }}" type="checkbox" value="{{ status }}" class="toggle-column-checkbox w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-700 dark:focus:ring-offset-gray-700 focus:ring-2 dark:bg-gray-600 dark:border-gray-500" data-status="{{ status }}" checked><label for="checkbox-column-{{ status }}" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300 cursor-pointer">{{ status_display_name|default:status }}</label></div></li>{% endwith %}{% endfor %}
             </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block list_actions_mobile %}
<a href="{% url 'tasks:task_create' %}"
    class="flex-1 flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium bg-blue-500 dark:bg-ios-blue text-white hover:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-dark-950 transition-all shadow">
    <i class="fas fa-plus mr-2"></i> {% trans 'Создать задачу' %}
</a>
<button type="button" id="toggleViewBtnMobile"
    class="flex-1 flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-dark-700 hover:bg-gray-200 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 dark:focus:ring-offset-dark-950 transition-all shadow"
    aria-pressed="false" data-kanban-text="{% trans 'Канбан' %}" data-list-text="{% trans 'Список' %}">
    <i id="viewIconMobile" class="fas fa-columns mr-2"></i>
    <span id="viewTextMobile">{% trans 'Вид' %}</span>
</button>
<button type="button" data-drawer-target="filter-drawer" data-drawer-show="filter-drawer" data-drawer-placement="right" aria-controls="filter-drawer"
   class="flex-1 flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium text-gray-800 dark:text-gray-200 bg-gray-100 dark:bg-dark-700 hover:bg-gray-200 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 dark:focus:ring-offset-dark-950 transition-all shadow">
    <i class="fas fa-filter mr-2"></i> {% trans 'Фильтр' %}
</button>
{% endblock %}

{% block list_content %}

<div id="filter-section" class="mb-6 hidden md:block" x-data="{ open: new URLSearchParams(window.location.search).has('q') || new URLSearchParams(window.location.search).has('status') }" x-cloak>
    <button @click="open = !open" type="button" class="w-full flex justify-between items-center px-4 py-2 text-sm font-medium text-left text-gray-700 bg-white dark:bg-dark-800 border border-b-0 border-gray-200 dark:border-dark-700 rounded-t-lg hover:bg-gray-50 dark:hover:bg-dark-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <span><i class="fas fa-filter mr-2"></i> {% trans 'Фильтры и Поиск' %}</span>
        <i class="fas transition-transform duration-200" :class="{ 'fa-chevron-down': !open, 'fa-chevron-up': open }"></i>
    </button>
    <div x-show="open" x-transition class="border border-gray-200 dark:border-dark-700 p-4 bg-white dark:bg-dark-800 rounded-b-lg shadow">
        {% if filterset %}
        <form method="get" action="" id="filter-form" class="space-y-4">
            {% for key, value in request.GET.items %}
                {% if key != 'page' and key not in filterset.form.fields %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <input type="hidden" name="view" value="list">

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                 {% for field in filterset.form %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{ field.label }}</label>
                        {{ field|add_css_class:"form-input block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm" }}
                        {% if field.help_text %}<p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>{% endif %}
                        {% if field.errors %}<p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>{% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="mt-4 flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-dark-600">
                <a href="{{ request.path }}{% if request.GET.view %}?view={{ request.GET.view }}{% endif %}" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">{% trans "Сбросить" %}</a>
                <button type="submit" class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-search mr-2"></i> {% trans "Применить" %}
                </button>
            </div>
        </form>
        {% else %}
            <p class="text-gray-500 italic">{% trans "Фильтры недоступны." %}</p>
        {% endif %}
    </div>
</div>

<div id="filter-drawer" class="fixed top-0 right-0 z-50 h-screen p-4 overflow-y-auto transition-transform translate-x-full bg-white w-80 dark:bg-gray-800" tabindex="-1" aria-labelledby="filter-drawer-label">
    <h5 id="filter-drawer-label" class="inline-flex items-center mb-4 text-base font-semibold text-gray-500 dark:text-gray-400"><i class="fas fa-filter mr-2"></i>{% trans 'Фильтр Задач' %}</h5>
    <button type="button" data-drawer-hide="filter-drawer" aria-controls="filter-drawer" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 inline-flex items-center justify-center dark:hover:bg-gray-600 dark:hover:text-white" >
       <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
       <span class="sr-only">{% trans "Закрыть меню" %}</span>
    </button>
    {% if filterset %}
    <form method="get" action="" id="filter-form-mobile" class="space-y-4">
        {% for key, value in request.GET.items %}
             {% if key != 'page' and key not in filterset.form.fields %}
                <input type="hidden" name="{{ key }}" value="{{ value }}">
             {% endif %}
        {% endfor %}
         {% for field in filterset.form %}
            <div>
                <label for="{{ field.id_for_label }}_mobile" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">{{ field.label }}</label>
                {{ field|add_css_class:"form-input block w-full text-sm dark:bg-dark-700 dark:border-dark-600 rounded-md shadow-sm"|attr:"id:"|add:field.id_for_label|add:"_mobile" }}
                {% if field.help_text %}<p class="text-xs text-gray-500 mt-1">{{ field.help_text }}</p>{% endif %}
                {% if field.errors %}<p class="text-xs text-red-500 mt-1">{{ field.errors.0 }}</p>{% endif %}
            </div>
        {% endfor %}
        <div class="grid grid-cols-2 gap-4 pt-4">
             <a href="{{ request.path }}{% if request.GET.view %}?view={{ request.GET.view }}{% endif %}" class="w-full inline-flex justify-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">{% trans 'Сбросить' %}</a>
             <button type="submit" class="w-full inline-flex justify-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">{% trans 'Применить' %}</button>
        </div>
    </form>
    {% endif %}
 </div>


{% get_current_language as LANGUAGE_CODE %}
{% with ajax_base_url="/"|add:LANGUAGE_CODE|add:"/core/ajax/tasks/" %}

    {% include 'includes/kanban_board.html' %}

    {% include 'includes/task_list_table.html' %}

{% endwith %}

{% if page_obj and page_obj.paginator.num_pages > 1 %}
<div id="pagination" class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 text-sm hidden">
    {% include "includes/pagination.html" with page_obj=page_obj query_params=request.GET.urlencode %}
</div>
{% endif %}

<script id="status-mapping-data" type="application/json">
    {{ status_mapping|json_script:"status-mapping-data-payload" }}
</script>

{% endblock %}

{% block scripts %}
{{ block.super }}
{% if filterset %}{{ filterset.form.media.js }}{% endif %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" defer></script>
<script src="{% static 'js/tasks_no_modal.js' %}" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterBtn = document.getElementById('toggleFilterBtn');
    const filterSection = document.getElementById('filter-section');
    const filterArrow = document.getElementById('filter-arrow');

    if (filterBtn && filterSection && filterArrow) {
        const params = new URLSearchParams(window.location.search);
        let filtersActive = false;
        for (const [key, value] of params.entries()) {
            if (key !== 'page' && key !== 'view' && value) {
                filtersActive = true;
                break;
            }
        }

        const filterState = sessionStorage.getItem('filterSectionOpen');

        if (filterState === 'true' || (filterState === null && filtersActive)) { // Open if saved open OR initially active and not explicitly closed
            filterSection.classList.remove('hidden');
            filterBtn.setAttribute('aria-expanded', 'true');
            filterArrow.classList.remove('fa-chevron-down');
            filterArrow.classList.add('fa-chevron-up');
             if(window.Alpine) { // Update Alpine state if used
                Alpine.store('filterOpen', true);
             }
        } else {
             filterSection.classList.add('hidden');
             filterBtn.setAttribute('aria-expanded', 'false');
             filterArrow.classList.add('fa-chevron-down');
             filterArrow.classList.remove('fa-chevron-up');
             if(window.Alpine) {
                 Alpine.store('filterOpen', false);
             }
        }


        filterBtn.addEventListener('click', () => {
            const isHidden = filterSection.classList.toggle('hidden');
            filterBtn.setAttribute('aria-expanded', String(!isHidden));
            filterArrow.classList.toggle('fa-chevron-down', isHidden);
            filterArrow.classList.toggle('fa-chevron-up', !isHidden);
            // Save state to session storage
            sessionStorage.setItem('filterSectionOpen', String(!isHidden));
             if(window.Alpine) { // Update Alpine state if used
                Alpine.store('filterOpen', !isHidden);
             }
        });
    }

    // Ensure Flowbite JS initializes drawers if used
    // (Assuming Flowbite is loaded globally or handled elsewhere)
    // Example: initFlowbite();
});
</script>
{% endblock %}