{% extends 'base.html' %}
{% load i18n app_filters static widget_tweaks %}

{% block title %}{{ page_title|default:_("Детали задачи") }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    {# CSS для карусели (если используется Flowbite или аналог) #}
    {# <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" /> #}
    {# CSS формы комментария (если есть специфичные стили) #}
    {{ comment_form.media.css }}
    <style>
        /* Стили для подсветки блока комментария при переходе по якорю */
        :target {
            animation: highlight 1.5s ease-out;
        }
        @keyframes highlight {
            from { background-color: rgba(255, 255, 0, 0.5); }
            to { background-color: transparent; }
        }
        .comment-item:target .dark\:bg-dark-700 {
             animation: highlight-dark 1.5s ease-out;
        }
         @keyframes highlight-dark {
            from { background-color: rgba(79, 70, 229, 0.3); } /* Tailwind indigo-500 with alpha */
            to { background-color: rgb(30 41 59 / var(--tw-bg-opacity)); } /* bg-slate-800 or dark-700 */
        }

    </style>
{% endblock %}

{% block list_title %}
{# Заголовок страницы деталей задачи #}
<div class="flex items-center justify-between flex-wrap gap-4">
    <div>
        <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl flex items-center">
            <span class="text-gray-400 dark:text-gray-500 mr-2">#{{ task.task_number }}</span> {{ task.title }}
        </h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
             {% if task.project %}
                {% blocktrans with project_name=task.project.name project_url=task.project.get_absolute_url %}
                Проект: <a href="{{ project_url }}" class="hover:underline">{{ project_name }}</a>
                {% endblocktrans %}
             {% endif %}
        </p>
    </div>
    {# Кнопки действий #}
    <div class="flex space-x-3 flex-shrink-0">
        {% if can_change_task %}
        <a href="{% url 'tasks:task_update' pk=task.pk %}"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-gray-900 bg-yellow-400 hover:bg-yellow-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 dark:bg-ios-yellow dark:text-black dark:hover:bg-yellow-300 dark:focus:ring-offset-dark-800 transition-all">
            <i class="fas fa-edit mr-2"></i> {% trans 'Редактировать' %}
        </a>
        {% endif %}
        {% if can_delete_task %}
        <a href="{% url 'tasks:task_delete' pk=task.pk %}"
            class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-ios-red dark:hover:bg-red-400 dark:focus:ring-offset-dark-800 transition-all">
            <i class="fas fa-trash mr-2"></i> {% trans 'Удалить' %}
        </a>
        {% endif %}
        <a href="{% url 'tasks:task_list' %}"
            class="inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-dark-600 rounded-full shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:bg-dark-700 dark:text-gray-300 dark:hover:bg-dark-600 dark:focus:ring-offset-dark-800 transition-all">
            <i class="fas fa-arrow-left mr-2"></i> {% trans 'К списку' %}
        </a>
    </div>
</div>
{% endblock %}

{% block list_content %}
{# Основной контейнер контента #}
<div id="task-detail-container"
    class="bg-white dark:bg-dark-800 shadow-lg rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8 mt-6"
    data-task-id="{{ task.pk }}"> {# ID задачи для JS #}

    {# Сетка для основного контента и боковой панели #}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {# Левая (основная) колонка #}
        <div class="lg:col-span-2 space-y-6">
            {# Статус и Приоритет + Кнопки быстрых действий #}
            <div class="flex flex-wrap gap-4 items-center justify-between">
                 <div class="flex flex-wrap gap-4 items-center">
                     <div>
                        <span class="block text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">{% trans 'Статус' %}</span>
                        <span id="task-status-badge"
                            class="status-badge px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full
                            {% if task.status == 'new' %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% elif task.status == 'in_progress' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/80 dark:text-yellow-200{% elif task.status == 'on_hold' %}bg-blue-100 text-blue-800 dark:bg-blue-900/80 dark:text-blue-200{% elif task.status == 'canceled' %}bg-gray-100 text-gray-500 dark:bg-dark-700 dark:text-gray-400 line-through{% elif task.status == 'completed' %}bg-green-100 text-green-800 dark:bg-green-900/80 dark:text-green-200{% elif task.status == 'overdue' %}bg-red-100 text-red-800 dark:bg-red-900/80 dark:text-red-200{% else %}bg-gray-100 text-gray-800 dark:bg-dark-600 dark:text-gray-200{% endif %}">
                            {{ task.get_status_display|default:task.status }}
                        </span>
                     </div>
                     <div>
                         <span class="block text-xs text-gray-500 dark:text-gray-400 uppercase font-semibold mb-1">{% trans 'Приоритет' %}</span>
                         <p class="text-gray-800 dark:text-gray-100 font-medium text-sm">
                             {% with priority_color_class=task.priority|get_priority_tailwind_color %}
                                 <i class="fas fa-flag mr-1 {{ priority_color_class|replace_str:'border-l-4 border-,text-' }}"></i> {{ task.get_priority_display }}
                             {% endwith %}
                         </p>
                     </div>
                 </div>
                 {# Кнопки быстрых действий (если есть права) #}
                  {% if can_change_status %}
                  <div class="flex space-x-2 flex-shrink-0">
                     {% if task.status == task.StatusChoices.NEW or task.status == task.StatusChoices.ON_HOLD %}
                         <a href="{% url 'tasks:task_perform' pk=task.pk %}?action=start_progress" class="px-3 py-1.5 rounded-full text-xs font-medium text-white bg-yellow-500 hover:bg-yellow-600 dark:bg-ios-yellow dark:text-black dark:hover:bg-yellow-400 transition shadow-sm inline-flex items-center" title="{% trans 'Взять в работу' %}">
                             <i class="fas fa-play mr-1"></i> {% trans 'В работу' %}
                         </a>
                     {% endif %}
                     {% if task.status == task.StatusChoices.IN_PROGRESS %}
                         <a href="{% url 'tasks:task_perform' pk=task.pk %}?action=put_on_hold" class="px-3 py-1.5 rounded-full text-xs font-medium text-white bg-blue-500 hover:bg-blue-600 dark:bg-ios-blue dark:hover:bg-blue-400 transition shadow-sm inline-flex items-center" title="{% trans 'Отложить' %}">
                             <i class="fas fa-pause mr-1"></i> {% trans 'Отложить' %}
                         </a>
                         <a href="{% url 'tasks:task_perform' pk=task.pk %}?action=complete" class="px-3 py-1.5 rounded-full text-xs font-medium text-white bg-green-500 hover:bg-green-600 dark:bg-ios-green dark:hover:bg-green-400 transition shadow-sm inline-flex items-center" title="{% trans 'Завершить задачу' %}">
                             <i class="fas fa-check-circle mr-1"></i> {% trans 'Завершить' %}
                         </a>
                     {% endif %}
                      {% if task.status == task.StatusChoices.COMPLETED %}
                          <a href="{% url 'tasks:task_perform' pk=task.pk %}?action=reopen" class="px-3 py-1.5 rounded-full text-xs font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 dark:bg-dark-600 dark:text-gray-300 dark:hover:bg-dark-500 transition shadow-sm inline-flex items-center" title="{% trans 'Вернуть в работу' %}">
                              <i class="fas fa-undo mr-1"></i> {% trans 'В работу' %}
                          </a>
                      {% endif %}
                  </div>
                 {% endif %}
            </div>

            {# Описание #}
            {% if task.description %}
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2 border-b border-gray-200 dark:border-dark-600 pb-2">
                    {% trans 'Описание' %}
                </h3>
                <div class="prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 mt-3">
                    {# Используем safe, если уверены в чистоте HTML, иначе linebreaksbr #}
                    {{ task.description|linebreaksbr }}
                </div>
            </div>
            {% endif %}

            {# Категория/Подкатегория #}
            {% if task.category or task.subcategory %}
            <div>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-2 border-b border-gray-200 dark:border-dark-600 pb-2">
                    {% trans 'Категоризация' %}
                </h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-3">
                    {% if task.category %}
                        {% trans 'Категория:' %}
                        <a href="{{ task.category.get_absolute_url }}" class="font-medium hover:underline">{{ task.category.name }}</a>
                        {% if task.subcategory %} / {% endif %}
                    {% endif %}
                    {% if task.subcategory %}
                        {% trans 'Подкатегория:' %}
                        <a href="{{ task.subcategory.get_absolute_url }}" class="font-medium hover:underline">{{ task.subcategory.name }}</a>
                    {% endif %}
                </p>
            </div>
            {% endif %}

        </div> {# Конец левой колонки #}

        {# Правая колонка: Боковая панель #}
        <aside class="space-y-6 border-t lg:border-t-0 lg:border-l border-gray-200 dark:border-dark-700 pt-6 lg:pt-0 lg:pl-8">
            {# Участники #}
            <div>
                <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-3">
                    <i class="fas fa-users mr-2 text-gray-500 dark:text-gray-400"></i>{% trans 'Участники' %}
                </h3>
                 {% include "tasks/includes/task_participants.html" with responsible_users=responsible_users_list executors=executors_list watchers=watchers_list creator=task.created_by %}
            </div>

            {# Даты #}
            <div>
                <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-3">
                    <i class="far fa-calendar-alt mr-2 text-gray-500 dark:text-gray-400"></i>{% trans 'Сроки и Оценка' %}
                </h3>
                 {% include "tasks/includes/task_dates.html" with task=task %}
            </div>
        </aside> {# Конец правой колонки #}

    </div> {# Конец основной сетки #}

    {# --- Фотографии --- #}
    {% include "tasks/includes/task_photos_section.html" with photos=task.photos.all %}

    {# --- Комментарии --- #}
    {% include "tasks/includes/task_comments_section.html" with comments=comments_list comment_form=comment_form can_add_comment=can_add_comment task=task %}

</div> {# End task-detail-container #}

{# Данные для JS #}
<script id="task-detail-script-data" type="application/json">
    {{ task_detail_json_data|safe }}
</script>
<script id="task-status-choices-data" type="application/json">
    {{ status_choices_json|safe }}
</script>

{% endblock %}

{% block scripts %}
{{ block.super }}
{# JS для карусели (например, Flowbite) #}
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script> #}
{# JS для формы комментария и WebSocket #}
{{ comment_form.media.js }} {# Если форма комментария использует JS #}
<script src="{% static 'js/task_detail.js' %}" defer></script> {# Вынесен в отдельный файл #}
{% endblock %}