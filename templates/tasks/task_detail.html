{% extends 'base.html' %}
{% load i18n app_filters static widget_tweaks %}

{% block title %}{{ task_instance.title }} - {{ task_instance.task_number|default:task_instance.pk }}{% endblock %}

{% block head_extra %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    {% if form.media.css %}{{ form.media.css }}{% endif %}
    {% if photo_formset and photo_formset.media.css %}{{ photo_formset.media.css }}{% endif %}
    <style>
        #comment-list::-webkit-scrollbar {
            width: 6px;
        }
        #comment-list::-webkit-scrollbar-track {
            background: transparent;
        }
        #comment-list::-webkit-scrollbar-thumb {
            background-color: #D1D5DB; /* gray-300 */
            border-radius: 3px;
        }
        #comment-list {
            scrollbar-width: thin;
            scrollbar-color: #D1D5DB transparent; /* gray-300 */
        }
    </style>
{% endblock %}

{% block list_title %}
<div class="d-flex justify-content-between flex-wrap gap-3 align-items-start">
    <div>
        <h1 class="h4 fw-bold d-flex align-items-center">
            <span class="text-muted me-2">#{{ task_instance.task_number|default:task_instance.pk }}</span> {{ task_instance.title }}
        </h1>
        {% if task_instance.project %}
        <p class="text-sm text-gray-500 mt-1">
            {% blocktrans with project_name=task_instance.project.name %}Проект: <a href="{{ task_instance.project.get_absolute_url }}" class="hover:underline">{{ project_name }}</a>{% endblocktrans %}
        </p>
        {% endif %}
    </div>
    <div class="d-flex gap-2 flex-shrink-0">
        {% if perms.tasks.change_task or can_change_task %}
        <a href="{% url 'tasks:task_update' pk=task_instance.pk %}"
            class="btn btn-warning">
            <i class="fas fa-edit mr-2" aria-hidden="true"></i> {% trans 'Редактировать' %}
        </a>
        {% endif %}
        {% if perms.tasks.delete_task or can_delete_task %}
        <a href="{% url 'tasks:task_delete' pk=task_instance.pk %}"
            class="btn btn-danger">
            <i class="fas fa-trash mr-2" aria-hidden="true"></i> {% trans 'Удалить' %}
        </a>
        {% endif %}
        <a href="{{ chat_room_url }}" class="btn btn-primary">
            <i class="fas fa-comments mr-2" aria-hidden="true"></i> {% trans 'Чат' %}
        </a>
        <a href="{% url 'tasks:task_list' %}"
            class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-2" aria-hidden="true"></i> {% trans 'К списку' %}
        </a>
    </div>
</div>
{% endblock %}

{% block list_content %}
<div id="task-detail-container" class="card mt-4" data-task-id="{{ task_instance.pk }}">
    <div class="card-body">
    <div class="row g-4">
        <div class="col-md-8">
        <div class="md:col-span-2 space-y-6">
            <div class="flex flex-wrap gap-4 items-center">
                <div>
                    <span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Статус' %}</span>
                    <span id="task-status-badge" class="status-badge px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full
                        {% if task_instance.status == task_instance.StatusChoices.NEW %}bg-gray-100 text-gray-800
                        {% elif task_instance.status == task_instance.StatusChoices.IN_PROGRESS %}bg-yellow-100 text-yellow-800
                        {% elif task_instance.status == task_instance.StatusChoices.ON_HOLD %}bg-blue-100 text-blue-800
                        {% elif task_instance.status == task_instance.StatusChoices.CANCELLED %}bg-gray-100 text-gray-500 line-through
                        {% elif task_instance.status == task_instance.StatusChoices.COMPLETED %}bg-green-100 text-green-800
                        {% elif task_instance.status == task_instance.StatusChoices.OVERDUE %}bg-red-100 text-red-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ task_instance.status_display }}
                    </span>
                </div>
                <div>
                    <span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Приоритет' %}</span>
                    <p class="text-gray-800 font-medium text-sm">{{ task_instance.priority_display }}</p>
                </div>
            </div>

            {% if task_instance.description %}
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2 border-b border-gray-200 pb-2">{% trans 'Описание' %}</h3>
                <div class="prose prose-sm max-w-none text-gray-700 mt-3">
                    {{ task_instance.description|linebreaksbr }}
                </div>
            </div>
            {% endif %}

            {% if task_instance.category or task_instance.subcategory %}
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2 border-b border-gray-200 pb-2">{% trans 'Категоризация' %}</h3>
                <p class="text-sm text-gray-600 mt-3">
                    {% if task_instance.category %}Категория: <span class="font-medium">{{ task_instance.category.name }}</span>{% if task_instance.subcategory %} / {% endif %}{% endif %}
                    {% if task_instance.subcategory %}Подкатегория: <span class="font-medium">{{ task_instance.subcategory.name }}</span>{% endif %}
                </p>
            </div>
            {% endif %}
        </div>

        <div class="space-y-6 border-t md:border-t-0 md:border-l border-gray-200 pt-6 md:pt-0 md:pl-8">
            <div>
                <h3 class="text-md font-semibold text-gray-800 mb-3"><i class="fas fa-users mr-2 text-gray-500" aria-hidden="true"></i>{% trans 'Участники' %}</h3>
                <ul class="space-y-4">
                    {% with responsible_users=task_instance.get_responsible_users executor_users=task_instance.get_executors watcher_users=task_instance.get_watchers %}
                    {% if responsible_users %}<li><span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Ответственный' %}</span>
                        {% for user in responsible_users %}<div class="flex items-center mt-1"><img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ user.display_name|default:user.username }}" class="w-6 h-6 rounded-full mr-2 flex-shrink-0 object-cover"><span class="text-sm text-gray-700 truncate">{{ user.display_name|default:user.username }}</span></div>{% endfor %}
                    </li>{% endif %}
                    {% if executor_users %}<li><span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Исполнители' %}</span>
                        {% for user in executor_users %}<div class="flex items-center mt-1"><img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ user.display_name|default:user.username }}" class="w-6 h-6 rounded-full mr-2 flex-shrink-0 object-cover"><span class="text-sm text-gray-700 truncate">{{ user.display_name|default:user.username }}</span></div>
                        {% empty %}<span class="text-sm text-gray-400 italic">{% trans 'Не назначены' %}</span>{% endfor %}
                    </li>{% endif %}
                    <li><span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Создатель' %}</span>
                        <div class="flex items-center mt-1">
                        {% if task_instance.created_by %}<img src="{% if task_instance.created_by.image %}{{ task_instance.created_by.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ task_instance.created_by.display_name|default:task_instance.created_by.username }}" class="w-6 h-6 rounded-full mr-2 flex-shrink-0 object-cover"><span class="text-sm text-gray-700 truncate">{{ task_instance.created_by.display_name|default:task_instance.created_by.username }}</span>
                        {% else %}<span class="text-sm text-gray-400 italic">{% trans 'Неизвестен' %}</span>{% endif %}</div>
                    </li>
                    {% if watcher_users %}<li><span class="block text-xs text-gray-500 uppercase font-semibold mb-1">{% trans 'Наблюдатели' %}</span>
                        {% for user in watcher_users %}<div class="flex items-center mt-1"><img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ user.display_name|default:user.username }}" class="w-6 h-6 rounded-full mr-2 flex-shrink-0 object-cover"><span class="text-sm text-gray-700 truncate">{{ user.display_name|default:user.username }}</span></div>{% endfor %}
                    </li>{% endif %}
                    {% endwith %}
                </ul>
            </div>

            <div>
                <h3 class="text-md font-semibold text-gray-800 mb-3"><i class="far fa-calendar-alt mr-2 text-gray-500" aria-hidden="true"></i>{% trans 'Сроки' %}</h3>
                <dl class="space-y-2 text-sm">
                    <div class="flex justify-between"><dt class="text-gray-500">{% trans 'Создана' %}:</dt><dd class="text-gray-700 font-medium">{{ task_instance.created_at|date:"d.m.Y H:i" }}</dd></div>
                    {% if task_instance.start_date %}<div class="flex justify-between"><dt class="text-gray-500">{% trans 'Начало' %}:</dt><dd class="text-gray-700 font-medium">{{ task_instance.start_date|date:"d.m.Y" }}</dd></div>{% endif %}
                    {% if task_instance.due_date %}<div class="flex justify-between"><dt class="text-gray-500 {% if task_instance.is_overdue %}text-red-500{% endif %}">{% trans 'Срок' %}:</dt><dd class="font-medium {% if task_instance.is_overdue %}text-red-600{% else %}text-gray-700{% endif %}">{{ task_instance.due_date|date:"d.m.Y" }}</dd></div>{% endif %}
                    {% if task_instance.completion_date %}<div class="flex justify-between"><dt class="text-gray-500 {% if task_instance.status == task_instance.StatusChoices.COMPLETED %}text-green-600{% endif %}">{% trans 'Завершена' %}:</dt><dd id="task-completion-date" class="font-medium {% if task_instance.status == task_instance.StatusChoices.COMPLETED %}text-green-700{% else %}text-gray-700{% endif %}">{{ task_instance.completion_date|date:"d.m.Y H:i"|default:"-" }}</dd></div>{% endif %}
                    {% if task_instance.estimated_time %}<div class="flex justify-between"><dt class="text-gray-500">{% trans 'Оценка' %}:</dt><dd class="text-gray-700 font-medium">{{ task_instance.estimated_time }}</dd></div>{% endif %}
                    <div class="flex justify-between"><dt class="text-gray-500">{% trans 'Обновлена' %}:</dt><dd class="text-gray-700 font-medium">{{ task_instance.updated_at|date:"d.m.Y H:i" }}</dd></div>
                </dl>
            </div>
        </div>
    </div>

    {% with photos=task_instance.photos.all %}
    {% if photos %}
    <div class="mt-10 border-t border-gray-200 pt-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-images mr-2 text-gray-500" aria-hidden="true"></i>{% trans 'Фотографии' %} ({{ photos.count }})</h3>
        <div id="task-photo-carousel" class="relative w-full max-w-2xl mx-auto" data-carousel="slide">
            <div class="relative overflow-hidden rounded-lg h-64 md:h-96 bg-gray-200 flex items-center justify-center shadow-inner">
                {% for photo in photos %}
                <div class="hidden duration-700 ease-in-out" data-carousel-item {% if forloop.first %}data-active{% endif %}>
                    <img src="{{ photo.photo.url }}" class="block max-w-full max-h-full object-contain mx-auto p-2" alt="{{ photo.description|default:_('Фото к задаче') }}">
                </div>
                {% endfor %}
            </div>
            {% if photos.count > 1 %}
            <div class="absolute z-30 flex space-x-3 -translate-x-1/2 bottom-5 left-1/2">
                {% for photo in photos %}
                <button type="button" class="w-3 h-3 rounded-full bg-gray-400 hover:bg-gray-500 aria-[current=true]:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" aria-current="{% if forloop.first %}true{% else %}false{% endif %}" aria-label="Slide {{ forloop.counter }}" data-carousel-slide-to="{{ forloop.counter0 }}"></button>
                {% endfor %}
            </div>
            <button type="button" class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-prev>
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-black/30 group-hover:bg-black/50 group-focus:ring-4 group-focus:ring-white group-focus:outline-none">
                    <svg class="w-5 h-5 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 1 1 5l4 4" /></svg><span class="sr-only">{% trans "Previous" %}</span>
                </span>
            </button>
            <button type="button" class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none" data-carousel-next>
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-black/30 group-hover:bg-black/50 group-focus:ring-4 group-focus:ring-white group-focus:outline-none">
                    <svg class="w-5 h-5 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4" /></svg><span class="sr-only">{% trans "Next" %}</span>
                </span>
            </button>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="mt-10 border-t border-gray-200 pt-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-images mr-2 text-gray-500" aria-hidden="true"></i>{% trans 'Фотографии' %}</h3>
        <p class="text-gray-500 italic text-sm">{% trans 'Нет прикрепленных фотографий.' %}</p>
    </div>
    {% endif %}
    {% endwith %}

    <div id="comments" class="mt-10 border-t border-gray-200 pt-8">
        <h3 class="text-lg font-semibold text-gray-800 mb-4"><i class="fas fa-comments mr-2 text-gray-500" aria-hidden="true"></i>{% trans 'Комментарии' %} <span id="comment-count" class="text-sm font-normal text-gray-500">({{ task_instance.comments.count }})</span></h3>
        <div id="comment-list" class="space-y-4 max-h-[50vh] overflow-y-auto pr-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent mb-6">
            {% for comment in task_instance.comments.all %}
            <div class="flex space-x-3 comment-item" id="comment-{{ comment.id }}">
                <img class="w-8 h-8 rounded-full object-cover flex-shrink-0 mt-1" src="{% if comment.author.image %}{{ comment.author.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ comment.author.display_name|default:comment.author.username|default:_('Автор') }}">
                <div class="flex-1 bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-semibold text-gray-800">{{ comment.author.display_name|default:comment.author.username|default:_("Удаленный пользователь") }}</span>
                        <span class="text-xs text-gray-400" title="{{ comment.created_at|date:'d.m.Y H:i:s' }}">{{ comment.created_at|timesince }} {% trans "назад" %}</span>
                    </div>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">{{ comment.text }}</p>
                </div>
            </div>
            {% empty %}
            <p id="no-comments-message" class="text-gray-500 italic text-sm text-center py-4">{% trans "Комментариев пока нет." %}</p>
            {% endfor %}
        </div>

        {% if can_add_comment %}
        <form id="comment-form" method="post" action="{% url 'tasks:add_comment_to_task' task_id=task_instance.pk %}">
            {% csrf_token %}
            <div class="flex space-x-3 items-start">
                <img class="w-8 h-8 rounded-full object-cover flex-shrink-0 mt-1" src="{% if request.user.image %}{{ request.user.image.url }}{% else %}{% static 'img/user.svg' %}{% endif %}" alt="{{ request.user.display_name|default:request.user.username }}">
                <div class="flex-1 mt-1">
                    {{ comment_form.text }}
                    <div id="comment-text-errors" class="mt-1 text-sm text-red-600">
                        {% if comment_form.text.errors %}{% for error in comment_form.text.errors %} {{ error }} {% endfor %}{% endif %}
                    </div>

                    <div id="comment-non-field-errors" class="mt-1 text-sm text-red-600">
                        {% if comment_form.non_field_errors %}{% for error in comment_form.non_field_errors %} {{ error }} {% endfor %}{% endif %}
                    </div>
                </div>
            </div>
            <div class="flex justify-end mt-2">
                <button type="submit" class="inline-flex items-center justify-center px-4 py-2 border border-transparent rounded-full shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50">
                    <i class="fas fa-paper-plane mr-2" aria-hidden="true"></i> {% trans 'Отправить' %}
                </button>
            </div>
        </form>
        {% else %}
        <p class="text-gray-500 italic text-sm">{% trans "Вы не можете добавлять комментарии к этой задаче." %}</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
{{ task_detail_json_data|json_script:"task-detail-data" }}
{{ status_choices_json|json_script:"status-choices-data" }}
{% if status_mapping_json %}
    {{ status_mapping_json|json_script:"status-mapping-data" }}
{% else %}
    <script id="status-mapping-data" type="application/json">{}</script>
{% endif %}

<script src="{% static 'js/tasks_no_modal.js' %}" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    if (typeof Flowbite !== 'undefined' && typeof Carousel !== 'undefined') {
        const carouselElement = document.getElementById('task-photo-carousel');
        if (carouselElement) {
            const items = [];
            carouselElement.querySelectorAll('[data-carousel-item]').forEach((el, index) => {
                items.push({ position: index, el: el });
            });
            const indicators = [];
            carouselElement.querySelectorAll('[data-carousel-slide-to]').forEach((el, index) => {
                indicators.push({ position: index, el: el });
            });

            if (items.length > 0) {
                const carousel = new Carousel(carouselElement, items, {
                    defaultPosition: 0,
                    interval: 5000,
                    indicators: {
                        activeClasses: 'bg-gray-900',
                        inactiveClasses: 'bg-gray-400 hover:bg-gray-500',
                        items: indicators.length > 0 ? indicators : null
                    }
                });
                const prevButton = carouselElement.querySelector('[data-carousel-prev]');
                const nextButton = carouselElement.querySelector('[data-carousel-next]');
                if(prevButton) prevButton.addEventListener('click', () => carousel.prev());
                if(nextButton) nextButton.addEventListener('click', () => carousel.next());
            }
        }
    } else { console.warn('Flowbite Carousel not initialized for task_detail.html'); }
});
</script>

<script id="task-list-config" type="application/json">
{
    "initialView": "{{ request.COOKIES.task_view_mode|default:'kanban' }}",
    "updateStatusUrlTemplate": "{% filter escapejs %}{% url 'tasks:ajax_update_task_status' task_id=0 %}{% endfilter %}",
    "deleteTaskUrlTemplate": "{% filter escapejs %}{% url 'tasks:ajax_delete_task' task_id=0 %}{% endfilter %}"
}
</script>
{% endblock %}