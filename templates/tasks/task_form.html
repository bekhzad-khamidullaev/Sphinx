{% extends 'base.html' %}
{% load i18n crispy_forms_tags static app_filters widget_tweaks %} {# Загружаем теги #}

{% block title %}{{ page_title|default:_("Форма задачи") }}{% endblock title %}

{% block head_extra %} {# Стили и медиа формы в head #}
    {{ block.super }}
    {# Select2 CSS #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    {# Опционально: Тема Select2 #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    {# Flatpickr CSS #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    {# Медиа основной формы и формсета #}
    {{ form.media.css }}
    {% if photo_formset %}{{ photo_formset.media.css }}{% endif %}
{% endblock head_extra %}


{% block list_title %}
<div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
        {% if object and object.pk %}
            {% blocktrans with number=object.task_number|default:object.pk %}Редактирование задачи #{{ number }}{% endblocktrans %}
        {% else %}
            {% trans "Создание новой задачи" %}
        {% endif %}
    </h1>
     {# Кнопка "К списку" или "К задаче" #}
    <a href="{% if object and object.pk %}{{ object.get_absolute_url }}{% else %}{% url 'tasks:task_list' %}{% endif %}"
       class="px-4 py-2 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 hover:bg-gray-50 dark:hover:bg-dark-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-dark-800 transition active:scale-95 shadow-sm inline-flex items-center">
       <i class="fas fa-arrow-left mr-2"></i>
       {% if object and object.pk %}{% trans "К задаче" %}{% else %}{% trans "К списку задач" %}{% endif %}
    </a>
</div>
{% endblock list_title %}

{% block list_content %}
{# Контейнер формы #}
<div class="bg-white dark:bg-dark-800 shadow-xl rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8 mt-6">

    {# Общие ошибки формы и формсета #}
    {% include "includes/form_errors.html" with form=form formset=photo_formset %}

    <form method="post" action="" enctype="multipart/form-data" id="task-form" novalidate>
        {% csrf_token %}

        {# Основная форма задачи - используем макет из TaskForm.helper #}
        {% crispy form %}

        {# Разделитель перед фото #}
        <hr class="my-8 border-gray-200 dark:border-dark-600">

        {# --- Формсет Фотографий --- #}
        {% if photo_formset %}
        <fieldset>
            <legend class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
                <i class="fa-regular fa-images mr-2 text-gray-500 dark:text-gray-400"></i>
                {% trans 'Фотографии' %}
            </legend>

            {{ photo_formset.management_form }} {# Обязательно для работы формсета #}

            {# Контейнер для форм фото #}
            <div id="photo-formset-container" class="space-y-6">
                {% for photo_form in photo_formset %}
                    {# Оборачиваем каждую форму фото в свой div #}
                    <div class="photo-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 {% if photo_form.errors %}border-red-500 dark:border-red-700{% endif %}" id="{{ photo_formset.prefix }}-{{ forloop.counter0 }}">

                        {# Скрытые поля для этой формы (ID, ORDER и т.д.) #}
                        {% for hidden_field in photo_form.hidden_fields %}
                            {{ hidden_field }}
                        {% endfor %}

                        {# Используем include для рендеринга полей фото, чтобы не дублировать разметку #}
                        {% include "includes/photo_formset_item.html" with form=photo_form formset=photo_formset %}

                    </div> {# Конец div.photo-form #}
                {% endfor %}
            </div> {# Конец #photo-formset-container #}

            {# Кнопка для добавления новых форм фото через JS #}
            <button type="button" id="add-photo-form" class="mt-4 text-sm text-blue-600 hover:underline">
                <i class="fas fa-plus-circle mr-1"></i> {% trans '+ Добавить еще фото' %}
            </button>
        </fieldset>
        {% endif %} {# Конец if photo_formset #}


        {# --- Кнопки Действий --- #}
        <div class="flex justify-end items-center space-x-3 pt-8 mt-8 border-t border-gray-200 dark:border-dark-600">
            <a href="{% if object and object.pk %}{{ object.get_absolute_url }}{% else %}{% url 'tasks:task_list' %}{% endif %}"
               class="px-5 py-2.5 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 hover:bg-gray-100 dark:hover:bg-dark-600 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-dark-600 transition-colors shadow-sm">
                <i class="fas fa-times mr-2"></i> {% trans 'Отмена' %}
            </a>
            <button type="submit"
                    class="px-5 py-2.5 rounded-lg text-sm font-medium bg-blue-600 dark:bg-ios-blue text-white hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-colors shadow-md inline-flex items-center">
                <i class="fa-solid fa-floppy-disk mr-2 h-4 w-4"></i>
                {{ form_action_label|default:_("Сохранить задачу") }}
            </button>
        </div> {# Конец кнопок #}

    </form> {# Конец основной формы #}
</div> {# Конец контейнера формы #}

{# Шаблон для новой формы фото (скрыт по умолчанию, используется JS) #}
<div id="empty-photo-form" class="hidden">
    {% with photo_form=photo_formset.empty_form %}
    <div class="photo-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50" id="{{ photo_formset.prefix }}-__prefix__">
         {% for hidden_field in photo_form.hidden_fields %}{{ hidden_field }}{% endfor %}
         {% include "includes/photo_formset_item.html" with form=photo_form formset=photo_formset %}
    </div>
    {% endwith %}
</div>

{% endblock list_content %}


{% block scripts %} {# Скрипты в конце body #}
    {{ block.super }}
    {# --- Библиотеки --- #}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/{{ LANGUAGE_CODE|slice:':2'|default:'ru' }}.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr" defer></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ru.js" defer></script>

    {# --- Медиа Формы и Формсета --- #}
    {{ form.media.js }}
    {% if photo_formset %}{{ photo_formset.media.js }}{% endif %}

    {# --- Кастомный JS для инициализации и зависимостей --- #}
    <script src="{% static 'js/task_form.js' %}" defer></script> {# Вынесен в отдельный файл #}

    {# --- JS для динамического добавления/удаления форм фото --- #}
    <script defer>
    document.addEventListener('DOMContentLoaded', function() {
         try {
             const container = document.getElementById('photo-formset-container');
             const addButton = document.getElementById('add-photo-form');
             const emptyFormTemplate = document.getElementById('empty-photo-form');
             const formsetPrefix = '{{ photo_formset.prefix }}'; // e.g., 'photos'
             const totalFormsInput = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
             let formCount = parseInt(totalFormsInput.value, 10);

             if (!container || !addButton || !emptyFormTemplate || !totalFormsInput) {
                 console.warn("Photo formset elements not found, add/delete functionality disabled.");
                 return;
             }

             // Add Form Button
             addButton.addEventListener('click', function() {
                 const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formCount);
                 const newFormElement = document.createElement('div');
                 newFormElement.innerHTML = newFormHtml; // Create element from template string
                 // Add necessary classes to the new form's wrapper
                 newFormElement.firstElementChild.classList.add('space-y-6'); // Match existing form style if needed

                 container.appendChild(newFormElement.firstElementChild); // Append the actual form div
                 formCount++;
                 totalFormsInput.value = formCount; // Update total forms count
             });

             // Delete Form Button (event delegation)
             container.addEventListener('click', function(event) {
                 const deleteButton = event.target.closest('.delete-formset-item');
                 if (deleteButton) {
                     const formToDelete = deleteButton.closest('.photo-form');
                     if (formToDelete) {
                         const deleteCheckbox = formToDelete.querySelector('input[type="checkbox"][name$="-DELETE"]');
                         if (deleteCheckbox) {
                             // Mark for deletion and hide visually
                             deleteCheckbox.checked = true;
                             formToDelete.style.display = 'none';
                             // Optional: Add visual cue like line-through or opacity
                             formToDelete.classList.add('opacity-50', 'border-dashed');
                         } else {
                             // If it's a newly added form (no PK/DELETE checkbox), just remove it
                             formToDelete.remove();
                             // No need to decrement formCount or TOTAL_FORMS for dynamically added empty forms
                             // as they are not counted unless they have data.
                             // However, if you *always* want TOTAL_FORMS to reflect visible forms,
                             // you might need more complex logic. Standard Django formset handles this.
                         }
                     }
                 }
             });
         } catch (error) { console.error("Photo formset add/delete JS error:", error); }
     }); // End DOMContentLoaded
    </script>
{% endblock scripts %}