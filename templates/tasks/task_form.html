{% extends 'base.html' %}
{% load i18n app_filters crispy_forms_tags %}
{% load static %}

{% block title %}{{ page_title|default:_("Форма задачи") }}{% endblock %}

{% block list_title %}
<h1 class="text-2xl font-semibold text-gray-900 dark:text-gray-100 sm:text-3xl">
    {{ page_title }}
</h1>
{% endblock %}

{% block list_content %}
<div class="bg-white dark:bg-dark-800 shadow-xl rounded-xl border border-gray-200 dark:border-dark-700 p-6 md:p-8 mt-6">
    <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}

        {# --- Основная форма задачи (через Crispy Forms) --- #}
        {% crispy form %}
        {# --- Конец основной формы --- #}


        {# Отображение не-полевых ошибок основной формы (если Crispy их не обработал) #}
        {% if form.non_field_errors %}
            <div role="alert" class="mt-4 p-4 border border-red-300 bg-red-50 text-red-700 dark:bg-red-900/30 dark:border-red-700/50 dark:text-red-300 rounded-md">
                <h4 class="font-bold">{% trans "Ошибка формы:" %}</h4>
                {% for error in form.non_field_errors %}
                    <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}

        <hr class="my-6 border-gray-200 dark:border-dark-600">

        {# --- Формсет для фотографий --- #}
        <fieldset>
            <legend class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">
                <i class="fas fa-images mr-2 text-gray-500"></i>{% trans 'Фотографии' %}
            </legend>

            {{ photo_formset.management_form }} {# Обязательно для управления формсетом #}

            <div id="photo-formset-container" class="space-y-4">
                {% for photo_form in photo_formset %}
                    <div class="photo-form p-4 border border-gray-200 dark:border-dark-600 rounded-lg bg-gray-50 dark:bg-dark-700/50 relative transition-all duration-150 ease-in-out {% if photo_form.errors %}border-red-500 dark:border-red-700{% endif %}">
                        {{ photo_form.id }} {# Скрытое поле ID #}

                        <div class="grid grid-cols-1 sm:grid-cols-12 gap-4 items-start">
                             {# Превью и Поле Фото #}
                             <div class="sm:col-span-4">
                                <label for="{{ photo_form.photo.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    {{ photo_form.photo.label }} {% if photo_form.photo.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {% if photo_form.instance.pk and photo_form.instance.photo %}
                                <div class="mb-2 group relative w-24 h-24">
                                    <a href="{{ photo_form.instance.photo.url }}" target="_blank" class="block">
                                        <img src="{{ photo_form.instance.photo.url }}" alt="{% trans 'Current photo' %}" class="w-full h-full object-cover rounded shadow-md">
                                    </a>
                                    {% if photo_formset.can_delete %}
                                    <div class="absolute -top-2 -right-2 bg-white dark:bg-dark-800 rounded-full p-0.5 shadow">
                                        <label for="{{ photo_form.DELETE.id_for_label }}" class="flex items-center text-xs text-red-600 dark:text-red-400 cursor-pointer" title="{% trans 'Отметить для удаления' %}">
                                            {{ photo_form.DELETE|add_css_class:"form-checkbox h-4 w-4 text-red-600 border-gray-300 dark:border-dark-500 rounded-full focus:ring-red-500 bg-white dark:bg-dark-700" }}
                                        </label>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {{ photo_form.photo|add_css_class:"form-control block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-dark-600 dark:border-dark-500 dark:placeholder-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-dark-500 dark:file:text-gray-300 dark:hover:file:bg-dark-400" }}
                                 {% if photo_form.photo.errors %}
                                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                                        {% for error in photo_form.photo.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                             </div>

                             {# Поле Описание #}
                             <div class="sm:col-span-8">
                                <label for="{{ photo_form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                                    {{ photo_form.description.label }} {% if photo_form.description.field.required %}<span class="text-red-500">*</span>{% endif %}
                                </label>
                                {{ photo_form.description|add_css_class:"form-textarea mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 dark:bg-dark-600 dark:border-dark-500 dark:text-gray-200 sm:text-sm"|attr:"rows:3" }}
                                 {% if photo_form.description.errors %}
                                    <div class="mt-1 text-sm text-red-600 dark:text-red-400">
                                        {% for error in photo_form.description.errors %}<p>{{ error }}</p>{% endfor %}
                                    </div>
                                {% endif %}
                             </div>
                        </div> {# End grid #}

                    </div> {# End photo-form #}
            {% endfor %}
        </div> {# End photo-formset-container #}

        {# Сообщение об ошибках формсета #}
        {% if photo_formset.non_form_errors %}
            <div role="alert" class="mt-4 p-3 border border-red-300 bg-red-50 text-red-700 dark:bg-red-900/30 dark:border-red-700/50 dark:text-red-300 rounded-md">
                 <h4 class="font-bold">{% trans "Ошибка фотографий:" %}</h4>
                {% for error in photo_formset.non_form_errors %}
                    <p class="text-sm">{{ error }}</p>
                {% endfor %}
            </div>
        {% endif %}
        </fieldset>
        {# --- Конец формсета фотографий --- #}


        {# --- Кнопки действий --- #}
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 dark:border-dark-600">
            <a href="{% if object %}{{ object.get_absolute_url }}{% else %}{% url 'tasks:task_list' %}{% endif %}" class="px-5 py-2.5 rounded-full text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-700 border border-gray-300 dark:border-dark-600 hover:bg-gray-100 dark:hover:bg-dark-600 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-dark-600 transition-all shadow-sm">
                {% trans 'Отмена' %}
            </a>
            <button type="submit" class="px-5 py-2.5 rounded-full text-sm font-medium bg-blue-600 dark:bg-ios-blue text-white hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-all shadow-md">
                <i class="fas fa-save mr-2"></i> {{ form_action|default:_("Сохранить") }}
            </button>
        </div>
        {# --- Конец кнопок действий --- #}

    </form> {# End form #}
</div> {# End form container #}
{% endblock %}

{% block scripts %}
{# Подключение jQuery и Select2 (если используете) #}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{# Можно использовать тему Select2 для Bootstrap 5, если Bootstrap подключен #}
{# <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" /> #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> {# Обновите jQuery при необходимости #}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // --- Инициализация Select2 ---
        function initSelect2(selector, options = {}) {
            const defaultOptions = {
                theme: "bootstrap-5", // Или ваша тема
                width: '100%',
                allowClear: true, // Позволяет очищать выбор (для необязательных полей)
                // placeholder: $(this).data('placeholder') || '', // Placeholder из data-атрибута
                language: "{{ LANGUAGE_CODE }}" // Используем язык Django для Select2 (нужны файлы локализации Select2)
            };
            try {
                $(selector).select2({...defaultOptions, ...options});
            } catch (e) {
                console.error("Error initializing Select2 for selector:", selector, e);
            }
        }

        initSelect2('.select2-single');
        initSelect2('.select2-multiple', { closeOnSelect: false });

        // --- Динамическая подгрузка подкатегорий ---
        const categorySelect = $('#id_category'); // ID поля категории
        const subcategorySelect = $('#id_subcategory'); // ID поля подкатегории

        if (categorySelect.length && subcategorySelect.length) {
            const initialSubcategoryValue = "{{ form.subcategory.value|default:'' }}"; // Получаем начальное значение из формы Django

            categorySelect.on('change', function() {
                const categoryId = $(this).val();
                // Очищаем и деактивируем Select2 для подкатегорий
                subcategorySelect.val(null).empty().trigger('change').prop('disabled', true);
                subcategorySelect.select2({
                     placeholder: '{% trans "Загрузка..." %}', // Текст во время загрузки
                     language: "{{ LANGUAGE_CODE }}"
                 });

                if (categoryId) {
                    // ЗАМЕНИТЕ '/api/subcategories/' НА ВАШ РЕАЛЬНЫЙ URL API
                    const apiUrl = `/api/subcategories/?category=${categoryId}`; // Пример URL для DRF
                     console.log("Fetching subcategories from:", apiUrl);

                     $.getJSON(apiUrl)
                         .done(function(data) {
                             console.log("Subcategories loaded:", data);
                             // Заполняем Select2 новыми опциями
                             subcategorySelect.select2({
                                 placeholder: '{% trans "Выберите подкатегорию..." %}',
                                 language: "{{ LANGUAGE_CODE }}",
                                 data: $.map(data, function (item) { // Преобразуем данные для Select2
                                      return { id: item.id, text: item.name };
                                 })
                             }).prop('disabled', false);

                             // Восстанавливаем выбранное значение, если оно было и есть в новых опциях
                             if (initialSubcategoryValue && data.some(item => item.id == initialSubcategoryValue)) {
                                 subcategorySelect.val(initialSubcategoryValue).trigger('change');
                             }
                         })
                         .fail(function(jqXHR, textStatus, errorThrown) {
                              console.error("Failed to load subcategories:", textStatus, errorThrown);
                              subcategorySelect.select2({
                                   placeholder: '{% trans "Ошибка загрузки" %}',
                                   language: "{{ LANGUAGE_CODE }}"
                               });
                         });
                } else {
                    // Если категория не выбрана, оставляем Select2 неактивным
                     subcategorySelect.select2({
                          placeholder: '{% trans "Сначала выберите категорию" %}',
                          language: "{{ LANGUAGE_CODE }}"
                     }).prop('disabled', true);
                }
            }).trigger('change'); // Вызываем change при загрузке, чтобы загрузить подкатегории, если категория уже выбрана
        }
    });
</script>
{% endblock %}