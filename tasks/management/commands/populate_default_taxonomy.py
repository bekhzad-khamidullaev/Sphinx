# tasks/management/commands/populate_default_taxonomy.py

import logging
from django.core.management.base import BaseCommand, CommandError
from django.db import IntegrityError, transaction
from django.utils.translation import gettext_lazy as _

# Убедитесь, что путь импорта моделей корректен для вашей структуры проекта
# Если tasks - это приложение в корне проекта, то так:
from tasks.models import TaskCategory, TaskSubcategory
# Если manage.py лежит в корне, а tasks - приложение внутри папки 'apps' или 'src',
# то путь может быть другим, например: from apps.tasks.models import ...

logger = logging.getLogger(__name__)


# --- РАСШИРЕННАЯ И ДЕТАЛИЗИРОВАННАЯ СТРУКТУРА ТАКСОНОМИИ ---
# (Взята из предыдущего ответа, содержит категории и подкатегории с описаниями)
DETAILED_TAXONOMY = [
    # ================== IT Отдел ==================
    {
        "category": {"name": "IT: Инфраструктура и Оборудование", "description": "Задачи, связанные с аппаратным обеспечением, сетями и базовой инфраструктурой"},
        "subcategories": [
            {"name": "Поддержка рабочих мест", "description": "Установка, настройка, ремонт ПК, ноутбуков, мониторов"},
            {"name": "Поддержка оргтехники", "description": "Принтеры, сканеры, МФУ - установка, настройка, расходники, ремонт"},
            {"name": "Сетевое оборудование", "description": "Коммутаторы, маршрутизаторы, Wi-Fi точки доступа - настройка, диагностика"},
            {"name": "Серверное оборудование", "description": "Обслуживание, мониторинг, диагностика физических и виртуальных серверов"},
            {"name": "Системы хранения данных (СХД)", "description": "Обслуживание, мониторинг, расширение дискового пространства"},
            {"name": "Телефония и ВКС", "description": "IP-телефоны, АТС, системы видеоконференцсвязи"},
            {"name": "Кассовое оборудование (POS)", "description": "Поддержка аппаратной части POS-терминалов, фискальных регистраторов"},
            {"name": "Закупка оборудования", "description": "Формирование заявок, выбор поставщиков, приемка нового оборудования"},
        ]
    },
    {
        "category": {"name": "IT: Программное обеспечение и Системы", "description": "Задачи, связанные с ПО, операционными системами и бизнес-приложениями"},
        "subcategories": [
            {"name": "Операционные системы", "description": "Установка, настройка, обновление Windows, Linux, macOS"},
            {"name": "Офисное ПО", "description": "MS Office, Google Workspace, почтовые клиенты - установка, настройка, проблемы"},
            {"name": "Бизнес-приложения (ERP, CRM)", "description": "Поддержка пользователей, настройка, обновление корпоративных систем"},
            {"name": "Специализированное ПО", "description": "Поддержка ПО для кухни, склада, логистики, финансов"},
            {"name": "Базы данных", "description": "Администрирование, резервное копирование, восстановление, оптимизация"},
            {"name": "Виртуализация", "description": "Управление средами VMware, Hyper-V, Proxmox и т.д."},
            {"name": "Лицензирование ПО", "description": "Учет, закупка, продление лицензий"},
            {"name": "Разработка и Тестирование ПО", "description": "Внутренняя разработка, исправление багов, развертывание релизов (если применимо)"},
        ]
    },
     {
        "category": {"name": "IT: Сеть, Доступ и Безопасность", "description": "Задачи, связанные с сетевыми подключениями, правами доступа и информационной безопасностью"},
        "subcategories": [
            {"name": "Доступ в Интернет", "description": "Диагностика и устранение проблем с подключением к Интернету"},
            {"name": "Локальная сеть (LAN/WLAN)", "description": "Проблемы с подключением внутри офиса/филиала, настройка Wi-Fi"},
            {"name": "VPN и удаленный доступ", "description": "Настройка и поддержка VPN-соединений для сотрудников"},
            {"name": "Управление учетными записями", "description": "Создание, блокировка, удаление пользователей, смена паролей"},
            {"name": "Управление правами доступа", "description": "Назначение прав к файлам, папкам, системам"},
            {"name": "Информационная безопасность", "description": "Антивирусная защита, предотвращение утечек, реакция на инциденты"},
            {"name": "Сетевая безопасность", "description": "Настройка и мониторинг фаерволов, систем обнаружения вторжений"},
            {"name": "Резервное копирование и восстановление", "description": "Настройка, мониторинг бэкапов, восстановление данных"},
        ]
    },
    # ================== Кухня (Производство) ==================
    {
        "category": {"name": "Кухня: Оборудование", "description": "Обслуживание и ремонт кухонного оборудования"},
        "subcategories": [
            {"name": "Тепловое оборудование", "description": "Печи, плиты, пароконвектоматы, грили - ТО, ремонт, чистка"},
            {"name": "Холодильное оборудование", "description": "Холодильники, морозильные камеры, льдогенераторы - ТО, ремонт"},
            {"name": "Механическое оборудование", "description": "Миксеры, блендеры, слайсеры, мясорубки - ТО, ремонт, заточка"},
            {"name": "Посудомоечное оборудование", "description": "ТО, ремонт, настройка подачи моющих средств"},
            {"name": "Вентиляция и вытяжки", "description": "Чистка, ТО, ремонт систем вентиляции на кухне"},
            {"name": "Мелкий кухонный инвентарь", "description": "Заказ, замена (ножи, доски, гастроемкости и т.п.)"},
            {"name": "Заявки на ремонт оборудования", "description": "Регистрация и отслеживание заявок в сервис"},
        ]
    },
    {
        "category": {"name": "Кухня: Ингредиенты и Продукты", "description": "Работа с сырьем и продуктами"},
        "subcategories": [
            {"name": "Заказ ингредиентов", "description": "Формирование заявок поставщикам на основе остатков и плана"},
            {"name": "Приемка поставок", "description": "Проверка количества, качества, сроков годности, сопроводительных документов"},
            {"name": "Хранение продуктов", "description": "Контроль условий хранения, ротация запасов (FIFO)"},
            {"name": "Контроль качества сырья", "description": "Проверка входящего сырья, органолептическая оценка"},
            {"name": "Списание продуктов", "description": "Утилизация просроченных или испорченных продуктов, оформление актов"},
            {"name": "Инвентаризация продуктов", "description": "Плановые и внеплановые пересчеты остатков"},
        ]
    },
    {
        "category": {"name": "Кухня: Производственные процессы", "description": "Задачи, связанные непосредственно с приготовлением блюд"},
        "subcategories": [
            {"name": "Приготовление заготовок", "description": "Плановое производство полуфабрикатов"},
            {"name": "Приготовление блюд по заказам", "description": "Выполнение текущих заказов из зала или на доставку"},
            {"name": "Контроль качества готовых блюд", "description": "Проверка соответствия ТТК, веса, внешнего вида"},
            {"name": "Разработка и обновление меню/ТТК", "description": "Создание новых блюд, обновление технологических карт, калькуляция"},
            {"name": "Маркировка продукции", "description": "Нанесение маркировки на заготовки и готовую продукцию"},
        ]
    },
    {
        "category": {"name": "Кухня: Санитария и Гигиена", "description": "Поддержание чистоты и соблюдение санитарных норм"},
        "subcategories": [
            {"name": "Ежедневная уборка", "description": "Уборка рабочих поверхностей, полов, оборудования в течение и после смены"},
            {"name": "Генеральная уборка", "description": "Плановая глубокая чистка всех зон и оборудования"},
            {"name": "Дезинфекция", "description": "Обработка инвентаря, поверхностей дезсредствами"},
            {"name": "Контроль санитарного состояния", "description": "Внутренние проверки, подготовка к проверкам СЭС"},
            {"name": "Управление отходами", "description": "Сортировка, вынос мусора, чистка контейнеров"},
            {"name": "Заказ моющих и дезсредств", "description": "Формирование заявок на закупку химии"},
        ]
    },
    # ================== Операционные процессы (Филиалы) ==================
    {
        "category": {"name": "Филиал: Операционная деятельность", "description": "Ежедневные задачи по функционированию точки продаж"},
        "subcategories": [
            {"name": "Открытие/Закрытие смены", "description": "Чек-листы процедур, передача смены"},
            {"name": "Работа с кассой", "description": "Операции по ККМ, X/Z-отчеты, инкассация, размен"},
            {"name": "Обслуживание гостей", "description": "Прием заказов, консультирование, решение вопросов"},
            {"name": "Работа с системой заказов", "description": "Ввод заказов в POS-систему, контроль выполнения"},
            {"name": "Управление очередью и залом", "description": "Распределение потоков гостей, поддержание порядка"},
            {"name": "Контроль выкладки и витрин", "description": "Оформление витрин, пополнение готовой продукцией"},
            {"name": "Взаимодействие с кухней", "description": "Передача заказов, контроль скорости и качества отдачи"},
        ]
    },
     {
        "category": {"name": "Филиал: Товар и Инвентарь", "description": "Управление товарами и материальными ценностями на точке"},
        "subcategories": [
            {"name": "Заказ товаров/расходников", "description": "Формирование заявок на склад или поставщикам (напитки, упаковка и т.д.)"},
            {"name": "Приемка поставок на филиал", "description": "Проверка количества и качества доставленных товаров"},
            {"name": "Инвентаризация на точке", "description": "Пересчет остатков товаров, напитков, упаковки, хозтоваров"},
            {"name": "Контроль сроков годности", "description": "Проверка товаров на витринах и в подсобных помещениях"},
            {"name": "Списание товаров", "description": "Оформление списания просрочки, боя, порчи"},
        ]
    },
     {
        "category": {"name": "Филиал: Персонал", "description": "Управление линейным персоналом на точке"},
        "subcategories": [
            {"name": "Составление графиков работы", "description": "Планирование смен, учет рабочего времени"},
            {"name": "Распределение задач на смене", "description": "Постановка задач кассирам, работникам зала"},
            {"name": "Контроль выполнения стандартов", "description": "Проверка соблюдения скриптов, внешнего вида, дисциплины"},
            {"name": "Адаптация и обучение новичков", "description": "Наставничество, проведение инструктажей"},
            {"name": "Разрешение конфликтных ситуаций", "description": "Работа с жалобами гостей и внутренними конфликтами"},
        ]
    },
    {
        "category": {"name": "Филиал: Техническое состояние и АХО", "description": "Поддержание работоспособности и порядка на точке"},
        "subcategories": [
            {"name": "Контроль чистоты и порядка", "description": "Организация уборки зала, санузлов, прилегающей территории"},
            {"name": "Мелкий ремонт на точке", "description": "Устранение небольших неисправностей (мебель, сантехника, электрика)"},
            {"name": "Заявки на ремонт оборудования", "description": "Регистрация неисправностей кассового, кухонного (если есть), иного оборудования"},
            {"name": "Контроль работы инженерных систем", "description": "Освещение, отопление, кондиционирование, водоснабжение"},
            {"name": "Заказ хозтоваров для филиала", "description": "Салфетки, туалетная бумага, мыло, мешки для мусора и т.п."},
        ]
    },
    # ================== Доставка ==================
     {
        "category": {"name": "Доставка: Управление курьерами", "description": "Организация работы службы доставки"},
        "subcategories": [
            {"name": "Планирование смен курьеров", "description": "Составление графиков, распределение по зонам"},
            {"name": "Контроль выхода на линию", "description": "Проверка готовности курьеров к работе"},
            {"name": "Назначение заказов курьерам", "description": "Ручное или автоматическое распределение заказов"},
            {"name": "Мониторинг курьеров", "description": "Отслеживание местоположения, статуса выполнения заказов"},
            {"name": "Расчеты с курьерами", "description": "Выдача зарплаты, компенсаций, учет штрафов"},
            {"name": "Подбор и обучение курьеров", "description": "Поиск, адаптация, инструктаж новых сотрудников"},
        ]
    },
     {
        "category": {"name": "Доставка: Обработка заказов", "description": "Процессы от получения заказа до передачи курьеру"},
        "subcategories": [
            {"name": "Прием заказов (сайт/приложение/агрегаторы)", "description": "Подтверждение, проверка данных клиента"},
            {"name": "Передача заказов на кухню/сборку", "description": "Обеспечение своевременной комплектации"},
            {"name": "Комплектация заказов", "description": "Сборка блюд, напитков, приборов, упаковка"},
            {"name": "Контроль качества сборки", "description": "Проверка комплектности и правильности заказа перед отправкой"},
            {"name": "Передача заказов курьерам", "description": "Фиксация времени передачи, выдача сопроводительных документов"},
        ]
    },
     {
        "category": {"name": "Доставка: Клиентский сервис", "description": "Взаимодействие с клиентами по вопросам доставки"},
        "subcategories": [
            {"name": "Информирование клиентов о статусе заказа", "description": "Уведомления, ответы на запросы"},
            {"name": "Обработка жалоб и претензий", "description": "Опоздания, некомплект, качество блюд - решение проблем"},
            {"name": "Работа с отзывами о доставке", "description": "Мониторинг и реакция на отзывы на платформах"},
            {"name": "Корректировка заказов", "description": "Внесение изменений по просьбе клиента (если возможно)"},
        ]
    },
    # ================== Склад и Логистика ==================
    {
        "category": {"name": "Склад: Приемка и Хранение", "description": "Операции по приему и размещению товаров на складе"},
        "subcategories": [
            {"name": "Приемка товаров от поставщиков", "description": "Разгрузка, проверка документов, количества, качества"},
            {"name": "Размещение товаров на складе", "description": "Определение мест хранения, маркировка, внесение в систему"},
            {"name": "Организация адресного хранения", "description": "Внедрение и поддержка системы ячеистого хранения"},
            {"name": "Контроль условий хранения", "description": "Температурный режим, влажность, товарное соседство"},
            {"name": "Работа с возвратами от филиалов/клиентов", "description": "Приемка, обработка, утилизация или возврат поставщику"},
        ]
    },
    {
        "category": {"name": "Склад: Комплектация и Отгрузка", "description": "Сборка заказов и отправка на филиалы или клиентам"},
        "subcategories": [
            {"name": "Обработка заявок от филиалов/клиентов", "description": "Получение, проверка, планирование сборки"},
            {"name": "Комплектация заказов (Picking)", "description": "Сбор товаров по накладным или заданиям WMS"},
            {"name": "Упаковка и маркировка", "description": "Подготовка собранных заказов к отгрузке"},
            {"name": "Отгрузка товаров", "description": "Погрузка в транспорт, оформление отгрузочных документов"},
            {"name": "Планирование маршрутов доставки", "description": "Оптимизация логистики (если склад сам развозит)"},
        ]
    },
     {
        "category": {"name": "Склад: Учет и Инвентаризация", "description": "Контроль остатков и проведение инвентаризаций"},
        "subcategories": [
            {"name": "Ведение складского учета", "description": "Отражение всех операций в учетной системе (WMS/ERP)"},
            {"name": "Проведение плановых инвентаризаций", "description": "Полный пересчет остатков на складе"},
            {"name": "Проведение выборочных инвентаризаций", "description": "Циклический пересчет по отдельным группам товаров"},
            {"name": "Обработка результатов инвентаризации", "description": "Выявление расхождений, оформление актов (излишки, недостачи)"},
            {"name": "Анализ оборачиваемости запасов", "description": "Выявление неликвидов, оптимизация уровня запасов"},
        ]
    },
    # ================== Финансы и Казначейство ==================
    {
        "category": {"name": "Финансы: Учет и Отчетность", "description": "Бухгалтерский, налоговый, управленческий учет и отчетность"},
        "subcategories": [
            {"name": "Бухгалтерский учет", "description": "Ведение участков БУ (банк, касса, расчеты, ОС, ТМЦ и т.д.)"},
            {"name": "Налоговый учет", "description": "Расчет налогов, подготовка и сдача налоговой отчетности"},
            {"name": "Управленческий учет", "description": "Сбор данных, подготовка P&L, Balance Sheet, Cash Flow для руководства"},
            {"name": "Статистическая отчетность", "description": "Подготовка и сдача отчетов в органы статистики"},
            {"name": "Закрытие периода", "description": "Процедуры по закрытию месяца, квартала, года"},
            {"name": "Архивирование документов", "description": "Организация хранения бухгалтерских и финансовых документов"},
        ]
    },
     {
        "category": {"name": "Финансы: Расчеты и Платежи", "description": "Управление денежными потоками и расчетами"},
        "subcategories": [
            {"name": "Расчеты с поставщиками", "description": "Обработка счетов, формирование реестров платежей, проведение оплат"},
            {"name": "Расчеты с покупателями/клиентами", "description": "Выставление счетов, контроль поступления оплат, акты сверок"},
            {"name": "Кассовые операции", "description": "Ведение кассовой книги, лимит кассы, операции с наличными"},
            {"name": "Банковские операции", "description": "Работа с банк-клиентом, выписки, платежные поручения"},
            {"name": "Валютный контроль", "description": "Операции с иностранной валютой (если применимо)"},
            {"name": "Управление дебиторской/кредиторской задолженностью", "description": "Контроль, анализ, работа по снижению"},
        ]
    },
     {
        "category": {"name": "Финансы: Казначейство и Планирование", "description": "Управление ликвидностью, бюджетирование и финансовый анализ"},
        "subcategories": [
            {"name": "Планирование денежных потоков", "description": "Составление и контроль платежного календаря"},
            {"name": "Бюджетирование", "description": "Разработка, согласование, контроль исполнения бюджетов (БДР, БДДС)"},
            {"name": "Финансовый анализ", "description": "Анализ рентабельности, ликвидности, структуры затрат, план-факт анализ"},
            {"name": "Привлечение финансирования", "description": "Работа с банками по кредитам, лизингу (если применимо)"},
            {"name": "Управление финансовыми рисками", "description": "Оценка и минимизация валютных, кредитных, процентных рисков"},
        ]
    },
    # ================== Кадровые процессы (HR) ==================
    {
        "category": {"name": "HR: Подбор и Адаптация", "description": "Привлечение, отбор и ввод в должность новых сотрудников"},
        "subcategories": [
            {"name": "Размещение вакансий", "description": "Публикация на работных сайтах, в соцсетях"},
            {"name": "Отбор резюме", "description": "Первичный скрининг кандидатов"},
            {"name": "Проведение собеседований", "description": "Телефонные интервью, очные встречи, тестирование"},
            {"name": "Проверка рекомендаций", "description": "Сбор обратной связи с предыдущих мест работы"},
            {"name": "Формирование предложения о работе (Job Offer)", "description": "Подготовка и согласование условий"},
            {"name": "Процесс адаптации (Onboarding)", "description": "Welcome-тренинги, назначение наставников, контроль прохождения исп. срока"},
        ]
    },
    {
        "category": {"name": "HR: Кадровое делопроизводство (КДП)", "description": "Документационное оформление трудовых отношений"},
        "subcategories": [
            {"name": "Оформление приема на работу", "description": "Трудовые договоры, приказы, личные карточки"},
            {"name": "Оформление переводов, перемещений", "description": "Дополнительные соглашения, приказы"},
            {"name": "Оформление отпусков", "description": "График отпусков, заявления, приказы"},
            {"name": "Оформление больничных листов", "description": "Прием, проверка, передача в бухгалтерию"},
            {"name": "Оформление командировок", "description": "Приказы, командировочные удостоверения, авансовые отчеты"},
            {"name": "Ведение табеля учета рабочего времени", "description": "Сбор данных, проверка, передача для расчета ЗП"},
            {"name": "Оформление увольнения", "description": "Заявления, приказы, расчет при увольнении, выдача документов"},
            {"name": "Ведение воинского учета", "description": "(Если требуется по законодательству)"},
            {"name": "Архивирование кадровых документов", "description": ""},
        ]
    },
    {
        "category": {"name": "HR: Расчет заработной платы", "description": "Начисление и выплата заработной платы и других вознаграждений"},
        "subcategories": [
            {"name": "Расчет окладов, премий, бонусов", "description": "Начисление согласно системам оплаты труда"},
            {"name": "Расчет отпускных, больничных", "description": ""},
            {"name": "Расчет налогов и взносов с ФОТ", "description": "НДФЛ, социальные взносы"},
            {"name": "Подготовка платежных ведомостей", "description": "Формирование документов на выплату"},
            {"name": "Выплата заработной платы", "description": "Перечисление на карты, выдача наличными"},
            {"name": "Подготовка расчетных листков", "description": ""},
            {"name": "Подготовка справок о доходах", "description": "2-НДФЛ и другие справки по запросу сотрудников"},
        ]
    },
     {
        "category": {"name": "HR: Обучение и Развитие", "description": "Повышение квалификации и развитие компетенций персонала"},
        "subcategories": [
            {"name": "Организация внутреннего обучения", "description": "Тренинги по продукту, стандартам, продажам"},
            {"name": "Организация внешнего обучения", "description": "Направление на курсы, семинары, конференции"},
            {"name": "Разработка учебных материалов", "description": "Инструкции, методички, презентации"},
            {"name": "Оценка эффективности обучения", "description": "Тестирование, сбор обратной связи"},
            {"name": "Формирование кадрового резерва", "description": "Выявление и развитие потенциальных руководителей"},
            {"name": "Аттестация персонала", "description": "Плановая оценка знаний и навыков"},
        ]
    },
    {
        "category": {"name": "HR: Мотивация и Корп. культура", "description": "Работа с вовлеченностью, лояльностью и внутренними коммуникациями"},
        "subcategories": [
            {"name": "Разработка систем мотивации", "description": "Материальная (KPI, бонусы) и нематериальная"},
            {"name": "Проведение оценки персонала (Performance Review)", "description": "Регулярная оценка результативности"},
            {"name": "Исследования вовлеченности и удовлетворенности", "description": "Опросы, анализ результатов"},
            {"name": "Организация корпоративных мероприятий", "description": "Праздники, тимбилдинги"},
            {"name": "Развитие внутренних коммуникаций", "description": "Информационные рассылки, портал, собрания"},
            {"name": "Работа с конфликтами и жалобами сотрудников", "description": ""},
        ]
    },
    # ================== Маркетинг ==================
    {
        "category": {"name": "Маркетинг: Продвижение и Реклама", "description": "Привлечение клиентов и повышение узнаваемости бренда"},
        "subcategories": [
            {"name": "Контекстная реклама (PPC)", "description": "Яндекс.Директ, Google Ads - настройка, ведение, анализ"},
            {"name": "Таргетированная реклама", "description": "Реклама в социальных сетях (Facebook, Instagram, VK и т.д.)"},
            {"name": "SEO (Поисковая оптимизация)", "description": "Продвижение сайта в поисковых системах"},
            {"name": "SMM (Маркетинг в соцсетях)", "description": "Ведение аккаунтов, создание контента, взаимодействие с подписчиками"},
            {"name": "Email-маркетинг", "description": "Рассылки, сегментация базы, автоматизация"},
            {"name": "Наружная реклама", "description": "Баннеры, вывески, реклама на транспорте"},
            {"name": "Реклама в СМИ", "description": "Радио, ТВ, печатные издания"},
            {"name": "Партнерский маркетинг", "description": "Работа с партнерами, блогерами, программы лояльности"},
            {"name": "Организация промо-акций и мероприятий", "description": "Разработка механики, запуск, контроль"},
        ]
    },
    {
        "category": {"name": "Маркетинг: Контент и Бренд", "description": "Создание контента, управление брендом и репутацией"},
        "subcategories": [
            {"name": "Разработка контент-плана", "description": "Планирование публикаций для сайта, блога, соцсетей"},
            {"name": "Создание текстового контента", "description": "Статьи, новости, описания, посты"},
            {"name": "Создание визуального контента", "description": "Фотографии, видео, инфографика, дизайн материалов"},
            {"name": "Управление веб-сайтом", "description": "Обновление информации, добавление страниц, контроль работоспособности"},
            {"name": "Бренд-менеджмент", "description": "Контроль использования фирменного стиля, развитие бренд-платформы"},
            {"name": "Управление репутацией (ORM)", "description": "Мониторинг отзывов, работа с негативом"},
            {"name": "PR (Связи с общественностью)", "description": "Пресс-релизы, работа со СМИ, комментарии"},
        ]
    },
    {
        "category": {"name": "Маркетинг: Аналитика и Исследования", "description": "Сбор и анализ данных для принятия маркетинговых решений"},
        "subcategories": [
            {"name": "Веб-аналитика", "description": "Google Analytics, Яндекс.Метрика - настройка, анализ трафика и конверсий"},
            {"name": "Анализ эффективности рекламных кампаний", "description": "ROI, CPA, LTV и другие метрики"},
            {"name": "Исследование рынка и конкурентов", "description": "Анализ трендов, цен, активностей конкурентов"},
            {"name": "Исследование целевой аудитории", "description": "Сегментация, опросы, анализ потребностей"},
            {"name": "Анализ продаж", "description": "Динамика, структура продаж, эффективность акций"},
            {"name": "Подготовка маркетинговых отчетов", "description": "Регулярная отчетность по ключевым показателям"},
        ]
    },
    # ================== Административно-Хозяйственный Отдел (АХО) ==================
    {
        "category": {"name": "АХО: Обеспечение Офиса/Филиалов", "description": "Поддержание жизнедеятельности и снабжение офисов и точек"},
        "subcategories": [
            {"name": "Заказ канцелярии и хозтоваров", "description": "Бумага, ручки, моющие средства, инвентарь"},
            {"name": "Заказ воды, кофе, чая", "description": "Обеспечение кухонных зон в офисе"},
            {"name": "Организация уборки помещений", "description": "Контроль клининговой службы или штатных уборщиков"},
            {"name": "Организация вывоза мусора", "description": ""},
            {"name": "Мелкий ремонт офисной мебели", "description": ""},
            {"name": "Организация переездов и перестановок", "description": "Планирование, координация грузчиков, сборка/разборка мебели"},
            {"name": "Управление служебным транспортом", "description": "Обслуживание, ГСМ, страховки (если есть)"},
        ]
    },
     {
        "category": {"name": "АХО: Эксплуатация Зданий и Сооружений", "description": "Поддержание инженерных систем и конструкций"},
        "subcategories": [
            {"name": "Обслуживание систем электроснабжения", "description": "Плановые проверки, замена ламп, мелкий ремонт"},
            {"name": "Обслуживание систем водоснабжения и канализации", "description": "Сантехнические работы, прочистка засоров"},
            {"name": "Обслуживание систем отопления", "description": "Подготовка к сезону, контроль работы, ремонт"},
            {"name": "Обслуживание систем вентиляции и кондиционирования", "description": "Чистка фильтров, ТО, ремонт"},
            {"name": "Текущий ремонт помещений", "description": "Покраска, штукатурка, замена плитки и т.п."},
            {"name": "Взаимодействие с арендодателями", "description": "Решение вопросов по аренде, эксплуатации"},
            {"name": "Благоустройство территории", "description": "Уборка, озеленение (если применимо)"},
        ]
    },
    # ================== Юридический отдел и Комплаенс ==================
     {
        "category": {"name": "Юристы: Договорная работа", "description": "Разработка, согласование и сопровождение договоров"},
        "subcategories": [
            {"name": "Разработка типовых форм договоров", "description": ""},
            {"name": "Правовая экспертиза договоров", "description": "Анализ рисков, проверка соответствия законодательству"},
            {"name": "Согласование договоров с контрагентами", "description": "Участие в переговорах, протоколы разногласий"},
            {"name": "Сопровождение заключения договоров", "description": "Контроль подписания, регистрации"},
            {"name": "Ведение реестра договоров", "description": "Учет и хранение договорной документации"},
        ]
    },
     {
        "category": {"name": "Юристы: Претензионно-исковая работа", "description": "Разрешение споров и представление интересов в суде"},
        "subcategories": [
            {"name": "Подготовка претензий", "description": "Формирование требований к контрагентам"},
            {"name": "Ответы на входящие претензии", "description": ""},
            {"name": "Подготовка исковых заявлений", "description": "Обращение в суд"},
            {"name": "Представление интересов в судах", "description": "Участие в заседаниях"},
            {"name": "Сопровождение исполнительного производства", "description": "Работа с судебными приставами"},
        ]
    },
    {
        "category": {"name": "Юристы: Корпоративное право и Комплаенс", "description": "Обеспечение соответствия деятельности компании законодательству"},
        "subcategories": [
            {"name": "Регистрация/ликвидация юр. лиц/филиалов", "description": ""},
            {"name": "Внесение изменений в учредительные документы", "description": ""},
            {"name": "Подготовка внутренних нормативных документов", "description": "Положения, регламенты, инструкции"},
            {"name": "Консультирование по правовым вопросам", "description": "Поддержка других отделов"},
            {"name": "Мониторинг изменений законодательства", "description": ""},
            {"name": "Получение лицензий и разрешений", "description": ""},
            {"name": "Комплаенс-контроль", "description": "Проверка соблюдения норм (антикоррупция, персональные данные и т.д.)"},
        ]
    },
    # ================== Управление и Стратегия ==================
    {
        "category": {"name": "Управление: Стратегия и Планирование", "description": "Задачи высшего руководства по развитию компании"},
        "subcategories": [
            {"name": "Разработка/корректировка стратегии", "description": ""},
            {"name": "Постановка целей (квартал/год)", "description": "Формулирование OKR/KPI для компании и отделов"},
            {"name": "Утверждение бюджетов", "description": ""},
            {"name": "Запуск новых проектов/направлений", "description": ""},
            {"name": "Анализ рынка и конкурентной среды", "description": "Высокоуровневый анализ для принятия стратегических решений"},
        ]
    },
     {
        "category": {"name": "Управление: Контроль и Анализ", "description": "Мониторинг деятельности и оценка результатов"},
        "subcategories": [
            {"name": "Контроль выполнения KPI/OKR", "description": "Регулярный обзор результатов отделов и компании"},
            {"name": "Анализ финансово-хозяйственной деятельности", "description": "Оценка ключевых показателей"},
            {"name": "Проведение стратегических сессий/совещаний", "description": ""},
            {"name": "Взаимодействие с инвесторами/акционерами", "description": "(Если применимо)"},
        ]
    },
    # ================== Общие/Прочее ==================
    {
        "category": {"name": "Общие задачи", "description": "Задачи, не относящиеся к конкретному отделу или требующие межфункционального взаимодействия"},
        "subcategories": [
            {"name": "Межфункциональные проекты", "description": "Задачи, требующие участия нескольких отделов"},
            {"name": "Внутренние коммуникации", "description": "Общие объявления, организация собраний"},
            {"name": "Не классифицированные задачи", "description": "Для задач, которые сложно отнести к другим категориям"},
        ]
    },
]
# -------------------------------------------------------------------


class Command(BaseCommand):
    help = _('Заполняет или обновляет базу данных стандартным набором категорий и подкатегорий задач. '
             'Использует предопределенную структуру. Команда идемпотентна по именам. '
             'Добавляет новые записи, пропускает существующие по имени. '
             'Может обновлять описания существующих записей с опцией --update-descriptions.')

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help=_('Выполнить команду без сохранения изменений в базу данных (покажет, что будет сделано).')
        )
        parser.add_argument(
            '--update-descriptions',
            action='store_true',
            help=_('Обновить описания для существующих категорий/подкатегорий, если они отличаются от структуры в коде.')
        )

    @transaction.atomic # Гарантирует, что все операции выполнятся успешно или ни одна не выполнится
    def handle(self, *args, **options):
        is_dry_run = options['dry_run']
        update_descriptions = options['update_descriptions']

        # Словари для подсчета статистики
        counts = {'category': {'created': 0, 'skipped': 0, 'updated': 0},
                  'subcategory': {'created': 0, 'skipped': 0, 'updated': 0}}

        if is_dry_run:
            self.stdout.write(self.style.WARNING("--- РЕЖИМ ПРОБНОГО ЗАПУСКА (Dry Run) ---"))
            self.stdout.write(self.style.WARNING("--- Изменения НЕ будут сохранены в БД ---"))

        # Создаем savepoint, чтобы можно было откатить транзакцию в dry-run режиме
        # или в случае ошибки в реальном режиме
        sid = transaction.savepoint()

        self.stdout.write("Начинаем обработку таксономии...")
        self.stdout.write("-" * 30)

        # Итерируемся по основной структуре
        for item in DETAILED_TAXONOMY:
            cat_data = item['category']
            cat_name = cat_data['name']
            # Используем .get() для безопасного получения описания, если его вдруг нет
            cat_desc = cat_data.get('description', '')

            self.stdout.write(f"\nОбработка категории: '{cat_name}'")

            try:
                # --- Работа с Категорией ---
                # Пытаемся найти категорию по имени или создать новую
                category_obj, cat_created = TaskCategory.objects.get_or_create(
                    name=cat_name,
                    # defaults используется только при создании новой записи
                    defaults={'description': cat_desc}
                )

                if cat_created:
                    counts['category']['created'] += 1
                    self.stdout.write(self.style.SUCCESS(f"  [+] Категория СОЗДАНА."))
                    # Логируем создание только при реальном запуске
                    if not is_dry_run:
                        logger.info(f"Created category: {cat_name}")
                else:
                    counts['category']['skipped'] += 1
                    self.stdout.write(f"  [*] Категория СУЩЕСТВУЕТ.")
                    # --- Обновление описания Категории (если нужно) ---
                    if update_descriptions and category_obj.description != cat_desc:
                        # Обновляем только если включена опция и описание реально отличается
                        if not is_dry_run:
                            # В реальном режиме - обновляем и сохраняем
                            category_obj.description = cat_desc
                            category_obj.save(update_fields=['description']) # Оптимизация: обновляем только одно поле
                            counts['category']['updated'] += 1
                            self.stdout.write(self.style.SUCCESS(f"      [!] Описание ОБНОВЛЕНО."))
                            logger.info(f"Updated description for category: {cat_name}")
                        else:
                            # В dry-run просто сообщаем, что было бы обновлено
                             counts['category']['updated'] += 1 # Считаем для статистики dry-run
                             self.stdout.write(self.style.WARNING(f"      [!] Описание БУДЕТ обновлено (dry-run)."))
                    elif update_descriptions:
                        # Если опция включена, но описания совпадают
                         self.stdout.write(f"      [=] Описание совпадает, обновление не требуется.")

                # --- Работа с Подкатегориями ---
                # Итерируемся по списку подкатегорий для текущей категории
                for sub_data in item.get('subcategories', []): # Используем .get с default=[] для безопасности
                    sub_name = sub_data['name']
                    sub_desc = sub_data.get('description', '')

                    self.stdout.write(f"    - Подкатегория: '{sub_name}'")

                    # Пытаемся найти подкатегорию по имени И СВЯЗИ С РОДИТЕЛЬСКОЙ КАТЕГОРИЕЙ
                    # или создать новую
                    subcategory_obj, sub_created = TaskSubcategory.objects.get_or_create(
                        category=category_obj, # Важно: ищем/создаем в контексте текущей категории
                        name=sub_name,
                        # defaults используется только при создании
                        defaults={'description': sub_desc}
                    )

                    if sub_created:
                        counts['subcategory']['created'] += 1
                        self.stdout.write(self.style.SUCCESS(f"      [+] Подкатегория СОЗДАНА."))
                        if not is_dry_run:
                            logger.info(f"Created subcategory: '{sub_name}' under '{cat_name}'")
                    else:
                        counts['subcategory']['skipped'] += 1
                        self.stdout.write(f"      [*] Подкатегория СУЩЕСТВУЕТ.")
                        # --- Обновление описания Подкатегории (если нужно) ---
                        if update_descriptions and subcategory_obj.description != sub_desc:
                            if not is_dry_run:
                                subcategory_obj.description = sub_desc
                                subcategory_obj.save(update_fields=['description'])
                                counts['subcategory']['updated'] += 1
                                self.stdout.write(self.style.SUCCESS(f"          [!] Описание ОБНОВЛЕНО."))
                                logger.info(f"Updated description for subcategory: '{sub_name}' under '{cat_name}'")
                            else:
                                counts['subcategory']['updated'] += 1
                                self.stdout.write(self.style.WARNING(f"          [!] Описание БУДЕТ обновлено (dry-run)."))
                        elif update_descriptions:
                            self.stdout.write(f"          [=] Описание совпадает, обновление не требуется.")

            # Обработка возможных ошибок на уровне категории/подкатегорий
            except IntegrityError as e:
                # Может случиться при race condition или нарушении других constraints
                error_msg = f"Ошибка целостности БД при обработке категории '{cat_name}' или ее подкатегорий: {e}"
                self.stderr.write(self.style.ERROR(error_msg))
                logger.error(error_msg)
                # Откатываем транзакцию при ошибке
                if not is_dry_run:
                    transaction.savepoint_rollback(sid)
                raise CommandError("Произошла ошибка целостности базы данных. Операция прервана.")
            except Exception as e:
                # Ловим другие неожиданные ошибки
                error_msg = f"Неожиданная ошибка при обработке категории '{cat_name}' или ее подкатегорий: {e}"
                self.stderr.write(self.style.ERROR(error_msg))
                logger.exception(error_msg) # Логируем с полным traceback
                # Откатываем транзакцию
                if not is_dry_run:
                    transaction.savepoint_rollback(sid)
                raise CommandError(f"Произошла неожиданная ошибка. Операция прервана. {e}")

        # --- Завершение команды ---
        self.stdout.write("\n" + "-" * 30)
        if is_dry_run:
            # В режиме dry-run откатываем транзакцию, т.к. мы ничего не хотели сохранять
            self.stdout.write(self.style.WARNING("--- Пробный запуск завершен. Откат изменений (если были бы). ---"))
            transaction.savepoint_rollback(sid)
        else:
            # В реальном режиме сохраняем все изменения, сделанные внутри транзакции
            self.stdout.write(self.style.SUCCESS("--- Сохранение изменений в базу данных... ---"))
            transaction.savepoint_commit(sid)
            self.stdout.write(self.style.SUCCESS("--- Изменения успешно сохранены. ---"))

        # --- Вывод итоговой статистики ---
        self.stdout.write("\n--- Итоги выполнения ---")
        self.stdout.write(f"Категории:")
        self.stdout.write(f"  Создано: {counts['category']['created']}")
        self.stdout.write(f"  Пропущено (существуют): {counts['category']['skipped']}")
        # Показываем обновленные только если опция была включена или в dry-run
        if update_descriptions or is_dry_run:
             self.stdout.write(f"  Обновлено описаний: {counts['category']['updated']}")

        self.stdout.write(f"Подкатегории:")
        self.stdout.write(f"  Создано: {counts['subcategory']['created']}")
        self.stdout.write(f"  Пропущено (существуют): {counts['subcategory']['skipped']}")
        if update_descriptions or is_dry_run:
             self.stdout.write(f"  Обновлено описаний: {counts['subcategory']['updated']}")

        self.stdout.write(self.style.SUCCESS("\nКоманда успешно завершена."))